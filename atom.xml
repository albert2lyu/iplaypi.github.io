<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>虾丸派</title>
  
  <subtitle>烂笔头</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.playpi.org/"/>
  <updated>2019-04-24T14:50:17.000Z</updated>
  <id>https://www.playpi.org/</id>
  
  <author>
    <name>虾丸派</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>mapreduce 错误之 bin bash-line 0-fg-no job control</title>
    <link href="https://www.playpi.org/2019042401.html"/>
    <id>https://www.playpi.org/2019042401.html</id>
    <published>2019-04-24T14:50:17.000Z</published>
    <updated>2019-04-24T14:50:17.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>今天在开发 mapreduce 程序的过程中，为了快速开发，程序的整体框架是从别的业务复制过来的，自己增加一些数据处理逻辑以及环境的参数配置。接着就遇到问题，在本地本机测试的时候，Job 作业无法启动，总是抛出异常，然后进程退出。本机系统为 Windows 7 X64。</p><p>异常错误信息简略如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exit code: 1</span><br><span class="line">Exception message: /bin/bash: line 0: fg: no job control</span><br></pre></td></tr></table></figure><p>本文记录这个现象以及解决方案。</p><a id="more"></a><h1 id="问题出现"><a href="# 问题出现" class="headerlink" title="问题出现"></a>问题出现 </h1><p> 在本地本机启动 Job 时无法正常运行作业，直接抛出异常后退出进程，完整错误信息如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Diagnostics: Exception from container-launch.</span><br><span class="line">Container id: container_e18_1550055564059_0152_02_000001</span><br><span class="line">Exit code: 1</span><br><span class="line">Exception message: /bin/bash: line 0: fg: no job control</span><br><span class="line"></span><br><span class="line">Stack trace: ExitCodeException exitCode=1: /bin/bash: line 0: fg: no job control</span><br><span class="line"></span><br><span class="line">at org.apache.hadoop.util.Shell.runCommand (Shell.java:576)</span><br><span class="line">at org.apache.hadoop.util.Shell.run (Shell.java:487)</span><br><span class="line">at org.apache.hadoop.util.Shell$ShellCommandExecutor.execute (Shell.java:753)</span><br><span class="line">at org.apache.hadoop.yarn.server.nodemanager.DefaultContainerExecutor.launchContainer (DefaultContainerExecutor.java:212)</span><br><span class="line">at org.apache.hadoop.yarn.server.nodemanager.containermanager.launcher.ContainerLaunch.call (ContainerLaunch.java:303)</span><br><span class="line">at org.apache.hadoop.yarn.server.nodemanager.containermanager.launcher.ContainerLaunch.call (ContainerLaunch.java:82)</span><br><span class="line">at java.util.concurrent.FutureTask.run (FutureTask.java:266)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker (ThreadPoolExecutor.java:1149)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run (ThreadPoolExecutor.java:624)</span><br><span class="line">at java.lang.Thread.run (Thread.java:748)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Container exited with a non-zero exit code 1</span><br><span class="line">Failing this attempt. Failing the application.</span><br><span class="line">2019-04-22_22:46:04 [main] INFO mapreduce.Job:1385: Counters: 0</span><br></pre></td></tr></table></figure><p>其中的重点在于：<strong>Exception message: /bin/bash: line 0: fg: no job control</strong>，由于我不了解这种错误，只能靠搜索引擎解决了。</p><h1 id="问题解决"><a href="# 问题解决" class="headerlink" title="问题解决"></a>问题解决 </h1><p> 问题解决很容易，在 Job 的配置中增加一项：mapreduce.app-submission.cross-platform，取值为 true，截取代码片段如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Configuration conf = job.getConfiguration ();</span><br><span class="line">conf.set (&quot;mapreduce.job.running.map.limit&quot;, &quot;50&quot;);</span><br><span class="line">// 本机环境测试加上配置，否则会抛出异常退出：ExitCodeException: /bin/bash: line 0: fg: no job control</span><br><span class="line">conf.set (&quot;mapreduce.app-submission.cross-platform&quot;, &quot;true&quot;);</span><br></pre></td></tr></table></figure><p>这个配置的含义就是跨平台，保障 Job 作业可以在 Windows 平台顺利运行。</p><h1 id="备注"><a href="# 备注" class="headerlink" title="备注"></a>备注 </h1><p> 参考：<a href="https://stackoverflow.com/questions/24075669/mapreduce-job-fail-when-submitted-from-windows-machine" target="_blank" rel="noopener">stackoverflow 讨论一例</a> 。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;今天在开发 mapreduce 程序的过程中，为了快速开发，程序的整体框架是从别的业务复制过来的，自己增加一些数据处理逻辑以及环境的参数配置。接着就遇到问题，在本地本机测试的时候，Job 作业无法启动，总是抛出异常，然后进程退出。本机系统为 Windows 7 X64。&lt;/p&gt;&lt;p&gt;异常错误信息简略如下：&lt;/p&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Exit code: 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Exception message: /bin/bash: line 0: fg: no job control&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;本文记录这个现象以及解决方案。&lt;/p&gt;
    
    </summary>
    
      <category term="踩坑系列" scheme="https://www.playpi.org/categories/series-of-fixbug/"/>
    
    
      <category term="mapreduce" scheme="https://www.playpi.org/tags/mapreduce/"/>
    
  </entry>
  
  <entry>
    <title>关于  httpcore 的 Maven 依赖冲突问题解决</title>
    <link href="https://www.playpi.org/2019042201.html"/>
    <id>https://www.playpi.org/2019042201.html</id>
    <published>2019-04-22T12:17:45.000Z</published>
    <updated>2019-04-22T12:17:45.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>今天，又遇到一个 Maven 冲突的问题，这种问题我遇到的多了，每次都是因为项目依赖管理混乱或者为新功能增加依赖之后影响了旧功能，这次就是因为后者，新增加的依赖的传递依赖覆盖了原有的依赖，导致了问题的产生。大家如果搜索我的博客，搜索关键词 maven 或者 mvn，应该可以看到好几篇类似的文章，每次的情况都略有不同，每次解决问题的过程也是很崩溃。不过，每次崩溃之后都是一阵喜悦，毕竟感觉自己的经验又扩充了一些，以后遇到此类问题可以迅速解决。</p><a id="more"></a><h1 id="问题出现"><a href="# 问题出现" class="headerlink" title="问题出现"></a>问题出现 </h1><p> 写了一个 mapReduce 程序从 HBase 读取数据，写入到 Elasticsearch 中，整体的框架是从别的项目复制过来的，自己重写了处理逻辑以及环境相关的参数，但是跑起来的时候，map 过程很顺利，几百个 task 全部成功完成，但是 reduce 过程直接挂了，几十个 task 全部失败，重试了还是失败。</p><p>我只能去查看日志，去 Hadoop 监控界面，看到对应任务的报错日志如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">2019-04-22 16:01:30,469 ERROR [main] com.datastory.banyan.spark.ScanFlushESMRV2$FlushESReducer: org/apache/http/message/TokenParser</span><br><span class="line">java.lang.NoClassDefFoundError: org/apache/http/message/TokenParser</span><br><span class="line">at org.apache.http.client.utils.URLEncodedUtils.parse (URLEncodedUtils.java:280)</span><br><span class="line">at org.apache.http.client.utils.URLEncodedUtils.parse (URLEncodedUtils.java:237)</span><br><span class="line">at org.apache.http.client.utils.URIBuilder.parseQuery (URIBuilder.java:111)</span><br><span class="line">at org.apache.http.client.utils.URIBuilder.digestURI (URIBuilder.java:181)</span><br><span class="line">at org.apache.http.client.utils.URIBuilder.&lt;init&gt;(URIBuilder.java:91)</span><br><span class="line">at org.apache.http.client.utils.URIUtils.rewriteURI (URIUtils.java:185)</span><br><span class="line">at org.apache.http.impl.nio.client.MainClientExec.rewriteRequestURI (MainClientExec.java:494)</span><br><span class="line">at org.apache.http.impl.nio.client.MainClientExec.prepareRequest (MainClientExec.java:529)</span><br><span class="line">at org.apache.http.impl.nio.client.MainClientExec.prepare (MainClientExec.java:156)</span><br><span class="line">at org.apache.http.impl.nio.client.DefaultClientExchangeHandlerImpl.start (DefaultClientExchangeHandlerImpl.java:125)</span><br><span class="line">at org.apache.http.impl.nio.client.InternalHttpAsyncClient.execute (InternalHttpAsyncClient.java:129)</span><br><span class="line">at org.elasticsearch.client.RestClient.performRequestAsync (RestClient.java:343)</span><br><span class="line">at org.elasticsearch.client.RestClient.performRequestAsync (RestClient.java:325)</span><br><span class="line">at org.elasticsearch.client.RestClient.performRequestAsync (RestClient.java:268)</span><br><span class="line">at org.elasticsearch.client.RestHighLevelClient.performRequestAsync (RestHighLevelClient.java:445)</span><br><span class="line">at org.elasticsearch.client.RestHighLevelClient.performRequestAsyncAndParseEntity (RestHighLevelClient.java:423)</span><br><span class="line">at org.elasticsearch.client.RestHighLevelClient.bulkAsync (RestHighLevelClient.java:206)</span><br><span class="line">at com.datastory.banyan.client.es.ESBulkProcessor.lambda$new$0 (ESBulkProcessor.java:154)</span><br><span class="line">at org.elasticsearch.action.bulk.Retry$RetryHandler.execute (Retry.java:230)</span><br><span class="line">at org.elasticsearch.action.bulk.Retry.withAsyncBackoff (Retry.java:87)</span><br><span class="line">at org.elasticsearch.action.bulk.BulkRequestHandler$AsyncBulkRequestHandler.execute (BulkRequestHandler.java:138)</span><br><span class="line">at org.elasticsearch.action.bulk.BulkProcessor.execute (BulkProcessor.java:350)</span><br><span class="line">at org.elasticsearch.action.bulk.BulkProcessor.executeIfNeeded (BulkProcessor.java:341)</span><br><span class="line">at org.elasticsearch.action.bulk.BulkProcessor.internalAdd (BulkProcessor.java:276)</span><br><span class="line">at org.elasticsearch.action.bulk.BulkProcessor.add (BulkProcessor.java:259)</span><br><span class="line">at org.elasticsearch.action.bulk.BulkProcessor.add (BulkProcessor.java:255)</span><br><span class="line">at org.elasticsearch.action.bulk.BulkProcessor.add (BulkProcessor.java:241)</span><br><span class="line">at com.datastory.banyan.client.es.ESBulkProcessor.addIndexRequest (ESBulkProcessor.java:237)</span><br><span class="line">at com.datastory.banyan.spark.ScanFlushESMRV2$FlushESReducer.reduce (ScanFlushESMRV2.java:212)</span><br><span class="line">at com.datastory.banyan.spark.ScanFlushESMRV2$FlushESReducer.reduce (ScanFlushESMRV2.java:158)</span><br><span class="line">at org.apache.hadoop.mapreduce.Reducer.run (Reducer.java:171)</span><br><span class="line">at org.apache.hadoop.mapred.ReduceTask.runNewReducer (ReduceTask.java:627)</span><br><span class="line">at org.apache.hadoop.mapred.ReduceTask.run (ReduceTask.java:389)</span><br><span class="line">at org.apache.hadoop.mapred.YarnChild$2.run (YarnChild.java:168)</span><br><span class="line">at java.security.AccessController.doPrivileged (Native Method)</span><br><span class="line">at javax.security.auth.Subject.doAs (Subject.java:422)</span><br><span class="line">at org.apache.hadoop.security.UserGroupInformation.doAs (UserGroupInformation.java:1709)</span><br><span class="line">at org.apache.hadoop.mapred.YarnChild.main (YarnChild.java:162)</span><br></pre></td></tr></table></figure><p>截图如下：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g2brjd9bl2j210d0j9q4k.jpg" alt="异常日志信息" title="异常日志信息"></p><p>看到关键部分：<strong>java.lang.NoClassDefFoundError: org/apache/http/message/TokenParser</strong>，表面看是类未定义，但是真实情况是什么还要继续探索，例如依赖缺失、依赖冲突导致的类不匹配等。</p><h1 id="问题解决"><a href="# 问题解决" class="headerlink" title="问题解决"></a>问题解决 </h1><h2 id="初步分析"><a href="# 初步分析" class="headerlink" title="初步分析"></a> 初步分析 </h2><p> 先搜索类 <strong>TokenParser</strong> 吧，看看能不能搜索到，在 IDEA 中搜索，我的环境是使用 <strong>ctrl + shift + t</strong> 快捷键，搜索之后发现存在这个类，记住对应的 jar 包坐标以及版本：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.httpcomponents:httpcore:jar:4.3.2</span><br></pre></td></tr></table></figure><p>这里需要注意一点，如果你的项目是由多个子项目聚合而成的，此时使用 IDEA 的搜索功能并不准确，会搜索出来其它子项目的同名依赖，从而误导你的视线，所以还是使用依赖分析插件比较好，例如：depedency，下面也会讲到。</p><p>既然类已经存在，说明有极大可能是依赖冲突导致的 <strong>NoClassDefFoundError</strong>。继续从错误日志中寻找蛛丝马迹，看到 <strong>at org.apache.http.client.utils.URLEncodedUtils.parse (URLEncodedUtils.java:280)</strong> 这里，接着搜索类 <strong>URLEncodedUtils</strong> 并查看第 280 行的 <strong>parse</strong> 方法。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.httpcomponents:httpclient:jar:4.5.2</span><br></pre></td></tr></table></figure><p>上面是依赖坐标以及版本，看到这里有经验的工程师已经可以发现问题所在了：两个同类型的依赖 jar 包版本差别太大，这里暂且不分析。</p><p>接着查看源码：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g2brkjzrvrj20v50djt9j.jpg" alt="URLEncodedUtils 源码" title="URLEncodedUtils 源码"></p><p>好，到这里已经把基本情况分析清楚了，程序异常里面的 <strong>NoClassDefFoundError</strong> 并不是类缺失，所以没有报错 <strong>ClassNotFound</strong>。根本原因是类版本不对，导致 <strong>URLEncodedUtils</strong> 找不到自己需要的特定版本的类，尽管有一个同名的低版本的类存在，但是对于 Java 虚拟机来说这是完全不同的两个类，这也是容易误导人的地方。</p><p>再延伸一下话题，如果真的是类不存在，使用 IDEA 查看源码时会显示红色字体提示的，如图：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g2brle6hgjj20zc0ieq49.jpg" alt="类不存在错误提示" title="类不存在错误提示"></p><h2 id="详细分析"><a href="# 详细分析" class="headerlink" title="详细分析"></a>详细分析 </h2><p> 接下来就使用依赖分析插件 <strong>dependency</strong> 来分析这两个 jar 包的来源以及版本差异，在项目的根目录执行 <strong>mvn dependency:tree -Dverbose &gt; tree.txt</strong> ，把依赖树信息重定向到 tree.txt 文件中，里面的 -Dverbose 参数可以使我们更为清晰地看到版本冲突的 jar 包以及实际使用的 jar 包。</p><p>找到 httpclient 和 httpcore 的来源，依赖树片段截取如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[INFO] +- com.company.commons3:ds-commons3-es-rest:jar:1.2:compile</span><br><span class="line">[INFO] |  +- org.apache.httpcomponents:httpclient:jar:4.5.2:compile</span><br><span class="line"></span><br><span class="line">...... 省略 </span><br><span class="line"></span><br><span class="line">[INFO] |  +- org.apache.httpcomponents:httpasyncclient:jar:4.0.2:compile</span><br><span class="line">[INFO] |  |  +- org.apache.httpcomponents:httpcore:jar:4.3.2:compile</span><br><span class="line">[INFO] |  |  +- (org.apache.httpcomponents:httpcore-nio:jar:4.3.2:compile - omitted for duplicate)</span><br><span class="line">[INFO] |  |  +- (org.apache.httpcomponents:httpclient:jar:4.3.5:compile - omitted for conflict with 4.5.2)</span><br><span class="line">[INFO] |  |  \- (commons-logging:commons-logging:jar:1.1.3:compile - omitted for duplicate)</span><br></pre></td></tr></table></figure><p>可以看到 <strong>httpclient</strong> 来自于 <strong>ds-commons3-es-rest</strong>，版本为 4.5.2，而 <strong>httpcore</strong> 来自于 <strong>httpasyncclient</strong>，版本为 4.3.2。</p><p>特别注意：<strong>httpasyncclient</strong> 里面还有一个 4.3.5 版本的 <strong>httpclient</strong> 由于版本冲突被忽略了，这也是导致问题的元凶。</p><p>依赖树片段截图如下：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g2brlwy34ij210404e74q.jpg" alt="依赖树片段 1" title="依赖树片段 1"></p><p><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g2brm3rutxj211508h0tr.jpg" alt="依赖树片段 2" title="依赖树片段 2"></p><p>到这里已经可以知道问题所在了，<strong>httpclient</strong>、<strong>httpcore</strong> 这两个依赖的版本差距太大，前者 4.5.2，后者 4.3.2，导致前者的类 URLEncodedUtils 在调用后者的类 TokenParser 时，找不到满足条件的版本，于是抛出异常：NoClassDefFoundError。</p><h2 id="解决方案"><a href="# 解决方案" class="headerlink" title="解决方案"></a>解决方案 </h2><p> 那这个问题也是很容易解决的，指定版本接近的两个依赖即可，但是还是要根据实际情况而来。本来最简单的方案就是移除所有相关依赖，然后在 pom.xml 中显式地指定这两个依赖的版本。但是这么做太简单粗暴了，因为这两个依赖不是一级依赖，而是传递依赖，不必手动管理。所以要适当地移除某一些传递依赖，保留另一些传递依赖，让它们不要交叉出现。</p><p>我的做法就是移除 <strong>ds-commons3-es-rest</strong> 里面的传递依赖，保持 <strong>httpasyncclient</strong> 里面的传递依赖，这样它们的版本号接近，而且是同一个依赖里面传递的，基本不可能出错。</p><p>pom.xml 配置如图：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g2brnorbdej211p0amaaq.jpg" alt="修复后的 pom 配置" title="修复后的 pom 配置"></p><p>httpclient 的小版本号是可以比 httpcore 高一点的，继续查看依赖树，可以看到 httpclient 的版本为 4.3.5，httpcore 的版本为 4.3.2。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g2brntqakfj20rp021aa1.jpg" alt="修复后的 http 依赖版本号" title="修复后的 http 依赖版本号"></p><h2 id="引申插件"><a href="# 引申插件" class="headerlink" title="引申插件"></a>引申插件 </h2><p> 除了 dependency 插件外，还有另外一个插件也非常好用：enforcer，插件的坐标如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 帮助分析依赖冲突的插件，可以在编译时期找到依赖问题 --&gt;</span><br><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-enforcer-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4.1&lt;/version&gt;</span><br><span class="line">    &lt;executions&gt;</span><br><span class="line">        &lt;execution&gt;</span><br><span class="line">            &lt;id&gt;enforce-ban-duplicate-classes&lt;/id&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">                &lt;goal&gt;enforce&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;!-- 设置规则，否则没法检查 --&gt;</span><br><span class="line">                &lt;rules&gt;</span><br><span class="line">                    &lt;!-- 检查重复类 --&gt;</span><br><span class="line">                    &lt;banDuplicateClasses&gt;</span><br><span class="line">                        &lt;!-- 忽略一些类 --&gt;</span><br><span class="line">                        &lt;ignoreClasses&gt;</span><br><span class="line">                            &lt;ignoreClass&gt;javax.*&lt;/ignoreClass&gt;</span><br><span class="line">                            &lt;ignoreClass&gt;org.junit.*&lt;/ignoreClass&gt;</span><br><span class="line">                            &lt;ingoreClass&gt;org.aspectj.*&lt;/ingoreClass&gt;</span><br><span class="line">                            &lt;ingoreClass&gt;org.jboss.netty.*&lt;/ingoreClass&gt;</span><br><span class="line">                            &lt;ingoreClass&gt;org.apache.juli.*&lt;/ingoreClass&gt;</span><br><span class="line">                            &lt;ingoreClass&gt;org.apache.commons.logging.*&lt;/ingoreClass&gt;</span><br><span class="line">                            &lt;ingoreClass&gt;org.apache.log4j.*&lt;/ingoreClass&gt;</span><br><span class="line">                            &lt;ingoreClass&gt;org.objectweb.asm.*&lt;/ingoreClass&gt;</span><br><span class="line">                            &lt;ingoreClass&gt;org.parboiled.*&lt;/ingoreClass&gt;</span><br><span class="line">                            &lt;ingoreClass&gt;org.apache.xmlbeans.xml.stream.*&lt;/ingoreClass&gt;</span><br><span class="line">                            &lt;ingoreClass&gt;org.json.JSONString&lt;/ingoreClass&gt;</span><br><span class="line">                        &lt;/ignoreClasses&gt;</span><br><span class="line">                        &lt;!-- 除了上面忽略的类，检查所有的类 --&gt;</span><br><span class="line">                        &lt;findAllDuplicates&gt;true&lt;/findAllDuplicates&gt;</span><br><span class="line">                    &lt;/banDuplicateClasses&gt;</span><br><span class="line">                    &lt;!-- JDK 在 1.8 以上 --&gt;</span><br><span class="line">                    &lt;requireJavaVersion&gt;</span><br><span class="line">                        &lt;version&gt;1.8.0&lt;/version&gt;</span><br><span class="line">                    &lt;/requireJavaVersion&gt;</span><br><span class="line">                    &lt;!-- Maven 在 3.0.5 以上 --&gt;</span><br><span class="line">                    &lt;requireMavenVersion&gt;</span><br><span class="line">                        &lt;version&gt;3.0.5&lt;/version&gt;</span><br><span class="line">                    &lt;/requireMavenVersion&gt;</span><br><span class="line">                &lt;/rules&gt;</span><br><span class="line">                &lt;fail&gt;true&lt;/fail&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">        &lt;/execution&gt;</span><br><span class="line">    &lt;/executions&gt;</span><br><span class="line">    &lt;!-- 官方的默认规则 --&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;extra-enforcer-rules&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0-beta-6&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure><p>这个插件需要配置在 pom.xml 中，并且绑定 Maven 的生命周期，默认是绑定在 compile 上面，然后需要给 enforcer 配置一些规则，例如检查重复的类。接着在编译期间，enforcer 插件就会检验项目的依赖中所有的类【可以设置忽略容器中的类，例如作用域为 provided 的依赖包】，如果有重复的类，就会报错，编译不会通过。</p><p>注意，这个插件除了可以检查依赖、类的冲突【通过设置规则 rule 来实现】，还可以设置一些其它的开发规范，例如规定 JDK 版本、开发系统环境必须为 Windows、使用的 Maven 版本等等。此外，官方也提供了一些规则列表可以参考：<a href="http://maven.apache.org/enforcer/enforcer-rules/index.html" target="_blank" rel="noopener">http://maven.apache.org/enforcer/enforcer-rules/index.html</a> ，而且还有 API 允许我们自定义规则，非常灵活。</p><h1 id="问题总结"><a href="# 问题总结" class="headerlink" title="问题总结"></a>问题总结 </h1><h2 id="抽象总结"><a href="# 抽象总结" class="headerlink" title="抽象总结"></a> 抽象总结 </h2><p> 总结一下现象，其实就是项目本来依赖了 B 包，B 包里面有传递依赖包 1、包 2，由于包 1、包 2 都来自于 B 包，所以版本差别不大，很适配。包 1 的类调用包 2 的类很顺利，不会有问题。</p><p>后来由于其它功能需要，项目又加入了 A 包，此时没有注意到 A 包里面也有包 1，而且比 B 包里面的包 1 版本高，这本来不是问题，只是潜在风险。但是，编译打包时 A 包里面的包 1 把 B 包里面的包 1 覆盖了，包 2 仍旧是来自于 B 包，这就出问题了，风险变成灾难了。当程序运行时包 1 需要调用包 2，由于版本差别过大，找不到符合条件的类了，抛出异常：NoClassDefFoundError。</p><p>这里面的验证机制浅显地描述就是每个类都会有自己的序列化编号，如果有严格要求同版本依赖的类，调用方法时会严格验证。</p><h2 id="关于编译的疑问"><a href="# 关于编译的疑问" class="headerlink" title="关于编译的疑问"></a>关于编译的疑问 </h2><p> 到这里，读者会有疑问，为什么编译不报错，能顺利通过呢？其实从上面就能看到答案了，这种依赖包之间相互引用的类，类是存在的，只是版本不一致而已，编译时并不能检测出来。如果是你自己写的类源码，引用了别的依赖包的类，同时对版本要求严格的话，编译是一定会报错的。</p><p>但是，如果你提前知道了是哪个类，一般不可能知道，只有报错了才会知道，而且会有不止一个类，这也是令人头疼的地方。</p><p>如果进一步分析异常信息，发现它归属于 ERROR，并不是运行时异常，更不用谈编译时异常了，这种错误和 OutOfMemoryError 类似，是虚拟机运行时出现问题，比较严重。</p><h2 id="感悟"><a href="# 感悟" class="headerlink" title="感悟"></a>感悟 </h2><p> 找到这种问题的原因是没有什么难度的，一眼就可以看出来是依赖冲突。但是解决过程可谓是难度极大，而且可以让人崩溃，对于初学者来说可以放弃了，折腾三天可能都不会有结果的。特别在依赖庞大的情况下，几百个依赖包，几百 M 大小，这时候找起来特别麻烦，有时候改动了一点会影响到其它的依赖，引起连锁反应，可能问题还没解决，又引发了其它问题。</p><p>所以，在项目开发的初始阶段，一定要管理好项目的依赖，并且在依赖变更时要一起讨论，否则后患无穷。</p><p>此外，在解决依赖冲突的过程中，有 2 个插件工具很好用：dependency、enforcer。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;今天，又遇到一个 Maven 冲突的问题，这种问题我遇到的多了，每次都是因为项目依赖管理混乱或者为新功能增加依赖之后影响了旧功能，这次就是因为后者，新增加的依赖的传递依赖覆盖了原有的依赖，导致了问题的产生。大家如果搜索我的博客，搜索关键词 maven 或者 mvn，应该可以看到好几篇类似的文章，每次的情况都略有不同，每次解决问题的过程也是很崩溃。不过，每次崩溃之后都是一阵喜悦，毕竟感觉自己的经验又扩充了一些，以后遇到此类问题可以迅速解决。&lt;/p&gt;
    
    </summary>
    
      <category term="踩坑系列" scheme="https://www.playpi.org/categories/series-of-fixbug/"/>
    
    
      <category term="httpcore" scheme="https://www.playpi.org/tags/httpcore/"/>
    
      <category term="maven" scheme="https://www.playpi.org/tags/maven/"/>
    
      <category term="dependency" scheme="https://www.playpi.org/tags/dependency/"/>
    
      <category term="enforcer" scheme="https://www.playpi.org/tags/enforcer/"/>
    
  </entry>
  
  <entry>
    <title>Linux 之 kill 命令入门实践</title>
    <link href="https://www.playpi.org/2019042101.html"/>
    <id>https://www.playpi.org/2019042101.html</id>
    <published>2019-04-21T14:35:27.000Z</published>
    <updated>2019-04-21T14:35:27.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>kill 命令只是用来向进程发送信号的，而不是直接杀死进程的。</p><a id="more"></a><h1 id="基础知识"><a href="# 基础知识" class="headerlink" title="基础知识"></a>基础知识 </h1><h1 id="操作实践"><a href="# 操作实践" class="headerlink" title="操作实践"></a> 操作实践 </h1><h1 id="备注"><a href="# 备注" class="headerlink" title="备注"></a> 备注</h1><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;kill 命令只是用来向进程发送信号的，而不是直接杀死进程的。&lt;/p&gt;
    
    </summary>
    
      <category term="Linux 命令系列" scheme="https://www.playpi.org/categories/series-of-linux-cmd/"/>
    
    
      <category term="Linux" scheme="https://www.playpi.org/tags/Linux/"/>
    
      <category term="kill" scheme="https://www.playpi.org/tags/kill/"/>
    
      <category term="jobs" scheme="https://www.playpi.org/tags/jobs/"/>
    
  </entry>
  
  <entry>
    <title>JNI 字段描述符基础知识</title>
    <link href="https://www.playpi.org/2019041301.html"/>
    <id>https://www.playpi.org/2019041301.html</id>
    <published>2019-04-13T09:12:45.000Z</published>
    <updated>2019-04-14T09:12:45.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>平时在做 Java 开发的时候，难免遇到异常信息中包含一种特殊的表达字符串，例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method: createWorker signature: (Ljava/util/concurrent/Executor;) Lorg/jboss/netty/channel/socket/nio/AbstractNioWorker;</span><br></pre></td></tr></table></figure><p>或者 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NoSuchMethodError: com.fasterxml.jackson.databind.JavaType.isReferenceType () Z</span><br></pre></td></tr></table></figure><p> 可以看到，异常信息中有一种特殊的字符串出现了：<strong>L 后面跟着类名 </strong>、<strong> 方法后面跟了一个 Z</strong>。其实，这就是 <strong>JNI 字段描述符【Java Native Interface FieldDescriptors】</strong>，它是一种对 Java 数据类型、数组、方法的编码。此外，在 Android 逆向分析中，通过反汇编得到的 smali 文件，里面的代码也会遵循这种方式，即 Dalvik 字节码。本文就记录一些数据类型、数组、方法的编码方式以及解释说明，方便以后查阅。</p><a id="more"></a><h1 id="基本概念"><a href="# 基本概念" class="headerlink" title="基本概念"></a>基本概念 </h1><p> 这种编码方式把 Java 中的基本数据类型、数组、对象都使用一种规范来表示：</p><ul><li>八种基本数据类型都使用一个大写字母表示 </li><li>void 使用 V 表示</li><li> 数组使用左方括号表示 </li><li> 方法使用一组圆括号表示，参数在括号里，返回类型在括号右侧 </li><li> 对象使用 L 开头，分号结束，中间是类的完整路径，包名使用正斜杠分隔 </li></ul><h1 id="基本编码"><a href="# 基本编码" class="headerlink" title="基本编码"></a> 基本编码 </h1><p> 基本编码如下表格，并配有解释说明：</p><table><thead><tr><th style="text-align:center">Java 类型 </th><th style="text-align:center">JNI 字段描述符</th></tr></thead><tbody><tr><td style="text-align:center">boolean</td><td style="text-align:center">Z</td></tr><tr><td style="text-align:center">byte</td><td style="text-align:center">B</td></tr><tr><td style="text-align:center">char</td><td style="text-align:center">C</td></tr><tr><td style="text-align:center">short</td><td style="text-align:center">S</td></tr><tr><td style="text-align:center">int</td><td style="text-align:center">I</td></tr><tr><td style="text-align:center">long</td><td style="text-align:center">J</td></tr><tr><td style="text-align:center">float</td><td style="text-align:center">F</td></tr><tr><td style="text-align:center">double</td><td style="text-align:center">D</td></tr><tr><td style="text-align:center">void</td><td style="text-align:center">V</td></tr><tr><td style="text-align:center">Object</td><td style="text-align:center"> 以 L 开头，以；结尾，中间是使用 / 隔开的完整包名、类型。例如：Ljava/lang/String;。如果是内部类，添加 $ 符号分隔，例如：Landroid/os/FileUtils$FileStatus;。</td></tr><tr><td style="text-align:center">数组 </td><td style="text-align:center">[</td></tr><tr><td style="text-align:center"> 方法 </td><td style="text-align:center"> 使用 () 表示，参数在圆括号里，返回类型在圆括号右侧，例如：(II) Z，表示 boolean func (int i,int j)。</td></tr></tbody></table><h1 id="举例说明"><a href="# 举例说明" class="headerlink" title="举例说明"></a>举例说明 </h1><h2 id="数据类型"><a href="# 数据类型" class="headerlink" title="数据类型"></a> 数据类型 </h2><p>1、<strong>[I</strong>：表示 int 一维数组，即 <strong>int []</strong>。<br>2、<strong>Ljava/lang/String;</strong>：表示 String 类型，即 <strong>java.lang.String</strong>。<br>3、<strong>[Ljava/lang/Object;</strong>：表示 Object 一维数组，即 <strong>java.lang.Object []</strong>。<br>4、<strong>Z</strong>：表示 boolean 类型。<br>5、<strong>V</strong>：表示 void 类型。</p><h2 id="方法"><a href="# 方法" class="headerlink" title="方法"></a> 方法</h2><p>1、<strong>() V</strong>：表示参数列表为空，返回类型为 void 的方法，即 <strong>void func ()</strong>。<br>2、<strong>(II) V</strong>：表示参数列表为 int、int，返回类型为 void 的方法，即 <strong>void func (int i,int j)</strong>。<br>3、<strong>(Ljava/lang/String;Ljava/lang/String;) I</strong>：表示参数列表为 String、String，返回类型为 int 的方法，即 <strong>int func (String i,String j)</strong>。<br>4、<strong>([B) V</strong>：表示参数列表为 byte []，返回类型为 void 的方法，即 <strong>void func (byte [] bytes)</strong>。<br>5、<strong>(ILjava/lang/Class;) J</strong>：表示参数列表为 int、Class，返回类型为 long 的方法，即 <strong>long func (int i,Class c)</strong>。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;平时在做 Java 开发的时候，难免遇到异常信息中包含一种特殊的表达字符串，例如：&lt;/p&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;method: createWorker signature: (Ljava/util/concurrent/Executor;) Lorg/jboss/netty/channel/socket/nio/AbstractNioWorker;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;或者&lt;/p&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;java.lang.NoSuchMethodError: com.fasterxml.jackson.databind.JavaType.isReferenceType () Z&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;可以看到，异常信息中有一种特殊的字符串出现了：&lt;strong&gt;L 后面跟着类名 &lt;/strong&gt;、&lt;strong&gt; 方法后面跟了一个 Z&lt;/strong&gt;。其实，这就是 &lt;strong&gt;JNI 字段描述符【Java Native Interface FieldDescriptors】&lt;/strong&gt;，它是一种对 Java 数据类型、数组、方法的编码。此外，在 Android 逆向分析中，通过反汇编得到的 smali 文件，里面的代码也会遵循这种方式，即 Dalvik 字节码。本文就记录一些数据类型、数组、方法的编码方式以及解释说明，方便以后查阅。&lt;/p&gt;
    
    </summary>
    
      <category term="基础技术知识" scheme="https://www.playpi.org/categories/basic-technical-knowledge/"/>
    
    
      <category term="JNI" scheme="https://www.playpi.org/tags/JNI/"/>
    
      <category term="字段描述符" scheme="https://www.playpi.org/tags/%E5%AD%97%E6%AE%B5%E6%8F%8F%E8%BF%B0%E7%AC%A6/"/>
    
  </entry>
  
  <entry>
    <title>预估 Mysql 数据表的数据大小和索引大小</title>
    <link href="https://www.playpi.org/2019041001.html"/>
    <id>https://www.playpi.org/2019041001.html</id>
    <published>2019-04-10T08:27:18.000Z</published>
    <updated>2019-04-13T08:27:18.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>最近接到一个小的新需求，需求很容易实现，就是定时把一些分析得出的指标从 Elasticsearch 中离线存储到 Mysql 数据库中，方便以后查询。离线存储的原因是因为资源不足，Elasticsearch 会自动删除 15 天以前的原始数据，而且 Elasticsearch 每天都会新产生数十万到数百万的数据，依据这些原始数据只会产生几十条分析结果，显然离线存储到 Mysql 中更为合理。在处理这个需求时，接着就遇到了一个小问题，当前业务组没有数据库资源，需要申请，而且由于资源不足，不能随便申请，要给出合理的预估值。这样，就涉及到数据库占用空间大小的预估了，本文记录一种简单的方法。</p><a id="more"></a><h1 id="数据大小和索引大小预估"><a href="# 数据大小和索引大小预估" class="headerlink" title="数据大小和索引大小预估"></a>数据大小和索引大小预估 </h1><p> 我当前使用的是 Mysql 数据库，其它数据库产品查询方式可能会有所不同，请根据实际情况操作。</p><p>在数据库中，使用系统数据库的表 <strong>TABLES</strong> 进行查询：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT data_length,index_length</span><br><span class="line">FROM information_schema.TABLES t</span><br><span class="line">WHERE table_schema=&apos;your_db_name&apos;</span><br><span class="line">AND table_name = &apos;your_table_name&apos;;</span><br></pre></td></tr></table></figure><p>其中，系统数据库是 <strong>information_schema</strong>，存储表信息的表是 <strong>TABLES</strong>，<strong>data_length</strong>、<strong>index_length</strong> 这 2 个字段表示数据大小、索引大小，单位是字节 B。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g228n8cy91j20cd06gq2x.jpg" alt="SQL 查询数据空间大小" title="SQL 查询数据空间大小"></p><p>当然，如果使用可视化的数据库连接管理工具，也可以通过管理工具直接鼠标点击查看，其实背后的逻辑仍旧是查询 <strong>TABLES</strong> 表，例如我通过 <strong>Navicat</strong> 工具查看。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g228nw2hx5j20er0c1t8y.jpg" alt="Navicat 查看表信息" title="Navicat 查看表信息"></p><p>可见，无论使用哪种方式，都可以把需要的信息查询出来，然后就可以预估数据大小了。我截图的信息显示，数据大小 <strong>8.5MB</strong>，索引大小 <strong>0MB</strong>，还要结合数据条数，我查了一下有 10000 条数据，因此可以粗略估计每条数据的大小为 <strong>0.85KB</strong>。这里需要注意一下，预估数据大小之前要保证数据的字段取值接近真实情况，最好能有数据示例可以参考，而且数据量要尽量大一些，例如几万条，不能只有几十条、几百条。</p><p>如果确实没有数据示例参考，需要自己模拟生成，尽量把字段的取值多生成一些实际中可能出现的值。例如字符串类型如果是 <strong>vachar</strong>，要把每种长度的取值都生成一些，或者根据实际场景，某些长度的字符串出现的可能性大一点，那就多生成一些。</p><p>如果觉得这样计算比较麻烦的话，其实还有一种更简单的方法，直接查询 <strong>avg_row_length</strong> 字段，这个字段表示数据表的平均行大小，和上面自己计算的结果类似。</p><p>总之，就是为了接近真实，才能更为准确地预估出数据占用的空间大小，实际去申请资源时才能有理有据。</p><p>此外，这个 <strong>TABLES</strong> 表里面的内容很丰富的，有需要的可以查询一下，查看数据表的字段信息 SQL 语句：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW COLUMNS FROM TABLES;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;最近接到一个小的新需求，需求很容易实现，就是定时把一些分析得出的指标从 Elasticsearch 中离线存储到 Mysql 数据库中，方便以后查询。离线存储的原因是因为资源不足，Elasticsearch 会自动删除 15 天以前的原始数据，而且 Elasticsearch 每天都会新产生数十万到数百万的数据，依据这些原始数据只会产生几十条分析结果，显然离线存储到 Mysql 中更为合理。在处理这个需求时，接着就遇到了一个小问题，当前业务组没有数据库资源，需要申请，而且由于资源不足，不能随便申请，要给出合理的预估值。这样，就涉及到数据库占用空间大小的预估了，本文记录一种简单的方法。&lt;/p&gt;
    
    </summary>
    
      <category term="基础技术知识" scheme="https://www.playpi.org/categories/basic-technical-knowledge/"/>
    
    
      <category term="Mysql" scheme="https://www.playpi.org/tags/Mysql/"/>
    
      <category term="数据库" scheme="https://www.playpi.org/tags/database-chn/"/>
    
      <category term="database" scheme="https://www.playpi.org/tags/database/"/>
    
      <category term="space" scheme="https://www.playpi.org/tags/space/"/>
    
  </entry>
  
  <entry>
    <title>使用 JDK 命令行工具分析内存泄漏或内存溢出问题</title>
    <link href="https://www.playpi.org/2019040301.html"/>
    <id>https://www.playpi.org/2019040301.html</id>
    <published>2019-04-03T10:14:23.000Z</published>
    <updated>2019-04-20T10:14:23.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>最近遇到一个棘手的问题，有业务方在调用存储系统封装的 SDK 取数的过程中，遇到了 OOM 问题，但是数据量很小，只有 12000 条。同时进程启动时申请的内存高达 12g，使用 Xmx、Xms 参数控制，实际指定参数取值为：-Xms12g -Xmx12g。但是如果只看报错日志信息，抛出异常的代码位置指向了 SDK 的内部代码。根据这个现象，我猜测可能是业务方的处理逻辑问题、SDK 内部处理逻辑问题、申请的内存过小问题，这些问题归根结底，要么是内存不够【内存溢出】，要么是内存不当使用【内存泄漏】。所以，我要在 Java 虚拟机参数方面或者业务方代码逻辑方面入手，一步一步测试，找出问题的元凶。本文就记录这一过程，以及适当引申一些关于 JVM 的知识。</p><p>解释说明一下，上述中的 SDK 表示存储系统独立封装的取数、查询接口，它屏蔽了 Elasticsearch 自带的接口，并封装成公共组件，提供给各个业务方使用。各个业务方在使用前，需要申请开通 token 验证码，存储系统会根据业务方的使用量分配合适的资源，业务方在调用时需要传入 token 验证。这样做的好处，一是可以监控所有的业务方的取数、查询情况，收集所有的请求日志，统计一些常用的指标，然后反过来指导存储系统的改进，例如根据业务方的调用情况进行资源分配的伸缩、针对常用的数据类型进行索引优化。二是可以保障整个数据库集群的正常运行，由于屏蔽了 Elasticsearch 自带的接口，业务方不能随意操作超大额的数据量，SDK 会做限制，因此不会产生某些不合理的查询、取数请求，从而不对数据库造成巨大的压力。三是限制了一些不需要的查询、取数方式，在保障业务方基本需求的情况下又可以保障数据库集群的稳定，例如多层聚合、日期聚合等操作，这些操作不合理，而且会对数据库集群造成压力【无论数据量大小都可能会出事】。</p><a id="more"></a><h1 id="问题出现"><a href="# 问题出现" class="headerlink" title="问题出现"></a>问题出现 </h1><p> 简单描述现象，查看日志，猜测可能的原因。</p><h1 id="问题解决"><a href="# 问题解决" class="headerlink" title="问题解决"></a>问题解决 </h1><h2 id="分析现象"><a href="# 分析现象" class="headerlink" title="分析现象"></a> 分析现象 </h2><p> 一开始没有指定 JVM 参数，因为使用的是 JDK1.7 版本的参数，不会生效，这就导致分配的默认堆取值偏小。</p><p>JVM 参数设置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">JAVA=$&#123;JAVA_HOME&#125;/bin/java</span><br><span class="line"># 设置 jvm 的参数 </span><br><span class="line">#HEAP_OPTS=&quot;-Xms12g -Xmx12g&quot;</span><br><span class="line">HEAP_OPTS=&quot;-Xms6g -Xmx6g -Xmn2g&quot;</span><br><span class="line"># JDK8 以后取消了 PermSize</span><br><span class="line">#PERM_OPTS=&quot;-XX:PermSize=1024M -XX:MaxPermSize=2048m -XX:+UseConcMarkSweepGC -XX:+UseParNewGC&quot;</span><br><span class="line">#JDK8 的 MetaspaceSize</span><br><span class="line">PERM_OPTS=&quot;-XX:MetaspaceSize=1024m -XX:MaxMetaspaceSize=2048m -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+HeapDumpOnOutOfMemoryError&quot;</span><br></pre></td></tr></table></figure><p>待整理，重试，重现现象，确保问题准确复现。</p><h2 id="掌握内存分析工具"><a href="# 掌握内存分析工具" class="headerlink" title="掌握内存分析工具"></a>掌握内存分析工具 </h2><p> 待整理。各种工具介绍，举例，截图。</p><h2 id="对症下药解决问题"><a href="# 对症下药解决问题" class="headerlink" title="对症下药解决问题"></a>对症下药解决问题 </h2><p> 待整理。减小内存，使用普通的 list。<br>重试，使用命令行工具查看现象，截图。</p><h1 id="问题总结"><a href="# 问题总结" class="headerlink" title="问题总结"></a>问题总结 </h1><h2 id="不同版本的参数不一致"><a href="# 不同版本的参数不一致" class="headerlink" title="不同版本的参数不一致"></a> 不同版本的参数不一致 </h2><p> 主要是针对 JDK 来说的，不同的 JDK 版本的参数会有一些不同，例如以下 2 个虚拟机参数，在 JDK1.8 的环境中是 <strong>-XX:MetaspaceSize=1024m -XX:MaxMetaspaceSize=2048m</strong>，已经不是 <strong>-XX:PermSize=1024M -XX:MaxPermSize=2048m</strong> 了【JDK 1.7 以及以前的版本】，在进程启动的时候查看日志会有警告信息的，提示参数设置无效，会被忽略。</p><h2 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h2><p>占用内存，待整理。</p><h2 id="模拟内存溢出"><a href="# 模拟内存溢出" class="headerlink" title="模拟内存溢出"></a>模拟内存溢出 </h2><p> 待整理。</p><h2 id="进程已杀死问题"><a href="# 进程已杀死问题" class="headerlink" title="进程已杀死问题"></a>进程已杀死问题 </h2><p> 加大内存，机器内存不够分配，进程异常退出，待整理。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;最近遇到一个棘手的问题，有业务方在调用存储系统封装的 SDK 取数的过程中，遇到了 OOM 问题，但是数据量很小，只有 12000 条。同时进程启动时申请的内存高达 12g，使用 Xmx、Xms 参数控制，实际指定参数取值为：-Xms12g -Xmx12g。但是如果只看报错日志信息，抛出异常的代码位置指向了 SDK 的内部代码。根据这个现象，我猜测可能是业务方的处理逻辑问题、SDK 内部处理逻辑问题、申请的内存过小问题，这些问题归根结底，要么是内存不够【内存溢出】，要么是内存不当使用【内存泄漏】。所以，我要在 Java 虚拟机参数方面或者业务方代码逻辑方面入手，一步一步测试，找出问题的元凶。本文就记录这一过程，以及适当引申一些关于 JVM 的知识。&lt;/p&gt;&lt;p&gt;解释说明一下，上述中的 SDK 表示存储系统独立封装的取数、查询接口，它屏蔽了 Elasticsearch 自带的接口，并封装成公共组件，提供给各个业务方使用。各个业务方在使用前，需要申请开通 token 验证码，存储系统会根据业务方的使用量分配合适的资源，业务方在调用时需要传入 token 验证。这样做的好处，一是可以监控所有的业务方的取数、查询情况，收集所有的请求日志，统计一些常用的指标，然后反过来指导存储系统的改进，例如根据业务方的调用情况进行资源分配的伸缩、针对常用的数据类型进行索引优化。二是可以保障整个数据库集群的正常运行，由于屏蔽了 Elasticsearch 自带的接口，业务方不能随意操作超大额的数据量，SDK 会做限制，因此不会产生某些不合理的查询、取数请求，从而不对数据库造成巨大的压力。三是限制了一些不需要的查询、取数方式，在保障业务方基本需求的情况下又可以保障数据库集群的稳定，例如多层聚合、日期聚合等操作，这些操作不合理，而且会对数据库集群造成压力【无论数据量大小都可能会出事】。&lt;/p&gt;
    
    </summary>
    
      <category term="基础技术知识" scheme="https://www.playpi.org/categories/basic-technical-knowledge/"/>
    
    
      <category term="JDK" scheme="https://www.playpi.org/tags/JDK/"/>
    
      <category term="内存泄漏" scheme="https://www.playpi.org/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"/>
    
      <category term="内存溢出" scheme="https://www.playpi.org/tags/%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA/"/>
    
      <category term="jvm" scheme="https://www.playpi.org/tags/jvm/"/>
    
  </entry>
  
  <entry>
    <title>青椒炒蛋做法总结</title>
    <link href="https://www.playpi.org/2019033101.html"/>
    <id>https://www.playpi.org/2019033101.html</id>
    <published>2019-03-31T08:40:52.000Z</published>
    <updated>2019-03-31T08:40:52.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>青椒炒蛋，是一道非常普通的家常菜，基本家家户户都会做。有的家庭喜欢吃辣，放的是稍微辣一点的辣椒，有的家庭不喜欢吃辣，就放菜椒或者甜椒，总之，对于辣椒的选择非常多。对于辣椒的处理方式，有的人喜欢切小块，有的人喜欢斜切小段，还有的人直接剁碎，做法也多种多样。本文记录青椒炒蛋的做法总结，使用的是菜椒【不辣微甜】，由于故意多放了生抽，做出来的口味是咸香的。</p><a id="more"></a><h1 id="食材准备"><a href="# 食材准备" class="headerlink" title="食材准备"></a>食材准备 </h1><p> 以下食材的份量为一大盘，足够 2 人吃，食材非常简单：</p><ul><li>鸡蛋 3 个 </li><li> 青椒 2 棵 </li><li> 大蒜 6 粒 </li><li> 食用盐、生抽酱油 </li></ul><p> 全部的食材 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb59lzf0j229s29sx6p.jpg" alt="全部的食材" title="全部的食材"></p><h1 id="制作过程"><a href="# 制作过程" class="headerlink" title="制作过程"></a> 制作过程 </h1><p> 这是一道快菜，制作过程根据家庭灶的火力大小，2-5 分钟即完成。</p><h2 id="处理食材备用"><a href="# 处理食材备用" class="headerlink" title="处理食材备用"></a>处理食材备用 </h2><p> 青椒洗净去籽切小快，鸡蛋液加少量食用盐搅拌均匀，大蒜切片。</p><p>青椒切块，大蒜切片 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb5ifv55j229s29sb2a.jpg" alt="青椒切块，大蒜切片" title="青椒切块，大蒜切片"></p><p> 鸡蛋液 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb5mnskjj229s29sb29.jpg" alt="鸡蛋液" title="鸡蛋液"></p><h2 id="炒鸡蛋备用"><a href="# 炒鸡蛋备用" class="headerlink" title="炒鸡蛋备用"></a> 炒鸡蛋备用 </h2><p> 锅里加油，要多加一点，鸡蛋液很吸油，烧热后下鸡蛋液，定型后炒散，炒散后盛出备用。由于鸡蛋液里面已经加了食用盐，就不用再加盐调味了。</p><p>鸡蛋液下锅 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb5rk896j229s29s4qq.jpg" alt="鸡蛋液下锅" title="鸡蛋液下锅"></p><p> 定型炒散 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb5x5pt6j229s29skjl.jpg" alt="定型炒散" title="定型炒散"></p><p> 鸡蛋盛出备用 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb62uunrj229s29sqv5.jpg" alt="鸡蛋盛出备用" title="鸡蛋盛出备用"></p><h2 id="炒青椒大蒜"><a href="# 炒青椒大蒜" class="headerlink" title="炒青椒大蒜"></a> 炒青椒大蒜 </h2><p> 锅里留底油，如果炒完鸡蛋后不够再适当加点油，烧热，大蒜片和青椒同时下锅翻炒【注意是同时下锅】，翻炒至青椒 5 成熟，关小火准备加生抽调味。</p><p>青椒大蒜同时下锅 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb6hcvv2j229s29snpe.jpg" alt="青椒大蒜同时下锅" title="青椒大蒜同时下锅"></p><p> 翻炒至青椒 5 成熟 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb6n92i2j229s29snpe.jpg" alt="翻炒至青椒 5 成熟" title="翻炒至青椒 5 成熟"></p><h2 id="加生抽调味后下鸡蛋"><a href="# 加生抽调味后下鸡蛋" class="headerlink" title="加生抽调味后下鸡蛋"></a> 加生抽调味后下鸡蛋 </h2><p> 青椒翻炒至 5 成熟时，关小火，加生抽调味。注意一定要加多一点生抽，那种大的汤勺可以加将近一汤勺，然后开大火翻炒，把青椒炒至 8 成熟，生抽遇到大火热量时会散发独特的香味。</p><p>加生抽炒至青椒 8 成熟 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb72tpblj229s29snpe.jpg" alt="加生抽炒至青椒 8 成熟" title="加生抽炒至青椒 8 成熟"></p><p> 此时倒入前面炒过的鸡蛋，混合翻炒，如果觉得不够味再加一点食用盐，我加的生抽已经够味，不再加食用盐了。</p><p>倒入鸡蛋 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb7dw5nvj229s29se82.jpg" alt="倒入鸡蛋" title="倒入鸡蛋"></p><p> 翻炒均匀 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb7i7j4wj229s29skjm.jpg" alt="翻炒均匀" title="翻炒均匀"></p><h2 id="出锅装盘"><a href="# 出锅装盘" class="headerlink" title="出锅装盘"></a> 出锅装盘 </h2><p> 翻炒均匀后可以出锅装盘了。</p><p>装盘侧视图 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb7odz35j229s29sqv5.jpg" alt="装盘侧视图" title="装盘侧视图"></p><p> 装盘俯视图 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb7s48a3j229s29snpd.jpg" alt="装盘俯视图" title="装盘俯视图"></p><p> 配上剩下的几块红烧肉，美滋滋。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1mb7ww16ej229s29sqv5.jpg" alt="配上剩下的几块红烧肉，美滋滋" title="配上剩下的几块红烧肉，美滋滋"></p><h1 id="注意事项"><a href="# 注意事项" class="headerlink" title="注意事项"></a>注意事项 </h1><p>1、炒青椒时和大蒜片一起下锅，不需要先下大蒜片爆香，这很关键。</p><p>2、油量，炒鸡蛋的时候一定要多放一点油，才能保持鸡蛋的嫩滑，因为鸡蛋液吸油很厉害。如果油加的少，会导致鸡蛋炒的有点干有点糊，影响口感。</p><p>3、炒青椒的时候为什么要多加一点生抽呢，毕竟会影响这道菜的颜色，一般炒菜都只会在最后调味时加一点点。因为使用青椒来炒鸡蛋，这种青椒是没有什么味道的，那样只会有鸡蛋的香味，显得太单调，而生抽遇到热量会散发出独特的香味，同时生抽里面又有盐分，从而达到了咸香的效果。就如北方有些地方做番茄炒蛋的时候，是做成咸味的，也会加入大量的生抽，味道也非常好，特别是拌面吃，既是菜又能调味。</p><h1 id="致谢"><a href="# 致谢" class="headerlink" title="致谢"></a> 致谢 </h1><p> 感谢微博用户 <strong>@开心的柠檬日记 </strong>，在微博上放了很多做菜的方子，微博主页为：<a href="https://weibo.com/u/2232990523" target="_blank" rel="noopener">开心的柠檬日记的微博</a> 。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;青椒炒蛋，是一道非常普通的家常菜，基本家家户户都会做。有的家庭喜欢吃辣，放的是稍微辣一点的辣椒，有的家庭不喜欢吃辣，就放菜椒或者甜椒，总之，对于辣椒的选择非常多。对于辣椒的处理方式，有的人喜欢切小块，有的人喜欢斜切小段，还有的人直接剁碎，做法也多种多样。本文记录青椒炒蛋的做法总结，使用的是菜椒【不辣微甜】，由于故意多放了生抽，做出来的口味是咸香的。&lt;/p&gt;
    
    </summary>
    
      <category term="菜谱" scheme="https://www.playpi.org/categories/cookbook/"/>
    
    
      <category term="青椒炒蛋" scheme="https://www.playpi.org/tags/%E9%9D%92%E6%A4%92%E7%82%92%E8%9B%8B/"/>
    
      <category term="辣椒炒蛋" scheme="https://www.playpi.org/tags/%E8%BE%A3%E6%A4%92%E7%82%92%E8%9B%8B/"/>
    
  </entry>
  
  <entry>
    <title>参加 Elastic 社区第三次线下活动广州站</title>
    <link href="https://www.playpi.org/2019033001.html"/>
    <id>https://www.playpi.org/2019033001.html</id>
    <published>2019-03-29T16:41:05.000Z</published>
    <updated>2019-04-06T16:41:05.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>在 2019 年 3 月 30 日，我去参加了 Elastic 社区第三次线下活动广州站的分享会，活动简介：<a href="https://meetup.elasticsearch.cn/event/guangzhou/1001.html" target="_blank" rel="noopener">Elastic 社区第三次线下活动广州站 </a> 。看到各位行业顶尖分享者的分享，不能说受益匪浅，至少给我打开了一些思路，拓展了我的知识面，同时我也学到了一些知识，既包括技术方面的，也包括处事方面的。这篇博文就简单记录一下这个过程。</p><a id="more"></a><h1 id="出发"><a href="# 出发" class="headerlink" title="出发"></a> 出发 </h1><p> 先看一下地图指引 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf2ls1z3j214q0u0djy.jpg" alt="地图指引" title="地图指引"></p><p> 到达公交站，上冲南站，天气不错 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf2vj7mlj229s29sb2c.jpg" alt="上冲南站" title="上冲南站"></p><p> 走路路过特斯拉服务站，听说最近交付的特斯拉电动车有很多问题 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf33253ij229s29shdt.jpg" alt="路过特斯拉服务站" title="路过特斯拉服务站"></p><h1 id="到达"><a href="# 到达" class="headerlink" title="到达"></a> 到达 </h1><p> 到达的比较早，因为要帮忙安排桌子凳子，一切准备就绪后，一起吃了个午饭。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf3jejrej229s29s1ky.jpg" alt="吃了个午饭" title="吃了个午饭"></p><p>13:30 开始签到，签到现场 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf3of8qlj229s29sb2a.jpg" alt="签到现场" title="签到现场"></p><p> 我充当了一会儿签到员，坐着的那个是我 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf3sy1ylj20m80cimyt.jpg" alt="坐着的那个是我" title="坐着的那个是我"></p><p> 各种各样的 Elasticsearch 贴纸 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf3ydx4cj229s29s4qq.jpg" alt="各种各样的 Elasticsearch 贴纸" title="各种各样的 Elasticsearch 贴纸"></p><p> 这是一种比较特殊的 Elasticsearch 贴纸 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf427iykj20qo1hcq74.jpg" alt="特殊的 Elasticsearch 贴纸" title="特殊的 Elasticsearch 贴纸"></p><h1 id="静听分享"><a href="# 静听分享" class="headerlink" title="静听分享"></a> 静听分享 </h1><p> 先简单看一下这个分享会的大概流程与分享内容 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf471eb8j21830o9gnw.jpg" alt="分享内容" title="分享内容"></p><h2 id="分享一"><a href="# 分享一" class="headerlink" title="分享一"></a> 分享一 </h2><p>Elasticsearch 在数说全量库的应用实践</p><p> 现场场景一 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf5ceaqtj21kw0w0as5.jpg" alt="场景一" title="场景一"></p><p> 现场场景二 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf58jqs2j20zk0k0ta7.jpg" alt="场景二" title="场景二"></p><p> 现场场景三 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf54mc76j21hc0u0q84.jpg" alt="场景三" title="场景三"></p><h2 id="分享二"><a href="# 分享二" class="headerlink" title="分享二"></a> 分享二 </h2><p>Elasticsearch 在慧算账技术运营中的应用</p><p> 现场场景 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf4yz5k5j20m80ciac7.jpg" alt="现场" title="现场"></p><h2 id="分享三"><a href="# 分享三" class="headerlink" title="分享三"></a> 分享三 </h2><p>Elasticsearch 在大数据可视化分析中的应用</p><p> 现场场景 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf4twfafj20m80cit9r.jpg" alt="现场" title="现场"></p><h2 id="分享四"><a href="# 分享四" class="headerlink" title="分享四"></a> 分享四 </h2><p> 打造云原生的 Elasticsearch 服务 </p><p> 现场场景 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf4p52q6j20m80cit9u.jpg" alt="现场" title="现场"></p><h2 id="分享五"><a href="# 分享五" class="headerlink" title="分享五"></a> 分享五 </h2><p>Elasticsearch 集群在雷达大数据平台的演进</p><p> 现场场景 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf4kjqsjj20m80ciq4f.jpg" alt="现场" title="现场"></p><h2 id="分享者合影留念"><a href="# 分享者合影留念" class="headerlink" title="分享者合影留念"></a> 分享者合影留念 </h2><p> 认真的观众 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf4c5u0oj21400u00x8.jpg" alt="认真的观众" title="认真的观众"></p><p> 分享者合影留念 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1tf4ftxkrj20m80cizlx.jpg" alt="分享者合影留念" title="分享者合影留念"></p><h1 id="我的思考以及学到的东西"><a href="# 我的思考以及学到的东西" class="headerlink" title="我的思考以及学到的东西"></a> 我的思考以及学到的东西 </h1><p>0、虽然有一些分享听不懂，例如腾讯云的 Elasticsearch 云服务，做了什么优化、达到了什么效果，或者是数说雷达的架构演进，这些目前对于我来说都太不切实际，因为还没接触到这么高深的知识，平时也使用不到，所以听起来云里雾里。但是，能从中提取 1-2 个重要知识点也是有用的，例如腾讯云的索引碎片化，导致读写速度严重下降，这与我在工作当中遇到的问题一模一样。再例如数说雷达演进过程中遇到的坑，某个字段没有做 doc_values，导致不支持 aggregation 查询，这与我很久之前遇到的问题一模一样，此时又加深了我的认知。</p><p>1、多版本 Elasticsearch 的兼容解决办法，需要设置拦截器，把请求的不兼容参数部分替换掉，可以使用 SpringBoot 整合，需要注意已知版本的种类。</p><p>2、针对 long 类型字段的聚合【即 aggregation】请求根据自己的业务场景，如果判断为实际上没有必要【例如只是对年份、月份、日做聚合，并不考虑时区、毫秒时间戳的问题】，可以换一种思路，转化为字符串存储，针对字符串做聚合操作效率就高多了。</p><p>3、在现场提问时，有的人是带着自己业务实际遇到的问题来提问探讨的，提问时描述问题已经消耗了将近 10 分钟。接下来如果真的探讨起来，估计没有半个小时一个小时搞不定，这显然是在浪费大家的时间。所以分享者也及时打断了提问，并留下联系方式，分享会后线下接着再讨论。这种做法很得体，虽然不能在现场解答【为了节约大家的时间】，但是会后讨论也是一样，有时候根据实际情况就是需要这样的取舍。</p><p>4、在 Elasticsearch 中，字段类型是可以节约存储空间与请求耗时的，例如 integer、long、short 的合理使用，但是切记存储的目的最终都是为了使用。</p><h1 id="备注"><a href="# 备注" class="headerlink" title="备注"></a> 备注 </h1><p> 如果需要查看分享者的 PPT 文档，可以在 Elastic 社区下载：<a href="https://elasticsearch.cn/slides" target="_blank" rel="noopener">https://elasticsearch.cn/slides</a> 。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;在 2019 年 3 月 30 日，我去参加了 Elastic 社区第三次线下活动广州站的分享会，活动简介：&lt;a href=&quot;https://meetup.elasticsearch.cn/event/guangzhou/1001.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Elastic 社区第三次线下活动广州站&lt;/a&gt; 。看到各位行业顶尖分享者的分享，不能说受益匪浅，至少给我打开了一些思路，拓展了我的知识面，同时我也学到了一些知识，既包括技术方面的，也包括处事方面的。这篇博文就简单记录一下这个过程。&lt;/p&gt;
    
    </summary>
    
      <category term="游玩" scheme="https://www.playpi.org/categories/have-for-fun/"/>
    
    
      <category term="Elastic" scheme="https://www.playpi.org/tags/Elastic/"/>
    
      <category term="线下活动" scheme="https://www.playpi.org/tags/%E7%BA%BF%E4%B8%8B%E6%B4%BB%E5%8A%A8/"/>
    
      <category term="广州" scheme="https://www.playpi.org/tags/%E5%B9%BF%E5%B7%9E/"/>
    
  </entry>
  
  <entry>
    <title>FFmpeg 使用总结</title>
    <link href="https://www.playpi.org/2019032701.html"/>
    <id>https://www.playpi.org/2019032701.html</id>
    <published>2019-03-27T13:28:09.000Z</published>
    <updated>2019-03-27T13:28:09.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>FFmpeg 是一款开源的软件，可以进行多种格式的视频、音频编码转换、片段剪辑。它包含了 libavcodec – 这是一个用于多个项目中音频和视频的解码器库，以及 libavformat – 一个音频与视频格式转换库。<strong>FFmpeg</strong> 这个单词中的 <strong>FF</strong> 指的是 <strong>Fast Forward</strong>。FFmpeg 官网：<a href="https://ffmpeg.org" target="_blank" rel="noopener">https://ffmpeg.org</a> ，下载时会跳转到这里：<a href="https://ffmpeg.zeranoe.com/builds" target="_blank" rel="noopener">https://ffmpeg.zeranoe.com/builds</a> ，请选择合适的版本下载使用。本文记录 FFmpeg 的使用方法，基于 Windows X64 平台。</p><a id="more"></a><h1 id="下载安装"><a href="# 下载安装" class="headerlink" title="下载安装"></a>下载安装 </h1><h2 id="下载"><a href="# 下载" class="headerlink" title="下载"></a> 下载 </h2><p> 在 <a href="https://ffmpeg.zeranoe.com/builds" target="_blank" rel="noopener">https://ffmpeg.zeranoe.com/builds</a> 下载页面，选择适合自己操作系统的版本，我这里选择 Windows X64 的 static zip 包，解压后直接使用，无需安装。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3ly1g1ivhlcgh4j21hc0q9dkh.jpg" alt="FFmpeg 下载页面" title="FFmpeg 下载页面"></p><h2 id="解压配置环境变量"><a href="# 解压配置环境变量" class="headerlink" title="解压配置环境变量"></a>解压配置环境变量 </h2><p> 下载到指定的目录【最好放在方便管理的目录，不显得混乱】，直接解压，得到一个文件夹，里面有 bin、doc、presets 这 3 个子文件夹，其中 bin 里面就包含了主程序：ffmpeg、ffplay、ffprobe，这里不涉及安装的概念，程序可以直接使用。</p><p>解压主目录 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3ly1g1ivi9q552j20o00hgt9m.jpg" alt="解压主目录" title="解压主目录"></p><p> 子文件夹 bin<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3ly1g1ividmkdbj20o00hg753.jpg" alt="子文件夹 bin" title="子文件夹 bin"></p><p>为了方便使用这 3 个主程序，需要把 bin 所在目录配置到环境变量 PATH 中【我这里是 D:\Program Files\ffmpeg\bin】，这里就不再赘述，如果不配置，每次使用命令时都要给出完整的目录，我觉得很麻烦。</p><h1 id="使用示例"><a href="# 使用示例" class="headerlink" title="使用示例"></a>使用示例 </h1><p>ffmpeg 的命令行参数的位置会影响执行的结果，例如时间参数，这与我所知道的其它工具不一样，所以参数位置不能乱放。此外，还需要注意涉及到转码的操作会比较耗时，几十分钟的视频不是几分钟能处理完的，和视频的清晰度也有关系，这个要有一定的心理准备。</p><p>1、把 mkv 格式的视频文件转为 mp4 格式的文件，视频使用 <strong>libx264</strong> 编码。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 如果没有配置环境变量 PATH, 命令需要指定 D:\Program Files\ffmpeg\bin\ffmpeg</span><br><span class="line">ffmpeg -i imput.mkv -c:v libx264 output.mp4</span><br></pre></td></tr></table></figure><p>2、查看视频文件的流信息，包括视频、音频、字幕。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 其中类似 Stream #0:0 格式的内容就是流信息，指定参数时可以直接使用数字编号表示流 </span><br><span class="line">ffmpeg -i input.mkv</span><br></pre></td></tr></table></figure><p><img src="https://ws1.sinaimg.cn/large/b7f2e3a3ly1g1ivijvhopj20l50cpjso.jpg" alt="查看视频文件的流信息" title="查看视频文件的流信息"></p><p>3、mkv 文件剪辑，截取片段，指定音轨。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- -ss 表示开始时间，-to 表示结束时间，</span><br><span class="line">ffmpeg -ss 01:22:08 -to 01:32:16 -accurate_seek -i in.mkv -map 0:v -map 0:a:1 -codec copy -avoid_negative_ts 1 out.mkv</span><br></pre></td></tr></table></figure><p> 其中，<strong>-accurate_seek</strong> 表示画面帧数校准，<strong>-avoid_negative_ts 1</strong> 表示修复结尾可能的空白帧，<strong>-map 0:v</strong> 表示截取所有视频，<strong>-map 0:a:1</strong> 表示截取第 2 道音轨。</p><p>此外，如果把时间参数放在 -i 前面，结果总会多截取 1-2 秒【如上面示例】。但是如果放在后面，截取的视频片段时间准确了，然而开头的音频正常，视频有 20-30 秒的漆黑一片，不知道为啥。</p><p>4、rmvb 文件转为 mp4 文件，涉及到编码转换。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 视频使用 h264 编码，音频使用 aac 编码 </span><br><span class="line">ffmpeg -i input.rmvb -c:v h264 -c:a aac out.mp4</span><br></pre></td></tr></table></figure><p>这里需要注意，涉及到编码转换的比较消耗 CPU，上面这个命令把我的 CPU 消耗到 100%，动态视频详见微博：<a href="https://weibo.com/3086148515/HmVcnm7Kl" target="_blank" rel="noopener">FFmpeg 视频转码 CPU 飙升到 100%</a> 。其中，留意流输出信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Stream mapping:</span><br><span class="line">  Stream #0:1 -&gt; #0:0 (rv40 (native) -&gt; h264 (libx264))</span><br><span class="line">  Stream #0:0 -&gt; #0:1 (cook (native) -&gt; aac (native))</span><br></pre></td></tr></table></figure><p>此外，FFmpeg 不支持 rmvb 格式的文件，只能转码为 mp4 的格式再使用，这里的不支持不是指不能处理，而是不能直接输出 rmvb 格式的文件，处理输入是可以的。</p><h1 id="其它"><a href="# 其它" class="headerlink" title="其它"></a>其它</h1><p>1、如果只是为了转换 mkv 文件的格式为 mp4，也可以使用一款软件：<a href="https://www.videohelp.com/software/MkvToMp4" target="_blank" rel="noopener">MkvToMp4</a> 。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;FFmpeg 是一款开源的软件，可以进行多种格式的视频、音频编码转换、片段剪辑。它包含了 libavcodec – 这是一个用于多个项目中音频和视频的解码器库，以及 libavformat – 一个音频与视频格式转换库。&lt;strong&gt;FFmpeg&lt;/strong&gt; 这个单词中的 &lt;strong&gt;FF&lt;/strong&gt; 指的是 &lt;strong&gt;Fast Forward&lt;/strong&gt;。FFmpeg 官网：&lt;a href=&quot;https://ffmpeg.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://ffmpeg.org&lt;/a&gt; ，下载时会跳转到这里：&lt;a href=&quot;https://ffmpeg.zeranoe.com/builds&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://ffmpeg.zeranoe.com/builds&lt;/a&gt; ，请选择合适的版本下载使用。本文记录 FFmpeg 的使用方法，基于 Windows X64 平台。&lt;/p&gt;
    
    </summary>
    
      <category term="知识改变生活" scheme="https://www.playpi.org/categories/knowledge-for-life/"/>
    
    
      <category term="FFmpeg" scheme="https://www.playpi.org/tags/FFmpeg/"/>
    
      <category term="视频剪辑" scheme="https://www.playpi.org/tags/%E8%A7%86%E9%A2%91%E5%89%AA%E8%BE%91/"/>
    
      <category term="音频剪辑" scheme="https://www.playpi.org/tags/%E9%9F%B3%E9%A2%91%E5%89%AA%E8%BE%91/"/>
    
      <category term="视频转码" scheme="https://www.playpi.org/tags/%E8%A7%86%E9%A2%91%E8%BD%AC%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>分别 是为了再次相聚</title>
    <link href="https://www.playpi.org/2019032702.html"/>
    <id>https://www.playpi.org/2019032702.html</id>
    <published>2019-03-26T16:45:51.000Z</published>
    <updated>2019-04-14T16:45:51.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>这是我还在大学读书的时候，有一年过年回家，组织了高中同班同学的聚会，其实主要目的就是一起吃个饭，玩半天，交流一下。我还隐隐约约记得当时提前约好了十几个人，然后到了当天早上再确认的时候，只有八个人能来了，刚好凑一桌。那次一别，以后再也没见过，只在微信上聊过，大家天各一方，有的求学做科研，有的成家立业。而如今，当我碰巧再拾起这段文字的时候，只觉得沙流指尖，微风拂面。</p><p>当然，我再也写不出这么稚嫩的、无病呻吟的文字了，因为现在整天在写代码，我的思维也变化了很多。</p><p>最近三年，在工作环境中经历了多次的相聚离别，现在年后又是离职大潮，刚好整理出这篇旧笔记，提醒自己的成长之路。</p><a id="more"></a><h1 id="开篇"><a href="# 开篇" class="headerlink" title="开篇"></a>开篇 </h1><p> 我应该算是一个善感的人，但不多愁。此时努力寻找记忆中的碎片，感受那些我能看到的瞬间，尝试从记忆中寻找值得书写的部分，以作想念。</p><p>每次只要有久违的聚会，之前我都会想象见面时的情景，以及每个人的样子，认为这样能追寻到由于长时间不见面而淡去的亲切感。同时内心也会积聚起来丰富的情感，构思出许多可以表达的文字，藏在心底，待到意兴浓的时候说出来。</p><h1 id="相聚"><a href="# 相聚" class="headerlink" title="相聚"></a>相聚 </h1><p> 我记得那天早晨起的特别早，是假期中最早的一次，可能是内心的激动，亦或是天气转暖，也可能是因为我定了三个闹钟。出发的时候由于出现了三个不在我计划中的意外，导致我的出发时间比我预计的晚了一个小时，这已经使我的内心感到些许急躁。后来在路上没想到会堵车，又耽搁了 20 分钟，望着拥挤的车流，我再也按捺不住急躁的内心，便直接下车走完了最后一段路，到达的时候已经是中午 12 点了。</p><p>在路上有点风，微风拂面，我能感觉到微微颤抖，为自己没有围围巾而感到后悔，这可是冬天，温度只有几摄氏度。可是到了集合地点太阳都出来了，阳光明媚，冬风和煦，的确是个好天气，相当适合聚会，内心的寒冷一扫而空。</p><p>走到集合的地点，那是一个破旧的学校操场，我曾在这里度过一年光阴，扶了扶眼镜，向四周望了望，看到在操场旁的屋檐下，他们正在打桌球。毕竟两年多没见过面了，他们的样子在我脑海中渐渐模糊，此时努力搜寻，看着一张张熟悉又陌生的脸庞，心中情感翻涌，暗暗对着他们的名字，辛福感扑面而来。但准备好的话一句也没有说出口，这就是我的性格，见了面在一起比什么语言都美好，直接加入他们，我想这也是最好的表达。</p><p>快速从脑海中搜索记忆，在我仔细看来，大家仍然是高中的模样，没有怎么变化，还是那么青春，还是那么快乐，没有老练，没有隔阂，脸上洋溢着年少时的单纯感，都像这个年龄应该有的样子。</p><p>我装出很「酷」的样子，至少我是这么认为，可毕竟长时间没有打过桌球了，手生，出杆结果总是不尽人意，我总感觉自己处于尴尬的境地，可是仍然装出不在乎的样子，说几句玩笑话，淡淡一笑，希望没人看到，说到底还是生疏了。</p><p>本应该可以去吃饭了，但大家兴致未尽，在「混乱」的状态下又玩了几十分钟，随着黑色八号球的入袋，结束了应该有的结局，已经过了午饭的时间。说实话，此时我已经饥肠辘辘，但大家看起来都很亢奋，兴奋喜悦的表情洋溢于脸，在说笑中集体寻找吃饭的地点。</p><p>八个年轻人一起走在马路上，蹦蹦跳跳，三两成堆，不时对旁边的人吐露心声，开着不着边际的玩笑，说着没心没肺的笑话。此时我的脑海中浮现出一幅和谐美好的画面，也必将印在我的心底。</p><p>走走停停，说说笑笑，乘坐免费的公交，不多时便到达了新建落成的七彩世界，映入眼帘的是花花绿绿的色彩，心情豁然开朗，已经做好了吃喝的准备。进入大楼入口，乘坐电梯，直奔饮食区域。</p><p>首先寻找最佳的位置，足够容纳八个人入座，围在一起，谈笑风生。我实在是饿坏了，便独自一人去点了一碗面，首先尝尝咸淡。没想到我等了一会儿，他们大部分人都来了，都要吃面，那就点吧。七七八八大家议论了一番，各自点了一碗面。</p><p>等待上面的过程中，几个男生又去点了一些副食，女生去点了饮品，相互搭配，应该足够果腹了。东西上齐后，本想随心所欲，大快朵颐，可是不知怎么的，先前的食欲减小了，不过以我的大饭量还是能消耗很多食物的。</p><p>吃饭的过程就是吃饭的过程。</p><p>吃饱喝足之后，大家聊了一会儿，有人提议打牌，反正闲着没事儿干，打就开打。本来准备去购买纸牌的，没想到王飞的书包里居然带着这玩意儿，看来他那书包里面装着很多现金也是真的了。</p><p>打牌真的是体力活也是脑力活，不仅需要工于计算，还需要相互配合，可是牌不好什么都白搭。在这个过程，我可以说是遭遇了打牌生涯的滑铁卢，无论怎么样打，都是输牌。当然，值得说明的是，输牌并不是因为牌技不好，而是因为牌不好，就算什么都算出来了也打不赢，这不能怪我。</p><p>身为理科生，我清楚地知道这只是概率问题，风水会轮流转，但为了缓解气氛，我也可以承认这可能是人品的问题。况且竟然牌从头到尾一直不好，想想这也是一个小概率事件，我不得不承认可能确实和我的人品有一点关系。</p><p>输输输……</p><p>输了牌，就会有惩罚，惩罚过后，换了一波人继续打。可是万万没想到，我这一门虽然换了人打，牌还是不好，虽然比我打的时候好了那么一点点，仍然是稳输不赢，牌差的简直令人发指。打牌成绩的最顶峰也就是赢了一个而已，很快又变成负数了，真是令人伤悲。</p><h1 id="分别"><a href="# 分别" class="headerlink" title="分别"></a>分别 </h1><p> 不知不觉中，在说说笑笑、打打闹闹的氛围下过去了几个小时，天也已经快黑了，是时候该分别了，各自回家，要不然有些人恐怕赶不上末班车了（十八线小县城过了六点就没车了）。而后大家收拾东西，开始动身，临走时总要合照一张吧。<br>合照一没有我 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g22nqcm23mj22kg1g0qrf.jpg" alt="合照一没有我" title="合照一没有我"></p><p> 合照二没有我 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g22nq6tdiuj22kg1g0e39.jpg" alt="合照二没有我" title="合照二没有我"></p><p> 每一张照片，王飞的脖子和头看起来很奇怪，我没法挑出效果更好的了。第一张解丰的全身没有入镜，当然，这怪我，是我拍的。请看下面零散的几张照片，当时的红米手机拍照效果也就这样了，每张照片的大小只有 800KB 左右。<br>大家闲聊 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g22nqg2uudj22kg1g01gn.jpg" alt="大家闲聊" title="大家闲聊"></p><p> 二位在比划啥 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g22nqk8fcij22kg1g0e5h.jpg" alt="二位在比划啥" title="二位在比划啥"></p><p> 二位正经的样子 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g22nqnctgmj21g02kgav7.jpg" alt="二位正经的样子" title="二位正经的样子"></p><p> 正经人 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g22nrb50u6j22kg1g0qrd.jpg" alt="正经人" title="正经人"></p><p> 这里面有我 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g22nqqosy6j22kg1g0nlw.jpg" alt="这里面有我" title="这里面有我"></p><p> 这是干啥 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g22nreufvtj21g02kgnl7.jpg" alt="这是干啥" title="这是干啥"></p><p> 下了楼，大家一起往车站行走，途中许梦宇有事首先分别，王继雪顺车回家第二个分别。剩下的六人继续走在繁华的街头，沿着热闹的商铺，趁着剩下不多的时间聊天说笑。</p><p>本来是一段很短的路程，我们却走了很长时间，可能大家心里都想着多聊一会儿吧，才故意放慢了脚步。当然，最终这也导致了我错过了回家的末班车。</p><p>到了车站，大家又聊了一会儿，当作告别的寒暄。我不得不乘坐另外一辆车，和李欢一起，只是到达离家还有十多公里的永兴街上，然后让家里的亲人来接。</p><h1 id="结尾"><a href="# 结尾" class="headerlink" title="结尾"></a>结尾 </h1><p>「天下没有不散的宴席」，这句老话大家都知道，可大概只有经历过的人才能理解其中蕴含着的意义吧。时间总是很快，最终的时刻总要分别。</p><p> 分别，是为了再次相聚。</p><p>下一次再相聚会是什么时候呢？</p><p>下一次再相聚大家会变吗？</p><p>静静等待着再次相聚。</p><p>哦，对了，我离开家乡去学校的那天，火车开动的时候，家乡飘起了小雪。后来火车远离家乡的时候，听说雪已经很大了，可惜我没有见到。</p><p>是为记。</p><p>2015 年 02 月 26 日 </p><p> 鹏飞</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;这是我还在大学读书的时候，有一年过年回家，组织了高中同班同学的聚会，其实主要目的就是一起吃个饭，玩半天，交流一下。我还隐隐约约记得当时提前约好了十几个人，然后到了当天早上再确认的时候，只有八个人能来了，刚好凑一桌。那次一别，以后再也没见过，只在微信上聊过，大家天各一方，有的求学做科研，有的成家立业。而如今，当我碰巧再拾起这段文字的时候，只觉得沙流指尖，微风拂面。&lt;/p&gt;&lt;p&gt;当然，我再也写不出这么稚嫩的、无病呻吟的文字了，因为现在整天在写代码，我的思维也变化了很多。&lt;/p&gt;&lt;p&gt;最近三年，在工作环境中经历了多次的相聚离别，现在年后又是离职大潮，刚好整理出这篇旧笔记，提醒自己的成长之路。&lt;/p&gt;
    
    </summary>
    
      <category term="游玩" scheme="https://www.playpi.org/categories/have-for-fun/"/>
    
    
      <category term="聚会" scheme="https://www.playpi.org/tags/%E8%81%9A%E4%BC%9A/"/>
    
      <category term="利辛一中" scheme="https://www.playpi.org/tags/%E5%88%A9%E8%BE%9B%E4%B8%80%E4%B8%AD/"/>
    
  </entry>
  
  <entry>
    <title>爆炒花甲做法总结</title>
    <link href="https://www.playpi.org/2019032501.html"/>
    <id>https://www.playpi.org/2019032501.html</id>
    <published>2019-03-24T17:02:40.000Z</published>
    <updated>2019-03-24T17:02:40.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>爆炒花甲是一道做法简单、快速出菜、可口下饭的家常菜，一般晚上去大排档吃夜宵，基本都会有这道菜。本文记录爆炒花甲的家常做法，以及需要注意的地方。</p><a id="more"></a><h1 id="食材准备"><a href="# 食材准备" class="headerlink" title="食材准备"></a>食材准备 </h1><p> 以下份量为一盘：</p><ul><li>花甲 1.5 斤 - 2 斤，花甲的价格一般在 6-10 块钱之间【广州地区】</li><li>二荆条辣椒 2 个，细长条那种，不是很辣 </li><li> 小米椒 5 个，我用干辣椒和辣椒酱代替了 </li><li> 豆瓣酱、蚝油、食用盐、淀粉 </li><li> 大蒜、香葱，香葱我用青椒代替了 </li></ul><p> 辣椒食材 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1l5ne1e6kj229s29se81.jpg" alt="辣椒食材" title="辣椒食材"></p><p> 辣椒切碎备用 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1l5njohsrj229s29se82.jpg" alt="辣椒切碎备用" title="辣椒切碎备用"></p><p> 准备工作中最重要的就是让花甲吐沙，一般买回来的花甲里面都会有大量的沙子，所以要让花甲把沙子吐出来，这样吃起来才不会硌牙，否则会严重影响口感，没法吃。</p><p>花甲吐沙方法主要有两种：</p><ul><li>方法 1【时间长，简单】：放入清水、食用盐、香油，浸泡一个小时，基本可以把沙吐干净。</li><li>方法 2【时间短，麻烦】：放入锅中，加入清水、料酒、姜片、香油，小火煮热【不要很热，保持不烫手的温度，否则会严重影响肉质】，持续 15 分钟，也可以把沙吐干净。</li></ul><p>我一般选择第一种，花甲买回来之后放在盆里，加入盐、香油等着就行了，可以先去处理其它食材了，不用管，很方便。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1l5oxjyxmj229s29se82.jpg" alt="让花甲吐沙" title="让花甲吐沙"></p><h1 id="制作步骤"><a href="# 制作步骤" class="headerlink" title="制作步骤"></a>制作步骤 </h1><h2 id="花甲焯水"><a href="# 花甲焯水" class="headerlink" title="花甲焯水"></a> 花甲焯水 </h2><p> 花甲吐沙完成之后，捞出进行焯水，焯水之后花甲基本熟了，然后捞出花甲迅速过冷水，过冷水的目的是保持花甲肉的鲜嫩。注意焯水不要太久，否则花甲肉就老了，影响口感。我把花甲焯水的时候还加了姜片和料酒去腥。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1l5pebk8cj229s29s4qq.jpg" alt="花甲焯水" title="花甲焯水"></p><h2 id="爆香锅底"><a href="# 爆香锅底" class="headerlink" title="爆香锅底"></a>爆香锅底 </h2><p> 油烧热，一定要比平时炒菜多放一点油，毕竟是爆炒，加入大蒜、辣椒、姜片，十几秒爆香，我这里省略了姜片，因为焯水的时候用的水里面加了姜片和料酒。大蒜也不加了。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1l5qj41y0j229s29skjm.jpg" alt="爆香锅底" title="爆香锅底"></p><h2 id="豆瓣酱或者蚝油调味"><a href="# 豆瓣酱或者蚝油调味" class="headerlink" title="豆瓣酱或者蚝油调味"></a>豆瓣酱或者蚝油调味 </h2><p> 关小火，加入豆瓣酱，调和味道，我没有豆瓣酱，就用蚝油代替了。</p><h2 id="爆炒花甲"><a href="# 爆炒花甲" class="headerlink" title="爆炒花甲"></a>爆炒花甲 </h2><p> 味道调和好后，加入过冷水的花甲，开大火，爆炒。</p><p>爆炒 3 分钟后关小火调味【时间实际依据灶的火力大小，家用灶一般火不够大，要多炒一会】，加入食用盐【如果豆瓣酱或者生抽够味就不用加盐了】、生抽、辣椒酱，大火翻炒十几秒。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1l5r7ayuaj229s29shdu.jpg" alt="爆炒花甲" title="爆炒花甲"></p><p>我又补了一点辣椒酱 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1l5y5pj3ej229s29sb2a.jpg" alt="补了一点辣椒酱" title="补了一点辣椒酱"></p><p> 最后一步也很关键，使用淀粉液勾芡，目的是让味道均匀包裹在花甲的表面，否则味道都会遗留在锅里，导致花甲味道偏淡。勾芡可以实现真正入味的效果。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1l5rkc386j229s29shdu.jpg" alt="淀粉液勾芡" title="淀粉液勾芡"></p><h2 id="出锅装盘"><a href="# 出锅装盘" class="headerlink" title="出锅装盘"></a>出锅装盘 </h2><p> 如果有香葱的话，出锅前再放一点点香葱，更好看，味道也更好。我这里没放香葱，使用青椒代替了。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1l5s40v2jj229s29su0x.jpg" alt="出锅装盘" title="出锅装盘"></p><h2 id="其它配菜"><a href="# 其它配菜" class="headerlink" title="其它配菜"></a>其它配菜 </h2><p> 顺手做了一道红烧肉，加了香菇和 2 个鸡蛋，有点偏卤肉的口味了。</p><p>红烧肉收汁阶段 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1l5spgpkhj229s29sb2a.jpg" alt="红烧肉收汁阶段" title="红烧肉收汁阶段"></p><p> 红烧肉成品 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1l5su5ddgj229s29sqv5.jpg" alt="红烧肉成品" title="红烧肉成品"></p><h1 id="注意事项"><a href="# 注意事项" class="headerlink" title="注意事项"></a> 注意事项 </h1><h2 id="花甲吐沙"><a href="# 花甲吐沙" class="headerlink" title="花甲吐沙"></a> 花甲吐沙 </h2><p> 花甲吐沙一定要做好，不可匆匆了事，否则花甲吃起来全部都是沙子就不好了，严重影响口感，另外还要注意在爆炒的时候会有一些花甲壳碎掉，混在花甲肉里面，吃的时候也要注意一下，虽然不是沙子，但是也会硌牙。</p><h2 id="花甲焯水 -1"><a href="# 花甲焯水 -1" class="headerlink" title="花甲焯水"></a>花甲焯水 </h2><p> 花甲焯水，可以适当放一点姜片、料酒，去腥味。当然，如果吐沙的方法采用的是温水慢煮的方式，可以不用再放任何调料了，直接焯水就行了。焯水时要切记水不能太沸腾，或者不要一直放在沸水里面，要适当用漏勺翻一下，否则会导致花甲肉全部脱离花甲壳了，这个和花甲新不新鲜无关，水太沸腾会导致大量的花甲肉脱离花甲壳。</p><h2 id="勾芡"><a href="# 勾芡" class="headerlink" title="勾芡"></a>勾芡 </h2><p> 勾芡，才能保证味道均匀分布在花甲表面，吃起来才有入味的效果，否则调味料大部分都粘在锅的表面了。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;爆炒花甲是一道做法简单、快速出菜、可口下饭的家常菜，一般晚上去大排档吃夜宵，基本都会有这道菜。本文记录爆炒花甲的家常做法，以及需要注意的地方。&lt;/p&gt;
    
    </summary>
    
      <category term="菜谱" scheme="https://www.playpi.org/categories/cookbook/"/>
    
    
      <category term="爆炒花甲" scheme="https://www.playpi.org/tags/%E7%88%86%E7%82%92%E8%8A%B1%E7%94%B2/"/>
    
      <category term="麻辣花甲" scheme="https://www.playpi.org/tags/%E9%BA%BB%E8%BE%A3%E8%8A%B1%E7%94%B2/"/>
    
      <category term="炒花甲" scheme="https://www.playpi.org/tags/%E7%82%92%E8%8A%B1%E7%94%B2/"/>
    
  </entry>
  
  <entry>
    <title>使用 Valine 给 Hexo 博客添加评论系统</title>
    <link href="https://www.playpi.org/2019032001.html"/>
    <id>https://www.playpi.org/2019032001.html</id>
    <published>2019-03-20T12:44:40.000Z</published>
    <updated>2019-03-20T12:44:40.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>我的博客已经搭建得差不多了，一些配置也固定下来了，最近重点一直在补充博客内容，把以前的笔记都整理出来。然后有一天我就想，好像总感觉少点什么，发现评论这个功能是没有的。以前是为了追求简洁的风格，而且评论这个功能不稳定，主要是评论系统不好选择，很多都关闭了。思前想后，考虑了好几天，最终还是决定先加上评论功能，实验一阵子，看看有没有必要，后续再决定是取消还是继续，反正也就是改一下配置就行了，没有多大工作量。接下来查了一下当前还活着的评论系统的种类，最后选择了 <strong>Valine</strong> 这个评论系统。它不需要登录，无后台管理，非常简洁，比较符合我追求的理念。参考相关内容：<a href="https://github.com/xCss/Valine" target="_blank" rel="noopener">https://github.com/xCss/Valine</a> 、<a href="https://valine.js.org" target="_blank" rel="noopener">https://valine.js.org</a> 、<a href="https://leancloud.cn" target="_blank" rel="noopener">https://leancloud.cn</a> 。</p><a id="more"></a><h1 id="注册帐号创建应用"><a href="# 注册帐号创建应用" class="headerlink" title="注册帐号创建应用"></a>注册帐号创建应用 </h1><blockquote><p>Valine 诞生于 2017 年 8 月 7 日，是一款基于 Leancloud 的快速、简洁且高效的无后端评论系统。</p></blockquote><p> 所以，第一步就需要注册 Leancloud 账号，然后才能申请应用的 appid 和 appkey。注册过程我就不赘述了，和注册普通的账号一样，官网地址：<a href="https://leancloud.cn" target="_blank" rel="noopener">https://leancloud.cn</a> 。接下来重点来了，需要申请免费的应用【有钱的话也可以购买收费的版本】，这里面有一些需要注意的地方，否则最后评论的时候没有效果，会导致 Leancloud 后台接收不到评论数据。</p><p>1、登录 Leancloud 系统，进入系统的控制台，然后创建应用。<br>从主页进入控制台 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d797qim2j21hc0rvq6j.jpg" alt="从主页进入控制台" title="从主页进入控制台"></p><p> 创建应用，我这里已经创建好一个应用了。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d79ng997j21hc0q974s.jpg" alt="创建应用" title="创建应用"></p><p>2、填写、选择应用的参数，这里需要填写应用的名字，选择开发版本【免费版本，限制请求并发数】。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d79uhbrqj21hc0q9q4e.jpg" alt="填写、选择应用的参数" title="填写、选择应用的参数"></p><p>3、创建完成后，进入设置详情页面。<br>点击齿轮，进入设置详情页面。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d79z1cf8j21hc0q9mxq.jpg" alt="进入设置详情页面" title="进入设置详情页面"></p><p>在设置详情页面里面，选择 <strong>设置 -&gt; 应用 Key</strong>，就可以看到应用的 appid 和 appkey，这 2 个字符串要记下来，等一下在 Hexo 里面配置的时候有用。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d7a30cpmj21hc0q9jt5.jpg" alt="查看应用 Key" title="查看应用 Key"></p><p>4、在 <strong>存储 -&gt; 数据 </strong>里面查看默认的 Class 信息，有一些默认的 Class，例如 _User、_File、_Role 等，这些都用不到，而 Hexo 的评论功能需要一个名称为 Comment 的 Class，现在发现没有这个 Class，要不要手动配置一个呢。其实不用担心，经过我的测试 Hexo 会自动生成这个 Class，所以不需要自己手动配置了。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d7agpw2ij21hc0q9gnc.jpg" alt="查看 Class 信息" title="查看 Class 信息"></p><p>5、在 <strong>设置 -&gt; 安全中心 </strong>，把 <strong>文件上传、短信服务、推送服务、实时通信 </strong>这几个服务全部关闭，因为用不到。然后需要特别注意的就是 <strong>Web 安全域名 </strong>这一个选项，里面一定要填写自己站点的域名，并且带上端口号，例如 http 请求的默认端口就是 80，htps 请求的默认端口就是 443。这里如果没有配置好，评论的时候也会失败的。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d7amoctcj21hc0rv76n.jpg" alt="设置 Web 安全域名" title="设置 Web 安全域名"></p><h1 id="配置 -Hexo- 参数"><a href="# 配置 -Hexo- 参数" class="headerlink" title="配置 Hexo 参数"></a>配置 Hexo 参数 </h1><p> 上一步骤已经把 Leancloud 里面的应用申请好了，并且设置了重要的选项，获取到 appid 和 appkey，接下来配置 Hexo 就简单多了。打开 Hexo 主题的配置文件 <strong>_config.yml</strong>，搜索一下 Valine，找到默认配置【这是因为 Hexo 已经自动集成了 Valine 评论系统，不需要安装什么，如果没有请升级 Hexo 版本】。</p><p>默认是关闭的，把配置更改如下图，更为详细内容参考：<a href="https://valine.js.org/configuration.html" target="_blank" rel="noopener">https://valine.js.org/configuration.html</a> 。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d7at81uyj20ku0b0dgq.jpg" alt="Hexo 配置" title="Hexo 配置"></p><p>主要配置的内容如下【重点是 appid、appkey、placeholder，至于验证、邮件提醒就按照自己的需要来配置吧】：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">valine:</span><br><span class="line">  # 开启 Valine 评论 </span><br><span class="line">  enable: true</span><br><span class="line">  # 设置应用 id 和 key</span><br><span class="line">  appid: CCCJixxxxxxXXXxxxXXXX000-gzGzo000</span><br><span class="line">  appkey: AA1RXXXXXhPXXXX00F0XXXJSq</span><br><span class="line">  # mail notifier , https://github.com/xCss/Valine/wiki</span><br><span class="line">  # 关闭提醒与验证 </span><br><span class="line">  notify: false</span><br><span class="line">  verify: false</span><br><span class="line">  # 文本框占位文字 </span><br><span class="line">  placeholder: 没有问题吗？</span><br><span class="line">  # 需要填写的信息字段 </span><br><span class="line">  meta: [&apos;nick&apos;,&apos;mail&apos;]</span><br><span class="line">  # 默认头像 </span><br><span class="line">  avatar: wavatar</span><br><span class="line">  # 每页显示的评论数 </span><br><span class="line">  pageSize: 10</span><br></pre></td></tr></table></figure><p>这里面我发现一个问题，就是有一些配置项不生效，例如：<strong>meta</strong>、<strong>avatar</strong>，我也不知道是 Hexo 的问题还是 Valine 的问题，我也不懂，就先不管了，因为不影响评论这个功能。</p><p>另外还有一个就是评论的时候总会强制检验邮箱和 url 的规范性，如果没填或者填的不规范就弹框提示，我不知道怎么取消，只好在在 GitHub 提了一个 Issue，详见：<a href="https://github.com/xCss/Valine/issues/168" target="_blank" rel="noopener">https://github.com/xCss/Valine/issues/168</a> ，但是作者一直没回。等了几天，作者回复了，说是我的 Valine 版本太低，让我升级。我看了本地的 Valine 的版本，已经是 v1.3.5 了，然后我就怀疑可能是 Hexo 的版本问题，但是我自己做了很多自定义的配置，改了很多 css、js 文件，不能随便升级，等以后有时间做一个大版本的升级，再好好整理。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d7da6215j20u30fsdgb.jpg" alt="强制检验邮箱和 url 的规范性" title="强制检验邮箱和 url 的规范性"></p><p>那怎么才能让博客文章的底部显示评论对话框呢，其实很简单，什么都不用做，Hexo 默认是给每个页面都开启评论的【前提是在 Hexo 的配置文件中开启了一种评论系统】。它背后的配置就是 Markdown 文件的 comments 属性，默认设置是 true，所以不用配置了，如果非要配置也可以，如下图。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d7dge614j20e408c0sy.jpg" alt="配置底部显示评论对话框" title="配置底部显示评论对话框"></p><p>此外，还需要注意，如果博客还有除正文内容之外的页面存在，例如关于、分类、标签，要把他们的 Markdown 文件的 comments 属性设置为 false，否则这些页面在展示的时候也会有评论的功能出现，总不能让别人随便评论吧。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d7djunr3j20no03iq2r.jpg" alt="取消一些不该有评论的页面" title="取消一些不该有评论的页面"></p><h1 id="测试效果"><a href="# 测试效果" class="headerlink" title="测试效果"></a>测试效果 </h1><p> 打开任意一篇博客文章，可以看到底部已经有评论的文本框了。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d7e6uw4mj20uk0o2q3s.jpg" alt="查看文章的评论文本框" title="查看文章的评论文本框"></p><p>试着填写内容，评论一下，可以看到评论列表的内容。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d7e3f5njj20ta0q3750.jpg" alt="文章的评论列表" title="文章的评论列表"></p><p>好了，此时可以再回到 Leancloud 系统，看一下评论数据吧。直接在 <strong>存储 -&gt; 数据 -&gt;Comment</strong> 里面，可以看到已经有评论数据了。由于 Valine 是无后端的评论系统，所以数据直接被存储到了 Leancloud 系统的数据库表里面，看看就行了，不方便管理。如果评论数据很多，为了更方便管理评论数据，能收到更友好的邮件通知提醒，可以使用 Valine-Admin 来实现，我暂时先不用。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d7dzjwhgj21hc0q9jt1.jpg" alt="Leancloud 系统的评论数据" title="Leancloud 系统的评论数据"></p><p>经过几天的测试，可以看到应用的请求量统计信息。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1d7dvlarqj21hc0rwt9f.jpg" alt="Leancloud 系统的应用请求量" title="Leancloud 系统的应用请求量"></p><h1 id="附加 -Valine-Admin- 进行评论数据管理"><a href="# 附加 -Valine-Admin- 进行评论数据管理" class="headerlink" title="附加 Valine-Admin 进行评论数据管理"></a>附加 Valine-Admin 进行评论数据管理 </h1><p> 这个插件我现在先不使用，因为还不知道评论数据会怎么样呢，等以后如果确实有需要再考虑增加，参考项目：<a href="https://github.com/zhaojun1998/Valine-Admin" target="_blank" rel="noopener">https://github.com/zhaojun1998/Valine-Admin</a> 。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;我的博客已经搭建得差不多了，一些配置也固定下来了，最近重点一直在补充博客内容，把以前的笔记都整理出来。然后有一天我就想，好像总感觉少点什么，发现评论这个功能是没有的。以前是为了追求简洁的风格，而且评论这个功能不稳定，主要是评论系统不好选择，很多都关闭了。思前想后，考虑了好几天，最终还是决定先加上评论功能，实验一阵子，看看有没有必要，后续再决定是取消还是继续，反正也就是改一下配置就行了，没有多大工作量。接下来查了一下当前还活着的评论系统的种类，最后选择了 &lt;strong&gt;Valine&lt;/strong&gt; 这个评论系统。它不需要登录，无后台管理，非常简洁，比较符合我追求的理念。参考相关内容：&lt;a href=&quot;https://github.com/xCss/Valine&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/xCss/Valine&lt;/a&gt; 、&lt;a href=&quot;https://valine.js.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://valine.js.org&lt;/a&gt; 、&lt;a href=&quot;https://leancloud.cn&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://leancloud.cn&lt;/a&gt; 。&lt;/p&gt;
    
    </summary>
    
      <category term="建站" scheme="https://www.playpi.org/categories/building/"/>
    
    
      <category term="Hexo" scheme="https://www.playpi.org/tags/Hexo/"/>
    
      <category term="Valine" scheme="https://www.playpi.org/tags/Valine/"/>
    
      <category term="评论系统" scheme="https://www.playpi.org/tags/%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>Git 客户端设置 Windows 下的字符编码</title>
    <link href="https://www.playpi.org/2019031901.html"/>
    <id>https://www.playpi.org/2019031901.html</id>
    <published>2019-03-19T15:22:16.000Z</published>
    <updated>2019-03-19T15:22:16.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>在 Linux 以及大多数托管网站上，默认的字符编码均是 UTF-8，而 Windows 系统默认编码不是 UTF-8，一般是 GBK。如果在 Windows 平台使用 Git 客户端，不设置 Git 字符编码为 UTF-8，Git 客户端在处理中文内容时会出现乱码现象，很是烦人。但是，如果能正确设置字符编码，则可以有效解决处理中文和中文显示的问题。大多数技术从业者应该都遇到过各种各样的编码问题，后来渐渐习惯了使用英文，尽量避免中文，但是也有一些场景是必须使用中文的。本文就记录解决 Git 中文处理和中文显示的问题的过程，系统环境基于 Windows7 X64，Git 基于 v2.18.0。</p><a id="more"></a><h1 id="乱码现象"><a href="# 乱码现象" class="headerlink" title="乱码现象"></a>乱码现象 </h1><p>Git 是一款非常好用的分布式版本控制系统，为了更好地使用它，一般都需要 Git 客户端的配合，下载使用参考：<a href="https://git-scm.com/downloads" target="_blank" rel="noopener">https://git-scm.com/downloads</a> 。</p><p> 在 Windows 平台使用 Git 客户端的过程中，有一个问题你一定逃不掉，那就是乱码问题。这是因为 Windows 系统的编码是 GBK，而 Git 客户端的编码是 UTF-8，当两种不同的编码相遇，必然有一方会乱码。如果设置 Git 客户端的编码为 GBK，那么在使用 Git 客户端处理系统文件的时候可以正常显示，但是处理 Git 版本控制内容的时候，就会乱码，无法支持中文。如果反过来呢，把 Git 客户端的编码设置为 UTF-8，那么处理版本控制内容就可以有效支持中文，但是处理系统文件的时候又会乱码。</p><p>Git 客户端设置 UTF-8 编码，处理系统文件显示乱码 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g17blzgl2zj20l50cpjt9.jpg" alt="ls 命令中文乱码" title="ls 命令中文乱码"></p><h1 id="解决方式"><a href="# 解决方式" class="headerlink" title="解决方式"></a> 解决方式 </h1><p> 这样看起来似乎没有解决方法，其实不是的，还是有很好的解决方法的。我这里为了完全支持版本管理系统，版本管理优先，肯定要统一设置为 UTF-8 编码，然后通过 Git 客户端的编码自动转换来支持系统的 GBK 编码。</p><p>这里先提前说明，在使用 Git 客户端的时候，Git 的安装目录【一般默认是 C:\Program Files\Git】，也就是 Git 的根目录。在使用 <strong>ls</strong> 等命令处理文件时，如果携带了 <strong>/</strong> 字符，其实就表示从 Git 的安装目录开始。例如在里面寻找 etc 目录，如果是使用 Git Bash 打开的，可以直接使用根目录的方式，<strong>cd /etc/</strong>。再例如 <strong>vi /etc/git-completion.bash</strong> 不是表示从系统的根目录开始寻找文件【Windows 系统也没有根目录的概念】，而是表示从 Git 的安装目录开始寻找文件。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g17bn7wtv0j20nd0dumyg.jpg" alt="Git 安装目录" title="Git 安装目录"></p><h2 id="设置 -Git- 客户端"><a href="# 设置 -Git- 客户端" class="headerlink" title="设置 Git 客户端"></a>设置 Git 客户端 </h2><p> 打开 Git 客户端的主页面，右键打开菜单栏【或者点击窗口的左上角也可以打开】，选择 <strong>Options</strong> 选项。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g17bmpt7mnj20l50cp0tw.jpg" alt="Options 选项" title="Options 选项"></p><p>接着选择 <strong>Text</strong> 参数配置，把编码方式由 GBK 改为 UTF-8【locale 也要设置为 zh_CN】。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g17bnna4xyj20l50cpacj.jpg" alt="Text 参数配置" title="Text 参数配置"></p><p>设置完成后，一定会导致一个现象，那就是使用 <strong>ls</strong> 查看系统文件时，带有中文的目录和带有中文的文件，一定是乱码的，根本看不清楚显示的是什么。不过不用担心，后面会通过设置让它恢复正常的。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g17blzgl2zj20l50cpjt9.jpg" alt="ls 命令中文乱码" title="ls 命令中文乱码"></p><p>接下来要解决的是显示的问题，目的是保证 Windows 的 GBK 编码可以在 Git 客户端正常显示。由于 Git 客户端被设置为了 UTF-8 编码，使用 <strong>ls</strong> 命令查看目录文件详情的时候，一定是乱码的，什么也看不出来【数字和英文不受影响】。那就需要设置 <strong>ls</strong> 命令的参数，让它按照 Git 客户端的编码来显示，不支持的字符也要显示，这样再使用 <strong>ls</strong> 命令的时候，就会自动把 GBK 编码转为 UTF-8 编码，那么带有中文的目录、带有中文的文件都能正常显示了。</p><p>最简单的做法，就是需要指定 <strong>ls</strong> 命令的附加参数【–show-control-chars】，为了方便，直接更改配置文件 <strong>/etc/git-completion.bash</strong> 【没有的话新建一个既可】，在行尾增加配置项 <strong>alias ls=”ls –show-control-chars –color”</strong> 。其实就是通过新建别名这个技巧把 <strong>ls</strong> 命令的含义扩展了，让它可以根据 Git 客户端的编码转换系统的编码【在这里就是把 GBK 转为 UTF-8】。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/git-completion.bash</span><br><span class="line">alias ls=&quot;ls --show-control-chars --color&quot;</span><br></pre></td></tr></table></figure><p>更改完成后，可以看到能正常显示系统中的带有中文名称的文件了。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g17bo2mcrej20l50cpq4y.jpg" alt="ls 可以正常显示中文" title="ls 可以正常显示中文"></p><p>但是还要注意一点，如果使用 Git 客户端的 Bash 处理其它命令，一定会乱码的，因为不像 <strong>ls</strong> 那样做了编码转换。以下 2 例【分别时使用 elasticsearch、java 命令】：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g185ktkbutj20l50cp0ul.jpg" alt="elasticsearch 命令乱码" title="elasticsearch 命令乱码"></p><p><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g185l2lrrhj20l50ghmz2.jpg" alt="java 命令乱码" title="java 命令乱码"></p><p>那这个现象有没有办法解决呢，网上大多数解决办法都是说把 Git 客户端的编码设置为和 Windows 系统一样，一般设置为 GBK，这显然是又倒退回去了【为了满足 Git 一定要设置为 UTF-8】。其实唯一的解决办法就是从命令的参数下手，把原生的命令利用别名机制给加上编码有关的参数，和修改 <strong>ls</strong> 命令的做法一致。以下供参考：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- 在文件最后追加，不要修改文件原有的内容 </span><br><span class="line">vi /etc/bash.bashrc</span><br><span class="line">alias javac=&quot;javac -J-Dfile.encoding=UTF-8&quot;</span><br><span class="line">alias java=&quot;java -Dfile.encoding=UTF-8&quot;</span><br></pre></td></tr></table></figure><h2 id="设置 -Git"><a href="# 设置 -Git" class="headerlink" title="设置 Git"></a>设置 Git</h2><p>接下来就是设置 Git 进行版本控制时使用的编码方式，例如提交信息时支持输入中文日志、输出 log 可以正常显示中文。</p><p>设置 Git 有两种方式，一种是通过更改配置文件，另一种是通过 Git 自带的命令来配置参数。为了显得没有手动去破坏 Git 的原有配置文件，我就使用 Git 自带的命令来配置编码。当然，通过更改配置文件的方式也会一同描述出来。</p><p>1、通过命令行把 Git 的各种编码都设置为 UTF-8</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git config --global core.quotepath false          # 显示 status 编码 </span><br><span class="line">git config --global gui.encoding utf-8            # 图形界面编码 </span><br><span class="line">git config --global i18n.commit.encoding utf-8    # 处理提交信息编码 </span><br><span class="line">git config --global i18n.logoutputencoding utf-8  # 输出 log 编码 </span><br><span class="line">export LESSCHARSET=utf-8                          # 因为 git log 默认使用 less 分页，所以需要 bash 对 less 命令处理时使用 utf-8 编码 </span><br></pre></td></tr></table></figure><p>2、如果通过配置文件的方式来更改，则需要编辑配置文件 <strong>/etc/gitconfig</strong> 【没有则新建一个】，在里面设置以下内容。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[core]</span><br><span class="line">        quotepath = false </span><br><span class="line">[gui]</span><br><span class="line">        encoding = utf-8 </span><br><span class="line">[i18n]</span><br><span class="line">        commitencoding = utf-8 </span><br><span class="line">        logoutputencoding = utf-8</span><br></pre></td></tr></table></figure><p>另外还需要在配置文件 <strong>/etc/profile</strong> 中新增 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LESSCHARSET=utf-8</span><br></pre></td></tr></table></figure><p>3、特殊说明</p><p><strong>gui.encoding = utf-8</strong> 是为了解决 git gui 和 gitk 中的中文乱码问题，如果发现代码中的注释显示乱码，可以在所属项目的根目录中 <strong>.git/config</strong> 文件中添加：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[gui]</span><br><span class="line">        encoding = utf-8</span><br></pre></td></tr></table></figure><p><strong>i18n.commitencoding = utf-8</strong> 是为了设置 commit log 提交时使用 UTF-8 编码。<br><strong>i18n.logoutputencoding = utf-8</strong> 是为了保证在 <strong>git log</strong> 时使用 UTF-8 编码。<br><strong>export LESSCHARSET=utf-8</strong> 是为了保证 <strong>git log</strong> 翻页时使用 UTF-8 编码，这样就可以正常显示中文了【配合前面的 <strong>i18n.logoutputencoding</strong> 设置】。</p><h2 id="验证"><a href="# 验证" class="headerlink" title="验证"></a> 验证 </h2><p>add 执行的时候 Git 输出的日志都是中文显示的，特别是带有中文名称的文件。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g17bv0ph2yj20l50f20uh.jpg" alt="add 命令输出中文" title="add 命令输出中文"></p><p> 验证提交时填写日志信息，可以直接填写中文日志，另外 Git 的输出日志也是以中文来显示的，可以看到哪些文件变更了。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g17boorhqyj20l50cpgn8.jpg" alt="验证提交时填写中文日志" title="验证提交时填写中文日志"></p><p>验证使用 <strong>git log</strong> 查看历史日志时正常显示中文内容 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g17bosnlsnj20l50cp0tt.jpg" alt="查看历史日志时正常显示中文内容 1" title="查看历史日志时正常显示中文内容 1"></p><p><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g17box3cduj20l50cp3zx.jpg" alt="查看历史日志时正常显示中文内容 2" title="查看历史日志时正常显示中文内容 2"></p><h1 id="注意事项"><a href="# 注意事项" class="headerlink" title="注意事项"></a> 注意事项</h1><p>1、此外，Cygwin 在 Windows 平台上也有同样的问题，设置方式也是类似的。当然，如果只是查看目录文件，使用基本的命令，请尽量脱离带有中文的目录和带有中文的文件，避免踩坑，这样还可以把编码直接设置为 GBK 了，但是遇到特殊的情况还是脱离不了 UTF-8 编码。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;在 Linux 以及大多数托管网站上，默认的字符编码均是 UTF-8，而 Windows 系统默认编码不是 UTF-8，一般是 GBK。如果在 Windows 平台使用 Git 客户端，不设置 Git 字符编码为 UTF-8，Git 客户端在处理中文内容时会出现乱码现象，很是烦人。但是，如果能正确设置字符编码，则可以有效解决处理中文和中文显示的问题。大多数技术从业者应该都遇到过各种各样的编码问题，后来渐渐习惯了使用英文，尽量避免中文，但是也有一些场景是必须使用中文的。本文就记录解决 Git 中文处理和中文显示的问题的过程，系统环境基于 Windows7 X64，Git 基于 v2.18.0。&lt;/p&gt;
    
    </summary>
    
      <category term="基础技术知识" scheme="https://www.playpi.org/categories/basic-technical-knowledge/"/>
    
    
      <category term="Git" scheme="https://www.playpi.org/tags/Git/"/>
    
      <category term="Windows" scheme="https://www.playpi.org/tags/Windows/"/>
    
      <category term="中文乱码" scheme="https://www.playpi.org/tags/%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81/"/>
    
      <category term="gbk" scheme="https://www.playpi.org/tags/gbk/"/>
    
      <category term="utf-8" scheme="https://www.playpi.org/tags/utf-8/"/>
    
  </entry>
  
  <entry>
    <title>麻婆豆腐做法总结</title>
    <link href="https://www.playpi.org/2019031601.html"/>
    <id>https://www.playpi.org/2019031601.html</id>
    <published>2019-03-16T13:07:13.000Z</published>
    <updated>2019-03-16T13:07:13.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>麻婆豆腐是一道川菜，口味特色就是麻、辣、鲜，而且非常下饭。我常听说正宗的麻婆豆腐要用郫县豆瓣酱【回锅肉也是这样】，才能做出来正宗的味道，但是我身边没有那么多材料，只能做一道简单版的麻婆豆腐。本文就记录麻婆豆腐的做法总结。</p><a id="more"></a><h1 id="食材准备"><a href="# 食材准备" class="headerlink" title="食材准备"></a>食材准备 </h1><p> 食材就很简单了，以下的量为一盘：</p><ul><li>嫩豆腐一块，一般 2 块钱左右 </li><li> 瘦肉 50 克，剁成肉沫 </li><li> 豆瓣酱，我没有豆瓣酱就用一种混合调味酱【辣椒酱、豆瓣酱、胡椒粉】替代了 </li><li> 辣椒粉，或者辣椒酱 </li><li> 青花椒，最好用青花椒，才够麻的味道【买的散装青花椒里面会有一些其它植物的种子，要细心挑拣出去】</li></ul><p>一块嫩豆腐 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mdpgmo7j229s29snpd.jpg" alt="一块嫩豆腐" title="一块嫩豆腐"></p><p> 青花椒 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15me1xf07j229s29snpd.jpg" alt="青花椒" title="青花椒"></p><h1 id="制作步骤"><a href="# 制作步骤" class="headerlink" title="制作步骤"></a> 制作步骤 </h1><h2 id="初步处理食材"><a href="# 初步处理食材" class="headerlink" title="初步处理食材"></a> 初步处理食材 </h2><p> 豆腐切小块，稍微焯水，备用。如果豆腐质量比较好的话，可以一整块冲一下水就行，不用再焯水了。我买的这个豆腐有点碱的味道【类似魔芋一样】，所以稍微焯一下水为好。焯水时不能用大火，否则豆腐会碎掉的，也可以在焯水时稍微放一点点盐进去。</p><p>豆腐切小块 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15meleoz3j229s29skjl.jpg" alt="豆腐切小块" title="豆腐切小块"></p><p> 豆腐简单焯水 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15meu18t2j229s29s4qq.jpg" alt="豆腐简单焯水" title="豆腐简单焯水"></p><p> 瘦肉剁成肉沫，稍微腌制一下，备用。我为了保持肉沫的鲜嫩，还裹了一层淀粉液。<br>瘦肉剁成肉沫 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mf2x2shj229s29shdu.jpg" alt="瘦肉剁成肉沫" title="瘦肉剁成肉沫"></p><p> 肉沫腌制 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mf7k4lij229s29sb29.jpg" alt="肉沫腌制" title="肉沫腌制"></p><p> 肉沫裹淀粉液 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mfc810oj229s29s7wh.jpg" alt="肉沫裹淀粉液" title="肉沫裹淀粉液"></p><h2 id="炒肉沫"><a href="# 炒肉沫" class="headerlink" title="炒肉沫"></a> 炒肉沫 </h2><p> 锅里放油烧热，稍微多放一点油，然后倒入肉沫翻炒，基本 30 秒就可以了。<br>肉沫下锅 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mgbgss2j229s29s7wi.jpg" alt="肉沫下锅" title="肉沫下锅"></p><p> 肉沫翻炒 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mgghk4kj229s29s7wi.jpg" alt="肉沫翻炒" title="肉沫翻炒"></p><h2 id="炒豆腐"><a href="# 炒豆腐" class="headerlink" title="炒豆腐"></a> 炒豆腐 </h2><p> 一般的做法应该是接着放豆瓣酱，炒出红油，然后加青花椒、辣椒粉，加水煮了一段时间后，再下豆腐。但是我就不搞这么复杂的过程了，直接炒一下豆腐，把豆腐和肉沫混合在一起。<br>豆腐下锅炒 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mh0jf5jj229s29sx6p.jpg" alt="豆腐下锅炒" title="豆腐下锅炒"></p><p> 豆腐肉沫混合 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mh4vb6jj229s29s1ky.jpg" alt="豆腐肉沫混合" title="豆腐肉沫混合"></p><p> 加混合调味酱、辣椒酱、调味料、青花椒 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mhb1f5bj229s29se82.jpg" alt="加酱料" title="加酱料"></p><h2 id="加水开煮"><a href="# 加水开煮" class="headerlink" title="加水开煮"></a> 加水开煮 </h2><p> 因为我的豆腐已经焯水了，所以很容易就熟了，接着再加热水煮开，转为小火再煮 5 分钟就行了。切记别加太多热水，否则变汤了，我这个加的有点多，要多煮一会儿水才能蒸发。<br>加热水，刚刚淹没豆腐 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mi8u826j229s29s1ky.jpg" alt="加热水，刚刚淹没豆腐" title="加热水，刚刚淹没豆腐"></p><p> 煮开后转为小火 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mignd6yj229s29sb2a.jpg" alt="煮开后转为小火" title="煮开后转为小火"></p><p> 小火慢煮 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mindngjj229s29sb2a.jpg" alt="小火慢煮" title="小火慢煮"></p><h2 id="收汁出锅装盘"><a href="# 收汁出锅装盘" class="headerlink" title="收汁出锅装盘"></a> 收汁出锅装盘 </h2><p> 煮了 5 分钟就可以准备收汁了，接着还要进行勾芡，我使用淀粉液进行勾芡。勾芡完成稍微再煮 30 秒就可以关火，出锅装盘。</p><p>收汁 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mirmvljj229s29s4qq.jpg" alt="收汁" title="收汁"></p><p> 调淀粉液，少量淀粉加水 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mixp0uzj229s29shdt.jpg" alt="调淀粉液，少量淀粉加水" title="调淀粉液，少量淀粉加水"></p><p> 调淀粉液成品 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mj2h97cj229s29sqv5.jpg" alt="调淀粉液成品" title="调淀粉液成品"></p><p> 勾芡完成，可以看到有点浓稠 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mnev10jj229s29se82.jpg" alt="勾芡完成，可以看到有点浓稠" title="勾芡完成，可以看到有点浓稠"></p><p> 出锅装盘 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mjau8njj229s29skjm.jpg" alt="出锅装盘" title="出锅装盘"></p><h1 id="注意事项"><a href="# 注意事项" class="headerlink" title="注意事项"></a> 注意事项</h1><p>1、为了保证肉沫的鲜嫩，千万不要炒太久，下锅后稍微炒一下就行了，因为后续还要加水煮很久呢。我这里没有采用炒豆瓣酱出红油的做法，所以就用淀粉液裹了一下，肉沫炒熟后直接下豆腐。</p><p>2、切豆腐时豆腐一般都会粘在刀上，所以有一个技巧就是从手心往手指的方向反着切，切完一刀就可以用手压住，这样豆腐就不会粘在刀上了。参考如下图【我是左手持刀，右手压豆腐】：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g15mjlrsb8j229s29s4qq.jpg" alt="反向切豆腐" title="反向切豆腐"></p><p>3、收汁时最好使用淀粉液勾芡一下，这样才能保证调味料都裹在豆腐上，达到入味的效果。否则味道可能都遗落在汤汁里面了，导致豆腐没有什么味道。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;麻婆豆腐是一道川菜，口味特色就是麻、辣、鲜，而且非常下饭。我常听说正宗的麻婆豆腐要用郫县豆瓣酱【回锅肉也是这样】，才能做出来正宗的味道，但是我身边没有那么多材料，只能做一道简单版的麻婆豆腐。本文就记录麻婆豆腐的做法总结。&lt;/p&gt;
    
    </summary>
    
      <category term="菜谱" scheme="https://www.playpi.org/categories/cookbook/"/>
    
    
      <category term="麻婆豆腐" scheme="https://www.playpi.org/tags/%E9%BA%BB%E5%A9%86%E8%B1%86%E8%85%90/"/>
    
      <category term="豆腐" scheme="https://www.playpi.org/tags/%E8%B1%86%E8%85%90/"/>
    
      <category term="麻辣豆腐" scheme="https://www.playpi.org/tags/%E9%BA%BB%E8%BE%A3%E8%B1%86%E8%85%90/"/>
    
  </entry>
  
  <entry>
    <title>青椒肉丝做法总结</title>
    <link href="https://www.playpi.org/2019031101.html"/>
    <id>https://www.playpi.org/2019031101.html</id>
    <published>2019-03-10T18:38:01.000Z</published>
    <updated>2019-03-12T14:38:01.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>青椒肉丝，本来是一道做法非常简单的菜肴，但是想做好却不容易，为什么呢？一是因为肉丝和青椒丝很多人切不出来，可能切出来的是条状的，那就做不出来青椒肉丝；二是因为腌制肉的时候没有进行裹淀粉的步骤【有条件裹鸡蛋清当然更好】，导致肉刚下锅就老，炒不出鲜嫩滑爽的效果；三是因为炒的时候油量和油温没有控制好，导致肉炒老了，不好吃。本文则记录青椒肉丝的炒制过程以及需要注意的地方，请观察一下我是怎么做出来一道家常的青椒肉丝的。</p><a id="more"></a><h1 id="食材准备"><a href="# 食材准备" class="headerlink" title="食材准备"></a>食材准备 </h1><p> 食材就很简单了，以下是一盘的份量：</p><ul><li>纯瘦肉 200 克 </li><li> 大青椒一棵 </li><li> 大红椒一棵【为了好看，搭配一棵红椒】</li><li>淀粉少量、花生油少量 </li></ul><h1 id="制作步骤"><a href="# 制作步骤" class="headerlink" title="制作步骤"></a> 制作步骤 </h1><h2 id="食材处理"><a href="# 食材处理" class="headerlink" title="食材处理"></a> 食材处理 </h2><p> 主要就是切肉丝，切青椒丝，腌制肉丝，注意肉丝要切细一点。切肉丝的时候先把肉切片【一只手掌按着肉，刀躺着从手掌下划过】，最后用肉片去切肉丝，可以保证肉丝的质量。腌制肉丝的时候除了调味料，还需要加一点点水和淀粉【淀粉不要多放，否则菜炒出来会偏甜】，用手抓均匀，让淀粉液充分裹在肉丝表面【有条件就用鸡蛋清替代更好，但是肉丝少的时候就没必要了，用不完一个鸡蛋】。最后还要加一点点花生油，防止肉丝下锅的时候粘锅。肉丝腌制 10 分钟。</p><p>青红椒切丝 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fw75eifj229s29shdt.jpg" alt="青红椒切丝" title="青红椒切丝"></p><p> 腌制肉丝加调料 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10funjj97j229s29se81.jpg" alt="腌制肉丝加调料" title="腌制肉丝加调料"></p><p> 腌制肉丝加水和淀粉 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fvj4muxj229s29s1ky.jpg" alt="腌制肉丝加水和淀粉" title="腌制肉丝加水和淀粉"></p><p> 抓均匀后放一点花生油 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fvxca54j229s29sx6p.jpg" alt="抓均匀后放一点花生油" title="抓均匀后放一点花生油"></p><h2 id="肉丝炒制，盛出备用"><a href="# 肉丝炒制，盛出备用" class="headerlink" title="肉丝炒制，盛出备用"></a> 肉丝炒制，盛出备用 </h2><p> 锅里加油，多加一点，先烧热，然后关火让油冷却一下。冷却到 3 成热再倒入肉丝，然后开大火开始翻炒，基本 30 秒就可以把肉丝炒熟了【取决于肉丝切得好不好】。然后盛出备用。</p><p>油加热后冷却 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fwionwoj229s29shdu.jpg" alt="油加热后冷却" title="油加热后冷却"></p><p> 倒入腌制好的肉丝 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fwrw22wj229s29s7wi.jpg" alt="倒入腌制好的肉丝" title="倒入腌制好的肉丝"></p><p> 不停地翻炒 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fx1x7c8j229s29sb2a.jpg" alt="不停地翻炒" title="不停地翻炒"></p><p> 盛出备用 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fxc44nlj229s29s4qq.jpg" alt="盛出备用" title="盛出备用"></p><h2 id="青椒炒制，混合翻炒"><a href="# 青椒炒制，混合翻炒" class="headerlink" title="青椒炒制，混合翻炒"></a> 青椒炒制，混合翻炒 </h2><p> 由于一开始加了偏多的油，此时不需要再放油，或者根据实际情况放一点点也行。油烧热后放入青红椒丝，大火快速翻炒，基本 1 分钟以内就可以把青红椒丝炒至断生。关小火，放入备用的肉丝，翻炒几下，开始调味，放入食用盐、鸡精、耗油，接着大火快速翻炒几下，放几滴香醋，准备出锅。</p><p>放入青红椒丝翻炒 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fxn3q87j229s29s1ky.jpg" alt="放入青红椒丝翻炒" title="放入青红椒丝翻炒"></p><p> 翻炒至断生【为了拍图青红椒丝炒太熟了】<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fxw4b92j229s29s4qq.jpg" alt="翻炒至断生" title="翻炒至断生"></p><p>放入肉丝调味翻炒 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fyjb9j8j229s29s1ky.jpg" alt="放入肉丝调味翻炒" title="放入肉丝调味翻炒"></p><h2 id="出锅装盘"><a href="# 出锅装盘" class="headerlink" title="出锅装盘"></a> 出锅装盘 </h2><p> 盛出装盘 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fyubmo8j229s29s7wi.jpg" alt="盛出装盘" title="盛出装盘"></p><p> 还配了一道麻婆豆腐 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g10fyyqu9wj229s29se82.jpg" alt="麻婆豆腐" title="麻婆豆腐"></p><h1 id="注意事项"><a href="# 注意事项" class="headerlink" title="注意事项"></a> 注意事项</h1><p>1、买肉一定要买纯瘦肉，最好不要带一丝肉筋，并且形状要规整，薄厚均匀，这样才容易切片进而切肉丝。买肉的时候肯定不需要店方帮忙切肉了，因为他们不可能有时间给你切肉丝出来。此外一定要保证刀比较锋利，锋利的刀更容易处理，如果刀用了很久都没磨过，恰好找这个机会磨磨刀。</p><p>2、腌制肉丝的时候可以适当加一点水【用来溶解淀粉】，然后加一点淀粉，抓均匀，让淀粉充分裹上肉丝。当然，有条件的直接使用鸡蛋清最好，不需要水和淀粉了，味道还更香。抓均匀后再加一点花生油，防止下锅的时候粘锅。</p><p>3、肉丝下锅之前要确保油温不高，如果油温过高要开小火让油冷却一下，否则裹着淀粉的肉丝一下锅表面就会糊掉。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;青椒肉丝，本来是一道做法非常简单的菜肴，但是想做好却不容易，为什么呢？一是因为肉丝和青椒丝很多人切不出来，可能切出来的是条状的，那就做不出来青椒肉丝；二是因为腌制肉的时候没有进行裹淀粉的步骤【有条件裹鸡蛋清当然更好】，导致肉刚下锅就老，炒不出鲜嫩滑爽的效果；三是因为炒的时候油量和油温没有控制好，导致肉炒老了，不好吃。本文则记录青椒肉丝的炒制过程以及需要注意的地方，请观察一下我是怎么做出来一道家常的青椒肉丝的。&lt;/p&gt;
    
    </summary>
    
      <category term="菜谱" scheme="https://www.playpi.org/categories/cookbook/"/>
    
    
      <category term="青椒肉丝" scheme="https://www.playpi.org/tags/%E9%9D%92%E6%A4%92%E8%82%89%E4%B8%9D/"/>
    
      <category term="青红椒" scheme="https://www.playpi.org/tags/%E9%9D%92%E7%BA%A2%E6%A4%92/"/>
    
      <category term="炒肉丝" scheme="https://www.playpi.org/tags/%E7%82%92%E8%82%89%E4%B8%9D/"/>
    
  </entry>
  
  <entry>
    <title>腊肠炒饭做法总结</title>
    <link href="https://www.playpi.org/2019030901.html"/>
    <id>https://www.playpi.org/2019030901.html</id>
    <published>2019-03-08T17:06:17.000Z</published>
    <updated>2019-03-08T17:06:17.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>蛋炒饭，是一种常见的菜肴，日常生活中听到的最多的就是扬州炒饭、传统炒饭。其实炒饭的做法非常多，口味也非常多，还被改成了很多版本，例如：虾仁炒饭、滑蛋炒蛋、老干妈炒饭。但无论怎么改变，它们的共同点都是做法简单，准备米饭和配菜就行了，炒出来吃起来香喷喷的，口感极好，也不用单独配其它的菜了，很方便。本文就记录腊肠炒饭的家常做法。</p><a id="more"></a><h1 id="食材准备"><a href="# 食材准备" class="headerlink" title="食材准备"></a>食材准备 </h1><p> 以下准备的是两人份的食材：</p><ul><li>腊肠，我这里选择的皇上皇腊肠，口味偏甜了，不适合炒饭，去买的时候广州酒家的咸香腊肠卖光了，先凑合着用 </li><li> 鸡蛋 2 个 </li><li> 米饭 2 小碗 </li><li> 青菜 1 小棵，普通的青菜即可，或者放绿豌豆也行，主要为了点缀一下 </li><li> 胡萝卜 1 小段 </li></ul><p> 腊肠，我买的这种偏甜了，不适合炒饭，下次还是买广州酒家的咸香腊肠比较好。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wn7ix32qj229s29s7wi.jpg" alt="皇上皇腊肠" title="皇上皇腊肠"></p><p>米饭 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wn80ipw8j229s29skjl.jpg" alt="米饭" title="米饭"></p><p> 全部食材 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wn8yzvcyj229s29shdu.jpg" alt="全部食材" title="全部食材"></p><h1 id="制作步骤"><a href="# 制作步骤" class="headerlink" title="制作步骤"></a> 制作步骤 </h1><h2 id="1、处理配菜"><a href="#1、处理配菜" class="headerlink" title="1、处理配菜"></a>1、处理配菜</h2><p> 配菜全部都切好备用：青菜切碎，腊肠切斜片，胡萝卜切丁，鸡蛋打入碗里搅拌，米饭捣碎。这里需要注意的有三点：一是胡萝卜要去皮，更能凸显颜色，而且没有胡萝卜皮的影响，炒饭吃起来口感也更好。二是米饭要捣碎，让米粒分开，不要一整块下锅，所以最好选择比较干硬的米饭来做炒饭，炒起来更方便，口感也更好。三是搅拌鸡蛋之前可以稍微放一点点食用盐，这样做为了鸡蛋更入味。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wn9b6cd2j229s29sb2a.jpg" alt="所有配菜处理完成" title="所有配菜处理完成"></p><h2 id="2、炒鸡蛋备用"><a href="#2、炒鸡蛋备用" class="headerlink" title="2、炒鸡蛋备用"></a>2、炒鸡蛋备用 </h2><p> 开火，锅里放油，一定要多放点油，因为鸡蛋非常吃油。放多点没关系，因为后续炒饭可以少放点。油烧热后，把鸡蛋液倒放进去，摇晃炒锅，让鸡蛋在里面呈圆形，防止鸡蛋液堆在一起。如果鸡蛋液太多了，可以在底部的鸡蛋液成型后，用锅铲拨到一边，让上边的鸡蛋液流下来，继续成型。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wn9xwk8jj229s29s1ky.jpg" alt="鸡蛋液入锅成型" title="鸡蛋液入锅成型"></p><p>鸡蛋基本成型后，就可以用锅铲搅拌捣碎。实际上用炒勺做就方便一点，如果是用锅铲就不太方便。这里需要注意，鸡蛋不要炒制太熟，要让它保持嫩嫩的，因为等一下还要和米饭一起重新下锅。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wna3znwnj229s29sb2a.jpg" alt="捣碎嫩鸡蛋" title="捣碎嫩鸡蛋"></p><p>捣碎后盛出备用，如果有时间的话，可以把鸡蛋的蛋清和蛋黄分别炒制，做出来的颜色会更好看。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wna81hkqj229s29sx6p.jpg" alt="盛出备用" title="盛出备用"></p><h2 id="3、炒配菜和饭"><a href="#3、炒配菜和饭" class="headerlink" title="3、炒配菜和饭"></a>3、炒配菜和饭 </h2><p> 鸡蛋盛出后，锅里表面其实还有大量的油，接着再稍微放一点点油就行了。继续加热，放入腊肠片、胡萝卜、碎青菜，大火炒 30 秒。<br>加腊肠片 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wnbf5yncj229s29shdu.jpg" alt="加腊肠片" title="加腊肠片"></p><p> 加胡萝卜青菜【我忘记放碎青菜了，出锅前才补上，看后面的图】<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wnbjhtc3j229s29s4qq.jpg" alt="加胡萝卜青菜" title="加胡萝卜青菜"></p><p>接着就开始加入米饭和刚才的鸡蛋，我这个米饭看起来是一块一块的，其实一碰就散了，开大火不停地翻炒。翻炒 3 分钟左右【如果一开始米饭没有捣碎，或者刚从冰箱拿出来的冷米饭，炒起来会比较慢】，基本就熟了，关小火，准备调味。</p><p>加入米饭和鸡蛋 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wnbopeilj229s29s1ky.jpg" alt="加入米饭和鸡蛋" title="加入米饭和鸡蛋"></p><p> 炒熟了，准备调味 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wnbti2c7j229s29sb2a.jpg" alt="准备调味" title="准备调味"></p><h2 id="4、调味出锅"><a href="#4、调味出锅" class="headerlink" title="4、调味出锅"></a>4、调味出锅</h2><p> 放入盐、鸡精、生抽、老抽，然后继续开大火，翻炒几十秒，出锅装盘，美滋滋。我还放了一点榨菜和辣椒酱。</p><p>放入调味料，因为放了老抽，可以看到颜色有一点点变化 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wnc0a62gj229s29shdu.jpg" alt="调味完成" title="调味完成"></p><p> 前面忘记放青菜了，补回来 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wngewbgvj229s29shdu.jpg" alt="补加青菜" title="补加青菜"></p><p> 出锅装盘，这图片有点糊了 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0wnc81e80j229s29s1ky.jpg" alt="出锅装盘" title="出锅装盘"></p><h1 id="注意事项"><a href="# 注意事项" class="headerlink" title="注意事项"></a> 注意事项</h1><p>1、米饭的选择，米饭不是随便都适合做炒饭的，要选择那种稍微干硬一点的，米粒都分开的，炒出来会更香。如果是剩米饭，已经是一整块了，千万不要一整块的下锅，很难分开，要提前捣碎，处理好再下锅炒。</p><p>2、一开始炒鸡蛋的时候，不要炒制太熟，要保持嫩嫩的，因为后面还要和米饭一起下锅。</p><p>3、腊肠的选择，不要选择偏甜的口味，否则最终的炒饭吃起来会有点腻，所以还是选择咸香的口味比较好。广州酒家的那种咸香的腊肠，用来炒饭真的很合适。</p><p>4、关于分量的建议，一般做炒饭至少两人的份量。因为如果只炒一份，各种菜只能放一点，放多了就不是炒饭了。那问题来了，剩下的菜不好办【半个胡萝卜、半棵青菜】，又不能存放太久，只能下次接着炒，甚至连续吃炒饭。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;蛋炒饭，是一种常见的菜肴，日常生活中听到的最多的就是扬州炒饭、传统炒饭。其实炒饭的做法非常多，口味也非常多，还被改成了很多版本，例如：虾仁炒饭、滑蛋炒蛋、老干妈炒饭。但无论怎么改变，它们的共同点都是做法简单，准备米饭和配菜就行了，炒出来吃起来香喷喷的，口感极好，也不用单独配其它的菜了，很方便。本文就记录腊肠炒饭的家常做法。&lt;/p&gt;
    
    </summary>
    
      <category term="菜谱" scheme="https://www.playpi.org/categories/cookbook/"/>
    
    
      <category term="腊肠炒饭" scheme="https://www.playpi.org/tags/%E8%85%8A%E8%82%A0%E7%82%92%E9%A5%AD/"/>
    
      <category term="蛋炒饭" scheme="https://www.playpi.org/tags/%E8%9B%8B%E7%82%92%E9%A5%AD/"/>
    
      <category term="鸡蛋炒饭" scheme="https://www.playpi.org/tags/%E9%B8%A1%E8%9B%8B%E7%82%92%E9%A5%AD/"/>
    
      <category term="炒饭" scheme="https://www.playpi.org/tags/%E7%82%92%E9%A5%AD/"/>
    
  </entry>
  
  <entry>
    <title>使用 Github 的 WebHooks 实现代码自动更新</title>
    <link href="https://www.playpi.org/2019030601.html"/>
    <id>https://www.playpi.org/2019030601.html</id>
    <published>2019-03-06T15:13:32.000Z</published>
    <updated>2019-03-07T15:13:32.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>我的静态博客为了百度爬虫单独部署了一个镜像，放在了我的 VPS 上面【在 vultr 购买的主机】，并单独设置了二级域名 blog.playpi.org。但是，每次 GitHub 有新的提交时【基本每周都会有至少三次提交】，为了及时更新，我都会登录到 VPS 上面，到指定的项目下做一下拉取更新的操作，即执行 <strong>git pull</strong>。这样操作了三五次，我就有点不耐烦了，自己身为做技术的人，怎么能忍受这个呢，做法既低效又不优雅。于是，我就在想有没有更好的方法来实现自动拉取更新。一开始想到，直接在 VPS 起一个周期性脚本不就行了，比如每隔 1 分钟自动执行 <strong>git pull</strong>，但是立马又被我否定了，虽然做法很简单，但是太不优雅了，而且极大浪费 CPU。后来想到，GitHub 自带了 WebHooks 功能，概念类似于回调钩子，可以给 GitHub 的项目设置各种各样的行为，满足一定的场景才会触发【例如当有新的 push 时，就会向设置的 url 发送请求，并且在请求体中携带 push 的相关信息】。我的自动化构建就是这样的原理，每当 source 分支有提交时，都会通知 tavis-ci【这就是一个行为】，然后在 travis-ci 中设置好脚本，自动运行脚本，就完成了自动生成、部署的操作。</p><p>根据这个思路，就可以给 GitHub 的项目设置一个 WebHooks，每当 master 分支有提交时【代表着静态博客有更新了】，会根据设置的链接自动发送消息到 VPS 上面，然后 VPS 再执行拉取更新，这样的话就优雅多了。但是问题又来了，满足这种场景还需要在 VPS 设置一个后台服务，用来接收 GitHub 的消息通知并执行拉取更新的操作。我想了一下，既然 VPS 上面已经起了 Nginx 服务，那就要充分利用起来，给 Nginx 设置好反向代理，把指定的请求转给另外一个服务就行了。那这个服务怎么选呢，当然是选择 PHP 后台了，毕竟 PHP 号称世界上最好的语言， PHP 后台搭建起来也容易。本文就记录从基础环境安装配置到成功实现自动拉取更新的整个过程，本文涉及的系统环境是 CentOS 7 x64，软件版本会在操作中具体指明。</p><a id="more"></a><h1 id="配置服务器的 -PHP- 支持"><a href="# 配置服务器的 -PHP- 支持" class="headerlink" title="配置服务器的 PHP 支持"></a>配置服务器的 PHP 支持 </h1><p>VPS 上面的 Nginx 已经安装好了，就不再赘述过程，不清楚的可以参考我的另外一篇文章：<a href="https://www.playpi.org/2019010501.html">GitHub Pages 禁止百度蜘蛛爬取的问题</a> 。配置 PHP 的后台服务支持主要有三个步骤：一是配置安装 PHP，包括附加模块 PHP-FPM，二是配置启动 PHP-FPM 模块，三是配置重启 Nginx。由于我的机器资源问题【配置太低】，在这个过程踩了很多坑，我也会一一记录下来。</p><p> 毕竟我是新手，有很多地方不是太懂，所以先参考了官网和一些别人的博客，有时候看多了也会迷惑，有些内容大家描述的不一样，所以要结合自己的实际环境来操作，有些步骤是可以省略的。这些链接我放在这里给大家参考：<a href="https://secure.php.net/manual/zh/install.unix.nginx.php" target="_blank" rel="noopener">参考 PHP 官网 </a> 、<a href="https://segmentfault.com/a/1190000013344675" target="_blank" rel="noopener">CentOS 7.2 环境搭建实录 (第二章：php 安装)</a> 、<a href="https://learnku.com/articles/23694" target="_blank" rel="noopener">PHP-FPM 与 Nginx 的通信机制总结</a> 、<a href="https://qq52o.me/2482.html" target="_blank" rel="noopener"> 使用 Github 的 WebHooks 实现生产环境代码自动更新 </a> 。</p><p> 先安装软件仓库，我的已经安装好了，重复安装也没影响。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br></pre></td></tr></table></figure><h2 id="踩着坑安装 -PHP"><a href="# 踩着坑安装 -PHP" class="headerlink" title="踩着坑安装 PHP"></a>踩着坑安装 PHP</h2><p>1、下载指定版本的 PHP 源码，我这里选择了最新的版本 7.3.3，然后解压。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- 下载 </span><br><span class="line">wget http://php.net/get/php-7.3.3.tar.gz/from/this/mirror -O ./php-7.3.3.tar.gz</span><br><span class="line">-- 解压 </span><br><span class="line">tar zxvf php-7.3.3.tar.gz</span><br></pre></td></tr></table></figure><p>2、configure【配置】，指定 PHP 安装目录【默认是 /usr/local/php，使用 <strong>–prefix</strong> 参数】和 PHP 配置目录【默认和 PHP 安装目录一致，使用 <strong>–with-config-file-path</strong> 参数】，我这里特意指定各自的目录，更方便管理。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 配置，并且开启 PHP-FPM 模块 [使用 --enable-fpm 参数]</span><br><span class="line">./configure --prefix=/site/php/--with-config-file-path=/site/php/conf/--enable-fpm</span><br></pre></td></tr></table></figure><p>遇到报错：<strong>configure: error: no acceptable C compiler found in $PATH</strong>。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g167nenhspj20jt06tglu.jpg" alt="缺少 c 编译器" title="缺少 c 编译器"></p><p>竟然缺少 c 编译器，那就安装吧。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 安装 gcc 编译器 </span><br><span class="line">yum install gcc</span><br></pre></td></tr></table></figure><p>安装 gcc 编译器成功 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g167o1kn4dj21hc0mrgna.jpg" alt="安装 gcc 编译器 1" title="安装 gcc 编译器 1"></p><p><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g167ol7hilj21hc0mrjsx.jpg" alt="安装 gcc 编译器 2" title="安装 gcc 编译器 2"></p><p> 安装 gcc 编译器完成后，接着执行配置，又报错：<strong>configure: error: libxml2 not found. Please check your libxml2 installation.</strong>。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g167p2bqdaj20l20bxq3h.jpg" alt="缺少对应的依赖环境库" title="缺少对应的依赖环境库"></p><p>这肯定是缺少对应的依赖环境库，接着安装就行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- 安装 2 个，环境库 </span><br><span class="line">yum install libxml2</span><br><span class="line">yum install libxml2-devel -y</span><br></pre></td></tr></table></figure><p>安装依赖环境库成功 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g167pq2doqj21hc0mrabc.jpg" alt="安装环境库完成" title="安装环境库完成"></p><p> 接着就重复上述的配置操作，顺利通过配置。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g167qgfhy8j21hc0mrta5.jpg" alt="执行配置完成" title="执行配置完成"></p><p>3、编译、安装。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 编译，安装一起进行 </span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p></p><p>遇到报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cc: internal compiler error: Killed (program cc1)</span><br><span class="line">Please submit a full bug report,</span><br><span class="line">with preprocessed source if appropriate.</span><br><span class="line">See &lt;http://bugzilla.redhat.com/bugzilla&gt; for instructions.</span><br><span class="line">make: *** [ext/fileinfo/libmagic/apprentice.lo] Error 1</span><br></pre></td></tr></table></figure><p><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g167qyojuij20rn0563yp.jpg" alt="编译安装内存不够报错" title="编译安装内存不够报错"></p><p>这是由于服务器内存小于 1G 所导致编译占用资源不足【好吧，我的服务器一共就 512M 的内存，当然不足】。解决办法：在编译参数后面加上一行内容 <strong>–disable-fileinfo</strong>，减少内存的开销。</p><p>接着执行编译又报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cc: internal compiler error: Killed (program cc1)</span><br><span class="line">Please submit a full bug report,</span><br><span class="line">with preprocessed source if appropriate.</span><br><span class="line">See &lt;http://bugzilla.redhat.com/bugzilla&gt; for instructions.</span><br><span class="line">make: *** [Zend/zend_execute.lo] Error 1</span><br></pre></td></tr></table></figure><p>这是因为虚拟内存不够用，我的主机只有 512M。没办法了，降低版本试试，先降为 v7.0.0【或者开启 swap 试试，后面发现不用了，切换低版本后就成功了】，接着重新下载、配置、编译、安装，从头再来一遍。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 下载的时候更改版本号就行 </span><br><span class="line">wget http://php.net/get/php-7.0.0.tar.gz/from/this/mirror -O ./php-7.0.0.tar.gz</span><br></pre></td></tr></table></figure><p>更换了版本后，一切操作都很顺利，就不再考虑开启 swap 了，最终执行编译、安装完成。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g167tfxfarj20iv0mr3zs.jpg" alt="执行编译安装完成" title="执行编译安装完成"></p><h2 id="真正开始配置"><a href="# 真正开始配置" class="headerlink" title="真正开始配置"></a>真正开始配置 </h2><p> 配置、编译、安装完成后，开始编辑各个模块的配置文件，更改默认参数，包括配置 PHP 与 PHP-FPM 模块。确认配置无误，再启动对应的服务或者重新加载对应的配置【也可以使用命令验证参数配置是否正确，下文会有描述】。</p><h3 id="PHP- 配置文件"><a href="#PHP- 配置文件" class="headerlink" title="PHP 配置文件"></a>PHP 配置文件 </h3><p> 在执行编译安装的目录，复制配置文件 <strong>php.ini-development</strong> 粘贴到 PHP 的配置目录【如果一开始 configure 时没有显示指定 PHP 的配置目录，默认应该和 PHP 的安装目录一致，也就是要复制粘贴在 /usr/local/php 中，而我指定了 PHP 的配置目录 /site/php/conf】。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp php.ini-development/site/php/conf/php.ini</span><br></pre></td></tr></table></figure><p>更改 PHP 的配置文件，修改部分参数，更改 <strong>cgi.fix_pathinfo</strong> 的值为 0，以避免遭受恶意脚本注入的攻击。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /site/php/conf/php.ini</span><br><span class="line">cgi.fix_pathinfo=0</span><br></pre></td></tr></table></figure><h3 id="PHP-FPM- 配置文件"><a href="#PHP-FPM- 配置文件" class="headerlink" title="PHP-FPM 配置文件"></a>PHP-FPM 配置文件 </h3><p> 在 PHP 的安装目录中，找到 etc 目录【如果在一开始的 configure 时没有显示指定 PHP 的安装目录，默认安装在 /usr/local/php 中，则需要到此目录下寻找 etc 目录，而我指定了 PHP 的安装目录 /site/php/】，复制 PHP-FPM 模块的配置文件 <strong>php-fpm.conf.default</strong>，内容不需要更改。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- PHP 的附加模块的配置默认安装在了 etc 目录下 </span><br><span class="line">cd /site/php/etc</span><br><span class="line">cp php-fpm.conf.default php-fpm.conf</span><br></pre></td></tr></table></figure><p>在上面的 etc 目录中，继续复制 PHP-FPM 模块的默认配置文件。因为在上述的配置文件 <strong>php-fpm.conf</strong> 中，指定了 <strong>include=/site/php/etc/php-fpm.d/*.conf</strong>，也就是会从此目录 <strong>/site/php/etc/php-fpm.d/</strong> 加载多份有效的配置文件，至少要有一份存在，否则后续启动 PHP-FPM 的时候会报错。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 先直接使用模板，不改配置参数，后续需要更改用户和组 </span><br><span class="line">cp php-fpm.d/www.conf.default php-fpm.d/www.conf</span><br></pre></td></tr></table></figure><p>配置完成后，开始启动 PHP-FPM 模块，在 PHP 的安装目录中执行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-- PHP 的附加模块的脚本默认安装在了 sbin 目录下 </span><br><span class="line">-- 为了方便可以添加环境变量，把 sbin、bin 这 2 个目录都加进去 </span><br><span class="line">cd /site/php</span><br><span class="line">-- 配置文件合法性测试 </span><br><span class="line">./sbin/php-fpm -t</span><br><span class="line">-- 启动，现在还不能使用 service php-fpm start 的方式，因为没有把此模块配置到系统里面 </span><br><span class="line">./sbin/php-fpm</span><br><span class="line">-- 检验是否启动 </span><br><span class="line">ps aux|grep php-fpm</span><br></pre></td></tr></table></figure><p>配置文件合法性检测 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g167zej3snj20ja02t0sm.jpg" alt="配置文件合法性检测" title="配置文件合法性检测"></p><p> 可以看到正常启动了 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g167zqai4zj20nb03zt8s.jpg" alt="PHP-FPM 启动成功" title="PHP-FPM 启动成功"></p><p> 那怎么关闭以及重启呢，PHP 5.3.3 以后的 PHP-FPM 模块不再支持 PHP-FPM 以前具有的 <strong>./sbin/php-fpm (start|stop|reload)</strong> 等命令，所以不要再看这种古老的命令了，需要使用信号控制：</p><ul><li>INT，TERM，立刻终止 </li><li>QUIT 平滑终止</li><li>USR1 重新打开日志文件</li><li>USR2 平滑重载所有 worker 进程并重新载入配置和二进制模块</li></ul><p> 注意，这里的信号标识和 Unix 系统中的一样，被 kill 命令所使用，其中 USR1、USR2 是用户自定义信号，PHP-FPM 模块需要自定义实现，仅供参考。</p><p>其中，根据 Unix 基础知识，INT【2】表示中断信号，等价于 Ctrl + C，TERM【15】表示终止信号【清除后正常终止，不同于编号 9 KILL 的强制终止而不清除】，QUIT【3】表示退出信号，等价于 Ctrl + \，USR1【10】、USR2【12】这 2 个表示用户自定义信号。</p><p>所以可以使用命令 <strong>kill -INT pid</strong> 来停止 PHP-FPM 模块，pid 的值可以使用 <strong>ps aux|grep php-fpm</strong> 获取。当然，也可以使用 <strong>kill -INT pid 配置文件路径 </strong>来停止 PHP-FPM 模块，pid 配置文件路径 可以在 php-fpm.conf 中查看，<strong>pid 参数 </strong>，默认是关闭的。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1681vrhobj20om071mxh.jpg" alt="使用信号控制的方式停止 PHP-FPM" title="使用信号控制的方式停止 PHP-FPM"></p><p>为了能使用 <strong>service php-fpm start|stop|restart|reload)</strong> 的方式来进行启动、停止、重启、重载配置，这种方式显得优雅，需要把此模块配置到系统里面。在 PHP 的编译安装目录，复制文件 <strong>sapi/fpm/init.d.php-fpm</strong> ，粘贴到系统指定的目录即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /site/php-7.0.0</span><br><span class="line">-- 复制文件 </span><br><span class="line">cp sapi/fpm/init.d.php-fpm/etc/init.d/php-fpm</span><br><span class="line">-- 添加执行权限 </span><br><span class="line">chmod +x /etc/init.d/php-fpm</span><br><span class="line">-- 添加服务 </span><br><span class="line">chkconfig --add php-fpm</span><br></pre></td></tr></table></figure><p><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g16828okbij20nq06zaaf.jpg" alt="使用 service 操作 PHP-FPM" title="使用 service 操作 PHP-FPM"></p><h3 id="Nginx- 的配置文件"><a href="#Nginx- 的配置文件" class="headerlink" title="Nginx 的配置文件"></a>Nginx 的配置文件 </h3><p> 接下来就是更改 Nginx 的配置文件，让 Nginx 支持 PHP 请求，并且同时设置好反向代理，把请求转给 PHP-FPM 模块处理【前提是在不影响 html 请求的情况下】，在 server 中增加一个配置 location。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-- 打开配置文件 </span><br><span class="line">vi /etc/nginx/nginx.conf</span><br><span class="line">-- 更改 server 模块的内容，增加 php 的配置 </span><br><span class="line">-- 80 端口就不用管了，直接在 443 端口下配置 </span><br><span class="line">location ~* \.php$ &#123;</span><br><span class="line">      fastcgi_index   index.php;</span><br><span class="line">      fastcgi_pass    127.0.0.1:9000;</span><br><span class="line">      include         fastcgi_params;</span><br><span class="line">      fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;</span><br><span class="line">      fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;</span><br><span class="line">    &#125;</span><br><span class="line">-- 重新加载 nginx 配置，不需要重启 </span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><p>这样配置好，就会把所有的 PHP 请求转给 PHP-FPM 模块处理，同时并不会影响原来的 html 请求。</p><h3 id="额外优化配置项"><a href="# 额外优化配置项" class="headerlink" title="额外优化配置项"></a>额外优化配置项 </h3><p> 此外，还有一些环境变量配置、开机启动配置，这里就不再赘述了，这些配置好了可以方便后续的命令简化，不配置也是可以的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- 设置开机启动的 chkconfig 方法，以下是添加服务 </span><br><span class="line">cp sapi/fpm/init.d.php-fpm/etc/init.d/php-fpm</span><br><span class="line">chmod +x /etc/init.d/php-fpm</span><br><span class="line">chkconfig --add php-fpm</span><br><span class="line">-- 设置开机启动 </span><br><span class="line">chkconfig php-fpm on</span><br><span class="line">-- 添加环境变量，之后 php 的相关命令就可以直接使用了 </span><br><span class="line">vi /etc/profile</span><br><span class="line">export PATH=$PATH:/site/php/bin:/site/php/sbin</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h1 id="PHP- 脚本"><a href="#PHP- 脚本" class="headerlink" title="PHP 脚本"></a>PHP 脚本 </h1><p> 先在静态站点的根目录下，添加默认的 index.php 文件，用来测试，内容如下，内容的意思是输出 PHP 的所有信息。注意，PHP 文件的格式是以 <strong>&lt;?php</strong> 开头，以 <strong>?&gt;</strong> 结尾。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi index.php</span><br><span class="line">&lt;?php phpinfo (); ?&gt;</span><br></pre></td></tr></table></figure><p>打开浏览器访问，可以看到成功，这就代表着 PHP 与 Nginx 的配置都没有问题，已经能正常提供服务。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1685gzg77j21hk0s6did.jpg" alt="成功访问 index.php" title="成功访问 index.php"></p><p>接下来就来测试一下复杂的脚本，可以用来自动拉取 GitHub 的提交。再创建一个 auto_pull.php 文件，内容如下，会自动到执行目录拉取 GitHub 的更新，这样就能实现镜像的自动更新了，还加入了秘钥验证【先不用管功能性是否可用，而是先测试一下复杂的 PHP 脚本能不能正常执行，脚本内容后续还要优化更改】，内容大致如下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">vi auto_pull.php</span><br><span class="line">&lt;?php</span><br><span class="line">// 生产环境 web 目录 </span><br><span class="line">$target = &apos;/site/iplaypi.github.io&apos;;</span><br><span class="line">// 密钥，验证 GitHub 的请求 </span><br><span class="line">$secret = &quot;test666&quot;;</span><br><span class="line">// 获取 GitHub 发送的内容 </span><br><span class="line">$json = file_get_contents (&apos;php://input&apos;);</span><br><span class="line">$content = json_decode ($json, true);</span><br><span class="line">// GitHub 发送过来的签名 </span><br><span class="line">$signature = $_SERVER [&apos;HTTP_X_HUB_SIGNATURE&apos;];</span><br><span class="line">if (!$signature) &#123;</span><br><span class="line">   return http_response_code (404);</span><br><span class="line">&#125;</span><br><span class="line">list ($algo, $hash) = explode (&apos;=&apos;, $signature, 2);</span><br><span class="line">// 计算签名 </span><br><span class="line">$payloadHash = hash_hmac ($algo, $json, $secret);</span><br><span class="line">// 获取分支名字 </span><br><span class="line">$branch = $content [&apos;ref&apos;];</span><br><span class="line">// 判断签名是否匹配，分支是否匹配 </span><br><span class="line">if ($hash === $payloadHash &amp;&amp; &apos;refs/heads/master&apos; === $branch) &#123;</span><br><span class="line">    $cmd = &quot;cd $target &amp;&amp; git pull&quot;;</span><br><span class="line">    $res = shell_exec ($cmd);</span><br><span class="line">    $res_log = &apos;Success:&apos;.PHP_EOL;</span><br><span class="line">    $res_log .= $content [&apos;head_commit&apos;][&apos;committer&apos;][&apos;name&apos;] . &apos; 在 & apos; . date (&apos;Y-m-d H:i:s&apos;) . &apos; 向 & apos; . $content [&apos;repository&apos;][&apos;name&apos;] . &apos; 项目的 & apos; . $content [&apos;ref&apos;] . &apos; 分支 push 了 & apos; . count ($content [&apos;commits&apos;]) . &apos; 个 commit：&apos; . PHP_EOL;</span><br><span class="line">    $res_log .= $res.PHP_EOL;</span><br><span class="line">    $res_log .= &apos;=======================================================================&apos;.PHP_EOL;</span><br><span class="line">    echo $res_log;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $res_log  = &apos;Error:&apos;.PHP_EOL;</span><br><span class="line">    $res_log .= $content [&apos;head_commit&apos;][&apos;committer&apos;][&apos;name&apos;] . &apos; 在 & apos; . date (&apos;Y-m-d H:i:s&apos;) . &apos; 向 & apos; . $content [&apos;repository&apos;][&apos;name&apos;] . &apos; 项目的 & apos; . $content [&apos;ref&apos;] . &apos; 分支 push 了 & apos; . count ($content [&apos;commits&apos;]) . &apos; 个 commit：&apos; . PHP_EOL;</span><br><span class="line">    $res_log .= &apos; 密钥不正确或者分支不是 master, 不能 pull&apos;.PHP_EOL;</span><br><span class="line">    $res_log .= &apos;=======================================================================&apos;.PHP_EOL;</span><br><span class="line">    echo $res_log;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>接下来先手工测试一下 PHP 文件的访问是否正常，可以使用 curl 模拟请求，或者直接使用 GitHub 的 WebHooks 请求。我这里为了简单，先使用 curl 命令来测试，后续的步骤才使用 GitHub 来真正测试。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &apos;X-Hub-Signature:test&apos;  https://blog.playpi.org/auto_pull.php</span><br></pre></td></tr></table></figure><p>可以看到，访问正常，先不管功能上能不能正常实现，至少保证 PHP 可以正常提供服务，后面会和 GitHub 对接。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g168ab7ih9j20r206awep.jpg" alt="使用 curl 模拟访问正常" title="使用 curl 模拟访问正常"></p><h1 id="测试 -WebHooks- 效果"><a href="# 测试 -WebHooks- 效果" class="headerlink" title="测试 WebHooks 效果"></a>测试 WebHooks 效果 </h1><p> 在 GitHub 中使用 WebHooks，为了表现出它的效果是什么样，我画了一个流程图，可以直观地看到它优雅的工作方式。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g168bmzii3j20lo0jwwfi.jpg" alt="WebHooks 效果流程图" title="WebHooks 效果流程图"></p><p>在上一步骤中，自动拉取更新的脚本已经写好，并且使用 curl 测试过模拟访问可用，那接下来就测试功能是否可用，当然，踩坑是避免不了的，优化脚本内容也是必要的。特别要注意用户权限和脚本内容这两方面，用户权限方面我直接使用 nginx 用户，踩坑比较少，脚本内容方面要保证你的服务器支持 <strong>shell_exec ()</strong> 这个 PHP 函数，可以在 <strong>index.php</strong> 文件中加一段代码 <strong>echo shell_exec (‘ls -la’);</strong>，测试一下。我的机器经过测试时支持的。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g168e04yz0j21hk0s6gs3.jpg" alt="测试 shell_exec 函数" title="测试 shell_exec 函数"></p><h2 id="在 -GitHub- 设置 -WebHooks"><a href="# 在 -GitHub- 设置 -WebHooks" class="headerlink" title="在 GitHub 设置 WebHooks"></a>在 GitHub 设置 WebHooks</h2><p>在 GitHub 对应项目的设置【Settings】中，找到 <strong>Webhooks</strong> 选项，可以看到已经有一些设置完成的 WebHook，这里面就包括 travis-ci 的自动构建配置。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1691o58jij20ty0en755.jpg" alt="Webhooks 列表" title="Webhooks 列表"></p><p>然后点击新建按钮，创建一个新的 WebHook【这个过程需要重新填写密码确认】，填写必要的参数，url 地址、秘钥、触发的事件，然后确认保存即可。注意，秘钥只是为了测试使用，实际应用时请更改，包括 WebHooks 的秘钥设置和 PHP 脚本里面的秘钥字符串。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1692ybibgj20su0qxgn6.jpg" alt="新建 WebHook" title="新建 WebHook"></p><p>如果是第一次创建完成，还没有触发请求的历史记录，可以先手动在 master 分支做一次变更提交，然后就会触发一次 WebHooks 事件。我这里已经有触发历史了，拿一个出来看就行了。注意，为了方便测试，只要有一次请求就行了，因为如果后续更改了脚本，不用再手动向 master 分支做一次变更提交，可以直接点击重新发送【redeliver】。<br>触发请求的信息，就是 http 请求头和请求体 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1694gk8tdj20pl0pi3zt.jpg" alt="WebHook 触发请求携带的信息" title="WebHook 触发请求携带的信息"></p><p>VPS 的 PHP 后台服务返回的信息，可以看到正常处理了 WebHooks 请求，但是没有做拉取更新的操作，原因可能是秘钥不对或者分支不对。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1694ke4dbj20or0judgk.jpg" alt="PHP 后台服务返回的信息" title="PHP 后台服务返回的信息"></p><h2 id="测试功能是否可用"><a href="# 测试功能是否可用" class="headerlink" title="测试功能是否可用"></a> 测试功能是否可用 </h2><p> 以下内容所需要的 PHP 脚本：index.php、auto_pull.php 。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo shell_exec (&quot;id -a&quot;);</span><br><span class="line">echo shell_exec (&apos;ls -la&apos;);</span><br><span class="line">phpinfo ();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// 生产环境 web 目录 </span><br><span class="line">$target = &apos;/site/iplaypi.github.io&apos;;</span><br><span class="line">// 密钥，验证 GitHub 的请求 </span><br><span class="line">$secret = &quot;test666&quot;;</span><br><span class="line">// 获取 GitHub 发送的内容，解析 </span><br><span class="line">$json = file_get_contents (&apos;php://input&apos;);</span><br><span class="line">$content = json_decode ($json, true);</span><br><span class="line">// GitHub 发送过来的签名，一定要大写，虽然 http 请求里面是驼峰法命名的 </span><br><span class="line">$signature = $_SERVER [&apos;HTTP_X_HUB_SIGNATURE&apos;];</span><br><span class="line">if (!$signature) &#123;</span><br><span class="line">   return http_response_code (404);</span><br><span class="line">&#125;</span><br><span class="line">// 使用等号分割，得到算法和签名 </span><br><span class="line">list ($algo, $hash) = explode (&apos;=&apos;, $signature, 2);</span><br><span class="line">// 在本机计算签名 </span><br><span class="line">$payloadHash = hash_hmac ($algo, $json, $secret);</span><br><span class="line">// 获取分支名字 </span><br><span class="line">$branch = $content [&apos;ref&apos;];</span><br><span class="line">// 日志内容 </span><br><span class="line">$logMessage = &apos;[&apos; . $content [&apos;head_commit&apos;][&apos;committer&apos;][&apos;name&apos;] . &apos;] 在 [&apos; . date (&apos;Y-m-d H:i:s&apos;) . &apos;] 向项目 [&apos; . $content [&apos;repository&apos;][&apos;name&apos;] . &apos;] 的分支 [&apos; . $content [&apos;ref&apos;] . &apos;] push 了 [&apos; . count ($content [&apos;commits&apos;]) . &apos;] 个 commit&apos; . PHP_EOL;</span><br><span class="line">$logMessage .= &apos;ret:[&apos; . $content [&apos;ref&apos;] . &apos;],payloadHash:[&apos; . $payloadHash . &apos;]&apos; . PHP_EOL;</span><br><span class="line">// 判断签名是否匹配，分支是否匹配 </span><br><span class="line">if ($hash === $payloadHash &amp;&amp; &apos;refs/heads/master&apos; === $branch) &#123;</span><br><span class="line">    // 增加执行脚本日志重定向输出到文件 </span><br><span class="line">    $cmd = &quot;cd $target &amp;&amp; git pull&quot;;</span><br><span class="line">    $res = shell_exec ($cmd);</span><br><span class="line">    $res_log = &apos;Success:&apos; . PHP_EOL;</span><br><span class="line">    $res_log .= $logMessage;</span><br><span class="line">    $res_log .= $res . PHP_EOL;</span><br><span class="line">    $res_log .= &apos;=======================================================================&apos;.PHP_EOL;</span><br><span class="line">    echo $res_log;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $res_log  = &apos;Error:&apos; . PHP_EOL;</span><br><span class="line">    $res_log .= $logMessage;</span><br><span class="line">    $res_log .= &apos; 密钥不正确或者分支不是 master, 不能 pull&apos; . PHP_EOL;</span><br><span class="line">    $res_log .= &apos;=======================================================================&apos;.PHP_EOL;</span><br><span class="line">    echo $res_log;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>上面已经测试了访问正常，但是为了保证 PHP 脚本的功能正常执行，接下来要优化 PHP 脚本内容了。我分析一下，根据脚本的内容，只有当秘钥正确并且当前变更的分支是 master 时才会执行拉取更新操作，看返回结果也是这样的。当前没有执行拉取更新的操作，但是我的这一个触发通知里面是表明了 master 分支【根据 ref 参数】，那就是秘钥的问题了，需要详细看一下秘钥计算的那段 PHP 代码。如果怕麻烦，直接把加密这个流程去掉【会导致恶意请求，浪费 CPU 资源】，GitHub 并没有要求一定要填写秘钥，但是我为了安全，仍旧填写。</p><p>我看了一下代码，并没有发现问题，于是加日志把后台处理的一些结果返回，看看哪里出问题了。最终发现竟然是分支名字的问题，PHP 代码通过 <strong>$content</strong> 没有获取到任何内容，包括分支名字、项目名字、提交信息等，而秘钥签名的处理是正常的。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1697xx5vaj20nl0g00tb.jpg" alt="错误日志返回" title="错误日志返回"></p><p>思考了一下，然后我就发现，竟然是创建 WebHooks 的时候内容传输类型【Content type】设置错误，不能使用默认的，要设置为 <strong>application/json</strong>，否则后台的 PHP 代码处理不了内容解析，获取的全部是空内容。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g1699fp81lj20uf0oiwg0.jpg" alt="内容传输类型设置错误" title="内容传输类型设置错误"></p><p>好，一切准备就绪，再来试一次，问题又来了，果然用户权限问题是逃不了的。这个问题我早有防备，本质就是没有设置好 PHP 的用户，导致 PHP 执行脚本的时候，没有权限获取与 Git 有关的信息【执行脚本的用户没有自己的家目录，也没有存储 ssh 认证信息】。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g169b32samj20pj0hpwf4.jpg" alt="PHP 执行权限问题" title="PHP 执行权限问题"></p><p>接下来就简单了，去设置 PHP 的执行用户，可能还要涉及到 Nginx。先在原先的 <strong>index.php</strong> 脚本中增加内容 <strong>echo shell_exec (“id -a”);</strong>，用来输出当前用户信息，发现是 nobody，那就和我想的一样了。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g169d8f9fbj20sa0fsdi8.jpg" alt="输出 PHP 的执行用户信息" title="输出 PHP 的执行用户信息"></p><p>为了规范起来便于管理，还是改为和 Nginx 同一个用户比较好，还记得 PHP-FPM 模块的配置文件吗 <strong>/site/php/etc/php-fpm.d/www.conf </strong>，去里面找到用户和组的配置项 <strong>user、group</strong>，把 nobody 改为 nginx。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g169e1crm2j20gl02qwec.jpg" alt="设置 PHP-FPM 的用户名和组" title="设置 PHP-FPM 的用户名和组"></p><p>为什么选择 nginx 用户呢，因为我的 Nginx 服务使用的就是 nginx 用户，这样就不用再创建一个用户了，可以去配置文件 <strong>/etc/nginx/nginx.conf</strong> 里面查看。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g169fau9zzj20c806amx2.jpg" alt="查看 Nginx 的用户" title="查看 Nginx 的用户"></p><p>其实，用户的设置是随意的，如果把 PHP-FPM 的用户设置为 root 更方便，但是这样有很大风险，所以不要这么做。如果非要使用 nobody 也是可以的，我只是为了方便管理用户，和 Nginx 服务共同使用一个用户。一切配置完成后别忘记重启 PHP-FPM 模块。</p><p>接着就是最重要的步骤了，把本地的 GitHub 项目所属用户设置为 nginx，并且保证 nginx 用户的家目录有 ssh 认证相关的秘钥信息，这样在以后的自动拉取更新时才能畅通无阻。我把原先的项目删掉，然后使用 sudo 命令给 nginx 用户生成 ssh 认证信息，并且重新克隆项目，克隆的同时指定所属用户为 nginx。【由于用户 nginx 没有登录 Shell 的权限，所以不能直接使用 nginx 用户登录后再操作的方式解决】</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- 目录不存在先创建，赋给 nginx 用户权限 </span><br><span class="line">mkdir -p /home/nginx/.ssh/</span><br><span class="line">chown nginx:nginx -R /home/nginx/.ssh/</span><br><span class="line">-- H 参数表示设置家目录环境，u 参数表示用户名 </span><br><span class="line">cd /site/</span><br><span class="line">sudo -Hu nginx ssh-keygen -t rsa -C &quot;plapyi@qq.com&quot;</span><br><span class="line">sudo -Hu nginx git clone https://github.com/iplaypi/iplaypi.github.io.git</span><br><span class="line">-- 如果没有 iplaypi.github.io 目录的权限，也要赋予 nginx 用户 </span><br><span class="line">mkdir iplaypi.github.io</span><br><span class="line">chown nginx:nginx iplaypi.github.io</span><br></pre></td></tr></table></figure><p>好，一切准备就绪，我再来试一次。可以看到，完美执行，热泪盈眶。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g169gkpo0cj20s30nfgmm.jpg" alt="解决所有问题后成功实现自动拉取" title="解决所有问题后成功实现自动拉取"></p><p>为了方便，本来我把这 2 个 php 文件直接放在项目里面了，放在 source 分支，再更新一下 travis-ci 的配置文件，把它们提交到 master 分支去。但是这样做的风险就是把秘钥暴露出去了，显然不可取，所以折中的办法就是把这 2 个文件当做模板，把秘钥隐去，放在 source 分支，以后用的时候直接复制就行了。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;我的静态博客为了百度爬虫单独部署了一个镜像，放在了我的 VPS 上面【在 vultr 购买的主机】，并单独设置了二级域名 blog.playpi.org。但是，每次 GitHub 有新的提交时【基本每周都会有至少三次提交】，为了及时更新，我都会登录到 VPS 上面，到指定的项目下做一下拉取更新的操作，即执行 &lt;strong&gt;git pull&lt;/strong&gt;。这样操作了三五次，我就有点不耐烦了，自己身为做技术的人，怎么能忍受这个呢，做法既低效又不优雅。于是，我就在想有没有更好的方法来实现自动拉取更新。一开始想到，直接在 VPS 起一个周期性脚本不就行了，比如每隔 1 分钟自动执行 &lt;strong&gt;git pull&lt;/strong&gt;，但是立马又被我否定了，虽然做法很简单，但是太不优雅了，而且极大浪费 CPU。后来想到，GitHub 自带了 WebHooks 功能，概念类似于回调钩子，可以给 GitHub 的项目设置各种各样的行为，满足一定的场景才会触发【例如当有新的 push 时，就会向设置的 url 发送请求，并且在请求体中携带 push 的相关信息】。我的自动化构建就是这样的原理，每当 source 分支有提交时，都会通知 tavis-ci【这就是一个行为】，然后在 travis-ci 中设置好脚本，自动运行脚本，就完成了自动生成、部署的操作。&lt;/p&gt;&lt;p&gt;根据这个思路，就可以给 GitHub 的项目设置一个 WebHooks，每当 master 分支有提交时【代表着静态博客有更新了】，会根据设置的链接自动发送消息到 VPS 上面，然后 VPS 再执行拉取更新，这样的话就优雅多了。但是问题又来了，满足这种场景还需要在 VPS 设置一个后台服务，用来接收 GitHub 的消息通知并执行拉取更新的操作。我想了一下，既然 VPS 上面已经起了 Nginx 服务，那就要充分利用起来，给 Nginx 设置好反向代理，把指定的请求转给另外一个服务就行了。那这个服务怎么选呢，当然是选择 PHP 后台了，毕竟 PHP 号称世界上最好的语言， PHP 后台搭建起来也容易。本文就记录从基础环境安装配置到成功实现自动拉取更新的整个过程，本文涉及的系统环境是 CentOS 7 x64，软件版本会在操作中具体指明。&lt;/p&gt;
    
    </summary>
    
      <category term="建站" scheme="https://www.playpi.org/categories/building/"/>
    
    
      <category term="Git" scheme="https://www.playpi.org/tags/Git/"/>
    
      <category term="Github" scheme="https://www.playpi.org/tags/Github/"/>
    
      <category term="PHP" scheme="https://www.playpi.org/tags/PHP/"/>
    
      <category term="WebHooks" scheme="https://www.playpi.org/tags/WebHooks/"/>
    
      <category term="自动更新" scheme="https://www.playpi.org/tags/%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/"/>
    
      <category term="钩子" scheme="https://www.playpi.org/tags/%E9%92%A9%E5%AD%90/"/>
    
  </entry>
  
  <entry>
    <title>Nginx 配置 SSL 证书实现 HTTPS 访问</title>
    <link href="https://www.playpi.org/2019030501.html"/>
    <id>https://www.playpi.org/2019030501.html</id>
    <published>2019-03-04T18:14:23.000Z</published>
    <updated>2019-03-04T18:14:23.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>由于 GitHub Pages 把百度爬虫屏蔽了，导致百度爬虫爬取不到我的个人主页，所以被百度收录的内容很少，能收录的基本都是我手动提交的。后来我的解决办法就是自己搭建了一台 Web 服务器，然后在 DNSPod 中把百度爬虫的访问流量引到我的 Web 服务器上面，服务器主机是我自己购买的 VPS，服务器应用我选择的是强大的 Nginx。本文就记录 Web 服务器搭建以及配置 SSL 证书这个过程。</p><a id="more"></a><h1 id="安装 -Nginx"><a href="# 安装 -Nginx" class="headerlink" title="安装 Nginx"></a>安装 Nginx</h1><p>Nginx 官方网站：<a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/install" target="_blank" rel="noopener">https://www.nginx.com/resources/wiki/start/topics/tutorials/install</a> 。</p><p>我的 VPS 是 CentOS 7 X64 版本的，所以安装 Nginx 的过程比较麻烦一点，需要自己下载源码、编译、安装，如果需要用到附加模块【例如 http_ssl 证书模块】，还需要重新编译，整个过程比较耗时。如果不熟悉的话，遇到问题也要折腾半天才能解决。所以，我在不熟悉的 Nginx 的情况下选择了一种简单的方式，直接自动安装，并自带了一些常用的模块，例如 ssl 证书模块。但是缺点就是安装过程稍微长一点，在网络好的情况下可能需要 3-5 分钟。我还参考了别人的文档：<a href="https://gist.github.com/ifels/c8cfdfe249e27ffa9ba1" target="_blank" rel="noopener">https://gist.github.com/ifels/c8cfdfe249e27ffa9ba1</a> ，但是仅供参考，因为我发现也有一些不能使用的地方。</p><h2 id="创建源配置文件"><a href="# 创建源配置文件" class="headerlink" title="创建源配置文件"></a>创建源配置文件 </h2><p> 在 /etc/yum.repos.d/ 目录下创建一个源配置文件 nginx.repo，如果不存在这个目录，先使用 mkdir 命令创建目录，然后在目录中添加一个文件 nginx.repo，使用命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi nginx.repo</span><br></pre></td></tr></table></figure><p>进入编辑模式，填写如下内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[nginx]</span><br><span class="line">name=nginx repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure><p>编辑完成后保存即可。</p><h2 id="自动安装 -Nginx"><a href="# 自动安装 -Nginx" class="headerlink" title="自动安装 Nginx"></a>自动安装 Nginx</h2><p>接下来就是使用命令自动安装 Nginx 了【敲下命令，看着就行了，会有刷屏的日志输出】：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx -y</span><br></pre></td></tr></table></figure><p>安装完成后，使用以下命令启动：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service nginx start</span><br></pre></td></tr></table></figure><p>可以使用命令 <strong>service nginx status</strong> 查看 Nginx 是否启动：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0tj7nqpidj20pi085jrs.jpg" alt="查看 Nginx 状态" title="查看 Nginx 状态"></p><p>然后你就能看到 Nginx 的主页了，默认是 80 端口，直接使用 ip 访问即可【如果这里打不开，可能是端口 80 没有开启，被防火墙禁用了，需要重新开启，开启方法参考后面的章节】。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0tj9c3v7aj20hw075t92.jpg" alt="Nginx 主页" title="Nginx 主页"></p><h1 id="获取 -SSL- 证书、配置参数"><a href="# 获取 -SSL- 证书、配置参数" class="headerlink" title="获取 SSL 证书、配置参数"></a>获取 SSL 证书、配置参数 </h1><h2 id="SSL- 证书获取"><a href="#SSL- 证书获取" class="headerlink" title="SSL 证书获取"></a>SSL 证书获取</h2><p> 证书的获取可以参考我的文章：<a href="https://www.playpi.org/2019030401.html">利用阿里云申请免费的 SSL 证书 </a>。我在阿里云获取的证书是免费的、有效期一年的，等证书过期了可以重新申请【不知道能不能自动续期】，因为我有阿里云的帐号，所以就直接使用了。当然，通过其它方式也可以获取 SSL 证书，大家自行选择。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0tj9zp4g1j21hc0qx0ub.jpg" alt="阿里云申请的 SSL 证书" title="阿里云申请的 SSL 证书"></p><p> 直接下载即可，下载后上传到站点的任意目录，但是要记住文件的位置，因为等一下配置 Nginx 的时候需要指定证书的位置。我把它们放在了 /site/ 目录，一共有 2 个文件：.key 文件时私钥文件，.pem 文件时公钥文件。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0tjanlqz3j20o80dbaav.jpg" alt="SSL 证书的 2 个文件" title="SSL 证书的 2 个文件"></p><h2 id="Nginx- 参数配置"><a href="#Nginx- 参数配置" class="headerlink" title="Nginx 参数配置"></a>Nginx 参数配置 </h2><p> 更改配置文件，打开文件【使用 vi 命令会自动创建不存在的文件】，进入编辑模式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 配置 </span><br><span class="line">vi /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><p>填写内容如下【我这里只是配置基本的参数 server 有关内容，大家当然可以根据实际需要配置更为丰富的参数】，留意证书的公钥与私钥这 2 个文件的配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 80 端口是用来接收基本的 http 请求，里面做了永久重定向，重定向到 https 的链接 </span><br><span class="line">    server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  blog.playpi.org;</span><br><span class="line">    access_log   /site/iplaypi.github.io.http-blog-access.log  main;</span><br><span class="line">    rewrite ^/(.*)$ https://blog.playpi.org/$1 permanent;</span><br><span class="line">    &#125;</span><br><span class="line"># 443 端口是用来接收 https 请求的 </span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;# 监听端口 </span><br><span class="line">    server_name blog.playpi.org;# 域名 </span><br><span class="line">    access_log   /site/iplaypi.github.io.https-blog-access.log  main;</span><br><span class="line">    root         /site/iplaypi.github.io;</span><br><span class="line">    ssl_certificate /site/1883927_blog.playpi.org.pem;# 证书路径 </span><br><span class="line">    ssl_certificate_key /site/1883927_blog.playpi.org.key;#key 路径 </span><br><span class="line">    ssl_session_cache shared:SSL:1m;# 储存 SSL 会话的缓存类型和大小 </span><br><span class="line">    ssl_session_timeout 5m;# 配置会话超时时间 </span><br><span class="line">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;# 为建立安全连接，服务器所允许的密码格式列表 </span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    ssl_prefer_server_ciphers on;# 依赖 SSLv3 和 TLSv1 协议的服务器密码将优先于客户端密码 </span><br><span class="line">    #减少点击劫持 </span><br><span class="line">    add_header X-Frame-Options DENY;</span><br><span class="line">    #禁止服务器自动解析资源类型 </span><br><span class="line">    add_header X-Content-Type-Options nosniff;</span><br><span class="line">    #防 XSS 攻击 </span><br><span class="line">    add_header X-Xss-Protection 1;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>只要按照如上的配置，就可以同时接收 http 请求与 https 请求【实际上 http 的请求被永久重定向到了 https】，我的配置如下图【请忽略 www 二级域名的配置项】：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0tjbahmnzj20rm0kv75t.jpg" alt="Nginx 配置项 server" title="Nginx 配置项 server"></p><h2 id="验证参数是否准确"><a href="# 验证参数是否准确" class="headerlink" title="验证参数是否准确"></a>验证参数是否准确 </h2><p> 有时候配置了参数，可能因为字符、参数名问题导致启动失败，然后再回来改配置文件，比较繁琐，所以可以直接使用 Nginx 提供的命令来验证配置文件的内容是否合法，如果有问题可以在输出警告日志中看到，改起来也非常方便。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br></pre></td></tr></table></figure><p>可以看到，配置项正常，接下来就可以启动 Nginx 了。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0tjbrqeeuj20f603cglj.jpg" alt="Nginx 配置项检测" title="Nginx 配置项检测"></p><h1 id="开启端口、启动 -Nginx"><a href="# 开启端口、启动 -Nginx" class="headerlink" title="开启端口、启动 Nginx"></a>开启端口、启动 Nginx</h1><p>在上面的步骤中，如果在一开始想启动 Nginx，虽然启动成功了，但是却访问不了 Nginx 的主页，那很大可能是服务器的端口没有开启，导致访问请求被拒绝，所以需要适当开启必要的端口【如果没有安装防火墙工具 firewall 请自行安装】。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 查看已经开启的端口 </span><br><span class="line">firewall-cmd --list-ports</span><br><span class="line"># 开启端口 80</span><br><span class="line">firewall-cmd --permanent --zone=public --add-port=80/tcp</span><br><span class="line"># 开启端口 443</span><br><span class="line">firewall-cmd --permanent --zone=public --add-port=443/tcp</span><br><span class="line"># 重载更新的端口信息 </span><br><span class="line">firewall-cmd --reload</span><br><span class="line"># 这种方式可以，启动 Nginx</span><br><span class="line">service nginx start</span><br><span class="line"># 停止 Nginx</span><br><span class="line">service nginx stop</span><br><span class="line"># 如果需要重启，直接使用下面的更方便 </span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><p>大家看一下我的服务器的端口开启信息：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0tjc9ygu2j20bo02s0sl.jpg" alt="服务器端口开启情况" title="服务器端口开启情况"></p><h1 id="验证站点"><a href="# 验证站点" class="headerlink" title="验证站点"></a>验证站点 </h1><p> 打开站点 <a href="https://blog.playpi.org" target="_blank" rel="noopener">https://blog.playpi.org</a> ，可以愉快地访问了，可以看到 https 链接的绿锁。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0tjcrc2zbj21hk0s6n10.jpg" alt="安全的站点主页" title="安全的站点主页"></p><p>接着查看一下 SSL 证书的信息。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0tjd5kowxj20d60i90t0.jpg" alt="查看 SSL 证书信息" title="查看 SSL 证书信息"></p><h1 id="题外话"><a href="# 题外话" class="headerlink" title="题外话"></a>题外话 </h1><h2 id="重定向问题思考"><a href="# 重定向问题思考" class="headerlink" title="重定向问题思考"></a> 重定向问题思考 </h2><p> 关于开启 https 的访问，我一开始也配置了 www 的二级域名，但是通过日志发现没有通过 301 重定向访问 <a href="https://www.playpi.org">https://www.playpi.org</a> 的请求，一直不明白原因。后来发现，因为做重定向的时候还是重定向到 GitHub 上面了。同理，如果使用 ip 直接访问，可以观察到自动跳转到 <a href="https://www.playpi.org">https://www.playpi.org</a> 了，查看证书还是 GitHub 的证书。所以后来直接把百度爬虫的请求转发到 blog 的二级域名还是明智的【www 的二级域名就不用自己再搞一套了】，否则百度爬虫还是抓取不到。如果百度爬虫直接使用 https 链接抓取还是可以的，但是看百度站长里面的说明，是通过 http 的 301 重定向抓取的。</p><h2 id="Nginx- 的 -https- 模块安装"><a href="#Nginx- 的 -https- 模块安装" class="headerlink" title="Nginx 的 https 模块安装"></a>Nginx 的 https 模块安装 </h2><p> 由于我使用的是简单小白的安装方式，不需要关心额外用到的模块，例如 http_ssl 模块，因为安装包里面自带了这个模块，可以使用 <strong>nginx -V</strong> 命令查看。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0uj2a8vf6j21gm08smxy.jpg" alt="http_ssl 模块查看" title="http_ssl 模块查看"></p><p>因此，如果大家有使用源码编译安装的方式，注意 https 模块不能缺失，否则不能开启 https 的方式。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;由于 GitHub Pages 把百度爬虫屏蔽了，导致百度爬虫爬取不到我的个人主页，所以被百度收录的内容很少，能收录的基本都是我手动提交的。后来我的解决办法就是自己搭建了一台 Web 服务器，然后在 DNSPod 中把百度爬虫的访问流量引到我的 Web 服务器上面，服务器主机是我自己购买的 VPS，服务器应用我选择的是强大的 Nginx。本文就记录 Web 服务器搭建以及配置 SSL 证书这个过程。&lt;/p&gt;
    
    </summary>
    
      <category term="建站" scheme="https://www.playpi.org/categories/building/"/>
    
    
      <category term="Nginx" scheme="https://www.playpi.org/tags/Nginx/"/>
    
      <category term="https" scheme="https://www.playpi.org/tags/https/"/>
    
      <category term="ssl" scheme="https://www.playpi.org/tags/ssl/"/>
    
      <category term="证书" scheme="https://www.playpi.org/tags/%E8%AF%81%E4%B9%A6/"/>
    
  </entry>
  
  <entry>
    <title>利用阿里云申请免费的 SSL 证书</title>
    <link href="https://www.playpi.org/2019030401.html"/>
    <id>https://www.playpi.org/2019030401.html</id>
    <published>2019-03-04T13:45:38.000Z</published>
    <updated>2019-03-04T13:45:38.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>在搭建博客的过程中，一开始是全部使用 GitHub，因为这样做就什么也不用考虑了，例如主机、带宽、SSL 证书，全部都交给 GitHub 了，自己唯一需要做的就是写 Markdown 文档。但是，后来发现 GitHub 把百度爬虫给禁止了，也就是百度爬虫爬取不到 GitHub 的内容，导致我的站点没有被百度收录。后来为了专门给百度爬虫搭建一条线路，自己搭建了一个镜像服务，也就是和 GitHub 上面的内容一模一样站点，是专门给百度爬虫使用的。而且，为了测试方便，在 DNSPod 中还增加了一条 blog 二级域名的解析记录，blog 的访问全导向自己的镜像，这样就可以方便观察部署是否成功。后来还把百度爬虫的 www 访问通过 CNANE 跳转到 blog 去，这样就不用单独再搞一个 www 了，因为挺麻烦的（域名解析线路问题、测试问题、证书确认问题，都挺麻烦）。而在这个过程中，就产生了使用阿里云申请免费的 SSL 证书这一流程（有效期一年），记录下来给大家参考。</p><a id="more"></a><h1 id="注册阿里云、开启实名认证"><a href="# 注册阿里云、开启实名认证" class="headerlink" title="注册阿里云、开启实名认证"></a>注册阿里云、开启实名认证 </h1><p> 这个步骤就不多说了，需要证书总得注册一个帐号吧，也方便后续管理。此外，国内的证书服务商都要求实名认证，这个也没办法。如果不想实名认证，可以使用开源的 <a href="https://letsencrypt.org" target="_blank" rel="noopener">Lets Encrypt</a> ，只不过有效期只能是 3 个月，也就是说每隔 3 个月就要更新一次，GitHub Pages 使用的就是它。阿里云的官网链接：<a href="https://www.aliyun.com" target="_blank" rel="noopener">https://www.aliyun.com</a> 。</p><h1 id="购买 -SSL- 证书"><a href="# 购买 -SSL- 证书" class="headerlink" title="购买 SSL 证书"></a>购买 SSL 证书 </h1><p>1、在阿里云系统找到关于 SSL 证书的服务，<strong> 产品与服务 </strong>-&gt;<strong> 安全（云盾）</strong>-&gt;<strong>SSL 证书（应用安全）</strong>。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4q5ikmnj21hc0q9gp7.jpg" alt="SSL 证书（应用安全）" title="SSL 证书（应用安全）"></p><p>2、进入后，点击右上角的 <strong> 购买证书 </strong>。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4qkt3cwj21hc0q9tal.jpg" alt="购买证书" title="购买证书"></p><p>3、按照我截图中的步骤 1、2、3 选择，这里需要注意，这个免费的选项隐藏的很深，直接勾选是不会出现的，要按照我标识的步骤来勾选才行，这里看到出现的费用很贵不用害怕，等一下接着选择对了就会免费的。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4qvpk2wj21hc0q9775.jpg" alt="正确的选择流程" title="正确的选择流程"></p><p>最终选择 <strong>免费型 DV SSL</strong>，按照我下图中的选项，可以看到费用是 0 元。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4r9iriij21hc0q9gob.jpg" alt="免费型 DV SSL" title="免费型 DV SSL"></p><p>选择后，下单即可，虽然要走购买流程，但是是不用付钱的。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4rjfjm2j21hc0q9jtw.jpg" alt="下单完成" title="下单完成"></p><h1 id="绑定证书信息、等待审核"><a href="# 绑定证书信息、等待审核" class="headerlink" title="绑定证书信息、等待审核"></a>绑定证书信息、等待审核 </h1><p>1、下单完成后开始 <strong> 申请 </strong>，这里的 <strong>申请 </strong>的意思是申请使用它，要填写一些基本的信息，包括个人信息和网站信息，后续还需要验证身份，看你有没有权限管理你配置的网站。如果不申请 <strong>使用 </strong>，证书其实就一直闲置在那里。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4rvewbsj21hc0q9jti.jpg" alt="申请使用证书" title="申请使用证书"></p><p>填写个人信息，主要就是我个人的联系方式。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4s5trvij21hc0q9dho.jpg" alt="填写个人信息" title="填写个人信息"></p><p>填写网站信息，由于我使用的是自己的服务器上面搭建的 Web 服务，既没有使用阿里云也没有使用其它云服务，所以我选择了 <strong>文件验证 </strong>，即需要把验证文件上传到我的域名对应的目录下面，用来证明这个站点是我管理的。当然，验证通过后，这个文件可以删除。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4serk53j21hc0q9q58.jpg" alt="文件验证" title="文件验证"></p><p>2、填写完成后，会生成一个文件 fileauthor.txt，我需要把这个文件下载下来，然后上传到我的服务器对应的目录中，才能点击 <strong>验证 </strong>按钮，如果通过了，说明这个站点就是我管理的，也就是一个权限验证。</p><p>由于在验证 www 证书对应的文件的时候，需要把 fileauthor.txt 文件上传到服务器，但是由于在 DNSPod 中设置的域名解析是解析到 GitHub 的（没有专门针对阿里的设置），所以总是验证失败。后来就干脆临时把所有的 www 解析都指向我自己的服务器，等通过了验证再改回去，整个过程很是折腾。折腾了一大圈，最后还发现了更简单的方法，直接放弃 www 证书的申请，在 DNSPod 中把百度的流量通过 CNAME 直接引到 blog 上面去就行了，这样只要维护一个 blog 的 Web 服务就行了。这样只需要增加一条解析，而且 blog 的证书验证过程也方便简单。</p><p>DNSPod 解析示例 <br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4srjg4xj21hc0q9ac4.jpg" alt="DNSPod 解析示例" title="DNSPod 解析示例"></p><p> 在这个过程中，我还发现验证过程需要一定的时间，一开始显示失败，但是不告诉我原因，还以为是自己的服务器的问题，重试了多种方法，包括重启 Web 服务。我等了十几分钟，证书就莫名其妙审核通过了，然后还发送了短信通知（到这里我猜测阿里云的 Web 界面显示的内容是滞后的，短信通知的内容才是实时的）。</p><p>证书申请成功，可以使用了。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4t1jlj7j21hc0q9mz2.jpg" alt="证书申请成功" title="证书申请成功"></p><h1 id="下载证书、上传到自己的服务器"><a href="# 下载证书、上传到自己的服务器" class="headerlink" title="下载证书、上传到自己的服务器"></a>下载证书、上传到自己的服务器 </h1><p> 下载证书、上传到自己的服务器这一步骤就不多说了，主要就是复制粘贴的工作。着重要说一下 Nginx 的配置，主要就是 server 属性的配置，由于我把 www、blog 这 2 个二级域名都保留了，所以需要分开配置。其实，这里配置的 www 的二级域名根本没有用，因为不会有流量过来的，重在测试证书的安装。Nginx 的配置内容参考（2 个子域名分开配置，有 2 份 SSL 证书）：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">    server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  www.playpi.org;</span><br><span class="line">    access_log   /site/iplaypi.github.io.http-www-access.log  main;</span><br><span class="line">    rewrite ^/(.*)$ https://www.playpi.org/$1 permanent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  blog.playpi.org;</span><br><span class="line">    access_log   /site/iplaypi.github.io.http-blog-access.log  main;</span><br><span class="line">    rewrite ^/(.*)$ https://blog.playpi.org/$1 permanent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">    listen 443 ssl;# 监听端口 </span><br><span class="line">    server_name www.playpi.org;# 域名 </span><br><span class="line">    access_log   /site/iplaypi.github.io.https-www-access.log  main;</span><br><span class="line">    root         /site/iplaypi.github.io;</span><br><span class="line">    ssl_certificate /site/1884603_www.playpi.org.pem;# 证书路径 </span><br><span class="line">    ssl_certificate_key /site/1884603_www.playpi.org.key;#key 路径 </span><br><span class="line">    ssl_session_cache shared:SSL:1m;# 储存 SSL 会话的缓存类型和大小 </span><br><span class="line">    ssl_session_timeout 5m;# 配置会话超时时间 </span><br><span class="line">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;# 为建立安全连接，服务器所允许的密码格式列表 </span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    ssl_prefer_server_ciphers on;# 依赖 SSLv3 和 TLSv1 协议的服务器密码将优先于客户端密码 </span><br><span class="line">    #减少点击劫持 </span><br><span class="line">    add_header X-Frame-Options DENY;</span><br><span class="line">    #禁止服务器自动解析资源类型 </span><br><span class="line">    add_header X-Content-Type-Options nosniff;</span><br><span class="line">    #防 XSS 攻击 </span><br><span class="line">    add_header X-Xss-Protection 1;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;# 监听端口 </span><br><span class="line">    server_name blog.playpi.org;# 域名 </span><br><span class="line">    access_log   /site/iplaypi.github.io.https-blog-access.log  main;</span><br><span class="line">    root         /site/iplaypi.github.io;</span><br><span class="line">    ssl_certificate /site/1883927_blog.playpi.org.pem;# 证书路径 </span><br><span class="line">    ssl_certificate_key /site/1883927_blog.playpi.org.key;#key 路径 </span><br><span class="line">    ssl_session_cache shared:SSL:1m;# 储存 SSL 会话的缓存类型和大小 </span><br><span class="line">    ssl_session_timeout 5m;# 配置会话超时时间 </span><br><span class="line">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;# 为建立安全连接，服务器所允许的密码格式列表 </span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    ssl_prefer_server_ciphers on;# 依赖 SSLv3 和 TLSv1 协议的服务器密码将优先于客户端密码 </span><br><span class="line">    #减少点击劫持 </span><br><span class="line">    add_header X-Frame-Options DENY;</span><br><span class="line">    #禁止服务器自动解析资源类型 </span><br><span class="line">    add_header X-Content-Type-Options nosniff;</span><br><span class="line">    #防 XSS 攻击 </span><br><span class="line">    add_header X-Xss-Protection 1;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p></p><p>配置完成后重启 Nginx（使用 nginx -s reload），去浏览器查看证书信息，看到有效期一年。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4tirwwkj20f00gdwfk.jpg" alt="去浏览器查看证书信息" title="去浏览器查看证书信息"></p><p>打开链接，看到左上角的小绿锁，好了，网站是经过验证的了。<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0r4tu5l57j21hl0rr0wt.jpg" alt="打开链接" title="打开链接"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;在搭建博客的过程中，一开始是全部使用 GitHub，因为这样做就什么也不用考虑了，例如主机、带宽、SSL 证书，全部都交给 GitHub 了，自己唯一需要做的就是写 Markdown 文档。但是，后来发现 GitHub 把百度爬虫给禁止了，也就是百度爬虫爬取不到 GitHub 的内容，导致我的站点没有被百度收录。后来为了专门给百度爬虫搭建一条线路，自己搭建了一个镜像服务，也就是和 GitHub 上面的内容一模一样站点，是专门给百度爬虫使用的。而且，为了测试方便，在 DNSPod 中还增加了一条 blog 二级域名的解析记录，blog 的访问全导向自己的镜像，这样就可以方便观察部署是否成功。后来还把百度爬虫的 www 访问通过 CNANE 跳转到 blog 去，这样就不用单独再搞一个 www 了，因为挺麻烦的（域名解析线路问题、测试问题、证书确认问题，都挺麻烦）。而在这个过程中，就产生了使用阿里云申请免费的 SSL 证书这一流程（有效期一年），记录下来给大家参考。&lt;/p&gt;
    
    </summary>
    
      <category term="建站" scheme="https://www.playpi.org/categories/building/"/>
    
    
      <category term="Nginx" scheme="https://www.playpi.org/tags/Nginx/"/>
    
      <category term="https" scheme="https://www.playpi.org/tags/https/"/>
    
      <category term="阿里云" scheme="https://www.playpi.org/tags/%E9%98%BF%E9%87%8C%E4%BA%91/"/>
    
      <category term="SSL证书" scheme="https://www.playpi.org/tags/SSL%E8%AF%81%E4%B9%A6/"/>
    
      <category term="Lets Encrypt" scheme="https://www.playpi.org/tags/Lets-Encrypt/"/>
    
  </entry>
  
  <entry>
    <title>那些年关于技术的未解之谜</title>
    <link href="https://www.playpi.org/2019030101.html"/>
    <id>https://www.playpi.org/2019030101.html</id>
    <published>2019-03-01T08:53:21.000Z</published>
    <updated>2019-03-01T08:53:21.000Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --><p>由于技术能力的限制，平时会遇到一些自己觉得非常诡异的问题，感觉到莫名其妙。其实到头来发现，归根结底还是自己的认知问题：可能是技术水平不够，或者考虑不周全，甚至是一些低级别的错误判断。总而言之，遇到这些问题后，有时候请教人、查资料之后仍旧不得解，只能先记录下来，留做备注说明，等待以后解决。当然，随着时间的流逝，有些问题可能就被忘记了，有些问题在之后的某一个时间点被解决了。本文就是要记录这些问题，并在遇到新问题或者解决老问题之后，保持更新。</p><a id="more"></a><h1 id="常用链接"><a href="# 常用链接" class="headerlink" title="常用链接"></a>常用链接 </h1><p> 在这里先列出一些常用的网站链接，方便查看：</p><ul><li>es-hadoop 官网：<a href="https://www.elastic.co/guide/en/elasticsearch/hadoop/5.6/configuration.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/hadoop/5.6/configuration.html</a> ；</li><li>x</li></ul><h1 id="es-spark- 读取 -es- 数据后 -count- 报错"><a href="#es-spark- 读取 -es- 数据后 -count- 报错" class="headerlink" title="es-spark 读取 es 数据后 count 报错"></a>es-spark 读取 es 数据后 count 报错 </h1><p> 使用 es-hadoop 组件，起 Spark 任务去查询 es 数据，然后过滤，过滤后做一个 count 算子，结果就报错了。而且，在报错后又重试了很多次（5 次以上），一直正常，没法重现问题。这个任务需要经常跑，以前从来没遇到过这样的异常，初步怀疑是 es 集群不稳定，具体原因不得而知。</p><p>错误截图：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g0pyfelevwj20vj0mr0w0.jpg" alt="报错信息截图" title="报错信息截图"></p><p>完整错误信息如下（重要包名称被替换）：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">02</span>-<span class="number">26_15</span>:<span class="number">01</span>:<span class="number">44</span> [main] ERROR spokesman3.SpokesAndBrand:<span class="number">510</span>: !!!!Spark 出错: org.codehaus.jackson.JsonParseException: Unexpected end-of-input in field name</span><br><span class="line"> at [Source: org.apache.commons.httpclient.AutoCloseInputStream@<span class="number">2687</span>cf14; line: <span class="number">1</span>, column: <span class="number">17581</span>]</span><br><span class="line">org.elasticsearch.hadoop.rest.EsHadoopParsingException: org.codehaus.jackson.JsonParseException: Unexpected end-of-input in field name</span><br><span class="line"> at [Source: org.apache.commons.httpclient.AutoCloseInputStream@<span class="number">2687</span>cf14; line: <span class="number">1</span>, column: <span class="number">17581</span>]</span><br><span class="line">at org.elasticsearch.hadoop.rest.RestClient.parseContent (RestClient.java:<span class="number">171</span>)</span><br><span class="line">at org.elasticsearch.hadoop.rest.RestClient.get (RestClient.java:<span class="number">155</span>)</span><br><span class="line">at org.elasticsearch.hadoop.rest.RestClient.targetShards (RestClient.java:<span class="number">357</span>)</span><br><span class="line">at org.elasticsearch.hadoop.rest.RestRepository.doGetReadTargetShards (RestRepository.java:<span class="number">306</span>)</span><br><span class="line">at org.elasticsearch.hadoop.rest.RestRepository.getReadTargetShards (RestRepository.java:<span class="number">297</span>)</span><br><span class="line">at org.elasticsearch.hadoop.rest.RestService.findPartitions (RestService.java:<span class="number">241</span>)</span><br><span class="line">at org.elasticsearch.spark.rdd.AbstractEsRDD.esPartitions$lzycompute (AbstractEsRDD.scala:<span class="number">73</span>)</span><br><span class="line">at org.elasticsearch.spark.rdd.AbstractEsRDD.esPartitions (AbstractEsRDD.scala:<span class="number">72</span>)</span><br><span class="line">at org.elasticsearch.spark.rdd.AbstractEsRDD.getPartitions (AbstractEsRDD.scala:<span class="number">44</span>)</span><br><span class="line">at org.apache.spark.rdd.RDD$$anonfun$partitions$<span class="number">2</span>.apply (RDD.scala:<span class="number">239</span>)</span><br><span class="line">at org.apache.spark.rdd.RDD$$anonfun$partitions$<span class="number">2</span>.apply (RDD.scala:<span class="number">237</span>)</span><br><span class="line">at scala.Option.getOrElse (Option.scala:<span class="number">120</span>)</span><br><span class="line">at org.apache.spark.rdd.RDD.partitions (RDD.scala:<span class="number">237</span>)</span><br><span class="line">at org.apache.spark.SparkContext.runJob (SparkContext.scala:<span class="number">1929</span>)</span><br><span class="line">at org.apache.spark.rdd.RDD.count (RDD.scala:<span class="number">1157</span>)</span><br><span class="line">at org.apache.spark.api.java.JavaRDDLike$class.count (JavaRDDLike.scala:440)</span><br><span class="line">at org.apache.spark.api.java.AbstractJavaRDDLike.count (JavaRDDLike.scala:<span class="number">46</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.SpokesAndBrand.getMention (SpokesAndBrand.java:<span class="number">508</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.SpokesAndBrand.runCelebrityByBrand (SpokesAndBrand.java:<span class="number">185</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.SpokesAndBrand.execute (SpokesAndBrand.java:<span class="number">116</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.SpokesmanAnalyzer.execute (SpokesmanAnalyzer.java:<span class="number">162</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.SpokesmanAnalyzeCli.execute (SpokesmanAnalyzeCli.java:<span class="number">154</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.SpokesmanAnalyzeCli.start (SpokesmanAnalyzeCli.java:<span class="number">75</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.util.AdvCli.initRunner (AdvCli.java:<span class="number">191</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.job.client.BasicInputOutputSystemWorker.run (BasicInputOutputSystemWorker.java:<span class="number">79</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.model.AbstractDataReportWorker.run (AbstractDataReportWorker.java:<span class="number">122</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.buffalo.job.AbstractBUTaskWorker.runTask (AbstractBUTaskWorker.java:<span class="number">63</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.report.cli.TaskLocalRunnerCli.start (TaskLocalRunnerCli.java:<span class="number">110</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.util.AdvCli.initRunner (AdvCli.java:<span class="number">191</span>)</span><br><span class="line">at com.<span class="keyword">package</span>.to.class.report.cli.TaskLocalRunnerCli.main (TaskLocalRunnerCli.java:<span class="number">43</span>)</span><br><span class="line">Caused by: org.codehaus.jackson.JsonParseException: Unexpected end-of-input in field name</span><br><span class="line"> at [Source: org.apache.commons.httpclient.AutoCloseInputStream@<span class="number">2687</span>cf14; line: <span class="number">1</span>, column: <span class="number">17581</span>]</span><br><span class="line">at org.codehaus.jackson.JsonParser._constructError (JsonParser.java:<span class="number">1433</span>)</span><br><span class="line">at org.codehaus.jackson.impl.JsonParserMinimalBase._reportError (JsonParserMinimalBase.java:<span class="number">521</span>)</span><br><span class="line">at org.codehaus.jackson.impl.JsonParserMinimalBase._reportInvalidEOF (JsonParserMinimalBase.java:<span class="number">454</span>)</span><br><span class="line">at org.codehaus.jackson.impl.Utf8StreamParser.parseEscapedFieldName (Utf8StreamParser.java:<span class="number">1503</span>)</span><br><span class="line">at org.codehaus.jackson.impl.Utf8StreamParser.slowParseFieldName (Utf8StreamParser.java:<span class="number">1404</span>)</span><br><span class="line">at org.codehaus.jackson.impl.Utf8StreamParser._parseFieldName (Utf8StreamParser.java:<span class="number">1231</span>)</span><br><span class="line">at org.codehaus.jackson.impl.Utf8StreamParser.nextToken (Utf8StreamParser.java:<span class="number">495</span>)</span><br><span class="line">at org.codehaus.jackson.map.deser.std.UntypedObjectDeserializer.mapObject (UntypedObjectDeserializer.java:<span class="number">219</span>)</span><br><span class="line">at org.codehaus.jackson.map.deser.std.UntypedObjectDeserializer.deserialize (UntypedObjectDeserializer.java:<span class="number">47</span>)</span><br><span class="line">at org.codehaus.jackson.map.deser.std.UntypedObjectDeserializer.mapArray (UntypedObjectDeserializer.java:<span class="number">165</span>)</span><br><span class="line">at org.codehaus.jackson.map.deser.std.UntypedObjectDeserializer.deserialize (UntypedObjectDeserializer.java:<span class="number">51</span>)</span><br><span class="line">at org.codehaus.jackson.map.deser.std.UntypedObjectDeserializer.mapArray (UntypedObjectDeserializer.java:<span class="number">165</span>)</span><br><span class="line">at org.codehaus.jackson.map.deser.std.UntypedObjectDeserializer.deserialize (UntypedObjectDeserializer.java:<span class="number">51</span>)</span><br><span class="line">at org.codehaus.jackson.map.deser.std.MapDeserializer._readAndBind (MapDeserializer.java:<span class="number">319</span>)</span><br><span class="line">at org.codehaus.jackson.map.deser.std.MapDeserializer.deserialize (MapDeserializer.java:<span class="number">249</span>)</span><br><span class="line">at org.codehaus.jackson.map.deser.std.MapDeserializer.deserialize (MapDeserializer.java:<span class="number">33</span>)</span><br><span class="line">at org.codehaus.jackson.map.ObjectMapper._readValue (ObjectMapper.java:<span class="number">2704</span>)</span><br><span class="line">at org.codehaus.jackson.map.ObjectMapper.readValue (ObjectMapper.java:<span class="number">1286</span>)</span><br><span class="line">at org.elasticsearch.hadoop.rest.RestClient.parseContent (RestClient.java:<span class="number">166</span>)</span><br><span class="line">... <span class="number">29</span> more</span><br><span class="line"><span class="number">2019</span>-<span class="number">02</span>-<span class="number">26_15</span>:<span class="number">01</span>:<span class="number">44</span> [main] INFO rdd.JavaEsRDD:<span class="number">58</span>: Removing RDD <span class="number">3086</span> from persistence list</span><br></pre></td></tr></table></figure><p></p><h1 id="Hexo- 生成 -html- 静态页面目录锚点失效"><a href="#Hexo- 生成 -html- 静态页面目录锚点失效" class="headerlink" title="Hexo 生成 html 静态页面目录锚点失效"></a>Hexo 生成 html 静态页面目录锚点失效 </h1><p> 我这些所有的博客文档是先写成 Markdown 文件，然后使用 Hexo 渲染生成 html 静态页面，再发布到 GitHub Pages 上面，还有一些是发布到我自己的 VPS 上面（为了百度爬虫）。</p><p>但是最近我发现一个现象，有一些文章的锚点无效，也就是表现为目录无法跳转，例如想直接查看某一级目录的内容，在右侧的 <strong>文章目录 </strong>中直接点击对应的标题，不会自动跳转过去。这个问题我发现了很久，但是一直没在意，也没有找到原因。最近才碰巧发现是因为标题内容里面有空格，这才导致生成的 html 静态页面里面的锚点失效，我随机又测试了几次其它的页面，看起来的确是这样。下面列出一些示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://www.playpi.org/2019022501.html ，Hexo 踩坑记录的 </span><br><span class="line">https://www.playpi.org/2018121901.html ，js 字符串分割方法 </span><br><span class="line">https://www.playpi.org/2019020701.html ，itchat 0 - 初识 </span><br></pre></td></tr></table></figure><p>但是，我又发现其他人的博客，目录标题内容中也有空格，却可以正常跳转，我很疑惑。现在我猜测是 Hexo 的问题，或者哪里需要配置，等待以后的解决方法吧。别人的博客示例：<a href="https://blog.itnote.me/Hexo/hexo-chinese-english-space/" target="_blank" rel="noopener">https://blog.itnote.me/Hexo/hexo-chinese-english-space/</a> 。</p><h1 id="邮件依赖的诡异异常"><a href="# 邮件依赖的诡异异常" class="headerlink" title="邮件依赖的诡异异常"></a>邮件依赖的诡异异常 </h1><p> 在项目中新引入了邮件相关的依赖【没有其它任何变化】，这样就可以在需要时发送通知邮件，依赖内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 邮件相关依赖 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-email&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.3.3&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>然后神奇的事情发生了，实际执行时，程序抛出异常【去掉这个依赖则正常】：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.StackOverflowError</span><br><span class="line">at sun.nio.cs.UTF_8$Encoder.encodeLoop (UTF_8.java:619)</span><br><span class="line">at java.nio.charset.CharsetEncoder.encode (CharsetEncoder.java:561)</span><br><span class="line">at sun.nio.cs.StreamEncoder.implWrite (StreamEncoder.java:271)</span><br><span class="line">at sun.nio.cs.StreamEncoder.write (StreamEncoder.java:125)</span><br><span class="line">at java.io.OutputStreamWriter.write (OutputStreamWriter.java:207)</span><br><span class="line">at java.io.BufferedWriter.flushBuffer (BufferedWriter.java:129)</span><br><span class="line">at java.io.PrintStream.write (PrintStream.java:526)</span><br><span class="line">at java.io.PrintStream.print (PrintStream.java:669)</span><br><span class="line">at java.io.PrintStream.println (PrintStream.java:806)</span><br><span class="line">at org.slf4j.impl.SimpleLogger.write (SimpleLogger.java:381)</span><br><span class="line">at org.slf4j.impl.SimpleLogger.log (SimpleLogger.java:376)</span><br><span class="line">at org.slf4j.impl.SimpleLogger.info (SimpleLogger.java:538)</span><br><span class="line">at org.apache.maven.cli.logging.Slf4jLogger.info (Slf4jLogger.java:59)</span><br><span class="line">at org.codehaus.plexus.archiver.AbstractArchiver$1.hasNext (AbstractArchiver.java:464)</span><br><span class="line">at org.codehaus.plexus.archiver.AbstractArchiver$1.hasNext (AbstractArchiver.java:467)</span><br><span class="line">at org.codehaus.plexus.archiver.AbstractArchiver$1.hasNext (AbstractArchiver.java:467)</span><br><span class="line">at org.codehaus.plexus.archiver.AbstractArchiver$1.hasNext (AbstractArchiver.java:467)</span><br></pre></td></tr></table></figure><p>而根据这个异常信息，我搜索不到任何有效的信息，一直无法解决。最后，我对比了其它项目的配置，发现 手动设置 maven-assembly-plugin 插件的版本为 <version>2.6</version> 即可。而之前是没有设置这个版本号的，默认去仓库获取的最新版本，这个默认的版本可能刚好有问题。</p><h1 id="Python- 入门踩坑"><a href="#Python- 入门踩坑" class="headerlink" title="Python 入门踩坑"></a>Python 入门踩坑 </h1><p> 在一开始使用 Python 的时候，没有使用类似 Anaconda、Winpython 这种套件来帮我自动管理 Python 的第三方工具库，而是从 Python 安装开始，用到什么再用 pip 安装什么。整个过程真的可以把人搞崩溃，工具库之间的传递依赖、版本的不兼容等问题，令人望而却步，下面给出一些难忘的经历。</p><p>出现错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Install packages failed: Installing packages: error occurred</span><br><span class="line">numpy.distutils.system_info.NotFoundError: no lapack/blas resources found</span><br></pre></td></tr></table></figure><p>需要先手动安装 numpy+mkl，再手动安装 scipy，下载文件链接：<a href="http://www.lfd.uci.edu/~gohlke/pythonlibs" target="_blank" rel="noopener">http://www.lfd.uci.edu/~gohlke/pythonlibs</a> 。我下载了 2 个文件：numpy-1.11.3+mkl-cp27-cp27m-win32.whl、scipy-0.19.0-cp27-cp27m-win32.whl，然后手动安装。</p><p>一开始我下载的是 64 位的安装包，结果发现我的 Windows 安装的 Python 是 32 位的，导致不支持【下载时没有选择位数，直接下载的默认的包】。另外，直接进入 Python 的命令行环境时也会打印出版本信息的。使用 import pip; print (pip.pep425tags.get_supported ()); 可以获取到 pip 支持的文件名和版本。</p><p>注意安装 scipy 之前还需要各种第三方库，官方介绍：<strong>Install numpy+mkl before installing scipy.</strong>。在 Shell 中验证安装第三方库是否成功，例如 numpy：from numpy import *。</p><p>scipy 包安装：pip install scipy==0.16.1【不推荐】，成功完成安装，如果缺少第三方包会报很多错误。网上查询后的总结：安装 numpy 后安装 scipy 失败，报错：<strong>numpy.distutils.system_info.NotFoundError</strong>，一般是缺少一些系统库，需要安装：libopenblas-dev、liblapack-dev、libatlas-dev、libblas-dev。</p><p>常见第三方库介绍：</p><ul><li>pandas，分析数据 </li><li>sklearn，机器学习，各种算法</li><li>jieba，分词工具</li><li>gensim nlp word2v，模块训练词向量模型</li><li>scipy，算法库，数学工具包</li><li>numpy，数据分析</li><li>matlptop，图形可视化</li></ul><p>Python 中的编码：<br>2.X 版本，python 编码过程： 输入 –&gt; str –&gt; decode –&gt; unicode –&gt; encode –&gt; str –&gt; 输出。<br>3.X 版本，不一样，直接是 unicode。</p><p>Python 中代码有 <strong>print u’xx’ + yy</strong>，yy 是中文，直接跑的时候打印到 Shell 不报错，但是使用后台挂起跑的时候，重定向到文件时，会报错，因为 Python 获取不到输出流的编码。</p><h1 id="Spark-UI- 无法显示"><a href="#Spark-UI- 无法显示" class="headerlink" title="Spark UI 无法显示"></a>Spark UI 无法显示</h1><p> 使用 yarn-client 模式起了一个 Spark 任务，在 Driver 端看到异常日志：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">2019-01-16_14:53:31 [qtp192486017-1829 - /static/timeline-view.js] WARN servlet.DefaultServlet:587: EXCEPTION </span><br><span class="line">java.lang.IllegalArgumentException: MALFORMED</span><br><span class="line">at java.util.zip.ZipCoder.toString (ZipCoder.java:58)</span><br><span class="line">at java.util.zip.ZipFile.getZipEntry (ZipFile.java:583)</span><br><span class="line">at java.util.zip.ZipFile.access$900 (ZipFile.java:60)</span><br><span class="line">at java.util.zip.ZipFile$ZipEntryIterator.next (ZipFile.java:539)</span><br><span class="line">at java.util.zip.ZipFile$ZipEntryIterator.nextElement (ZipFile.java:514)</span><br><span class="line">at java.util.zip.ZipFile$ZipEntryIterator.nextElement (ZipFile.java:495)</span><br><span class="line">at java.util.jar.JarFile$JarEntryIterator.next (JarFile.java:257)</span><br><span class="line">at java.util.jar.JarFile$JarEntryIterator.nextElement (JarFile.java:266)</span><br><span class="line">at java.util.jar.JarFile$JarEntryIterator.nextElement (JarFile.java:247)</span><br><span class="line">at org.spark-project.jetty.util.resource.JarFileResource.exists (JarFileResource.java:189)</span><br><span class="line">at org.spark-project.jetty.servlet.DefaultServlet.getResource (DefaultServlet.java:398)</span><br><span class="line">at org.spark-project.jetty.servlet.DefaultServlet.doGet (DefaultServlet.java:476)</span><br><span class="line">at javax.servlet.http.HttpServlet.service (HttpServlet.java:707)</span><br><span class="line">at javax.servlet.http.HttpServlet.service (HttpServlet.java:820)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHolder.handle (ServletHolder.java:684)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler$CachedChain.doFilter (ServletHandler.java:1507)</span><br><span class="line">at org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter.doFilter (AmIpFilter.java:164)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler$CachedChain.doFilter (ServletHandler.java:1478)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doHandle (ServletHandler.java:499)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doHandle (ContextHandler.java:1086)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doScope (ServletHandler.java:427)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doScope (ContextHandler.java:1020)</span><br><span class="line">at org.spark-project.jetty.server.handler.ScopedHandler.handle (ScopedHandler.java:135)</span><br><span class="line">at org.spark-project.jetty.server.handler.GzipHandler.handle (GzipHandler.java:264)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandlerCollection.handle (ContextHandlerCollection.java:255)</span><br><span class="line">at org.spark-project.jetty.server.handler.HandlerWrapper.handle (HandlerWrapper.java:116)</span><br><span class="line">at org.spark-project.jetty.server.Server.handle (Server.java:366)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.handleRequest (AbstractHttpConnection.java:494)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.headerComplete (AbstractHttpConnection.java:973)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete (AbstractHttpConnection.java:1035)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseNext (HttpParser.java:641)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseAvailable (HttpParser.java:231)</span><br><span class="line">at org.spark-project.jetty.server.AsyncHttpConnection.handle (AsyncHttpConnection.java:82)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint.handle (SelectChannelEndPoint.java:696)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint$1.run (SelectChannelEndPoint.java:53)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool.runJob (QueuedThreadPool.java:608)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool$3.run (QueuedThreadPool.java:543)</span><br><span class="line">at java.lang.Thread.run (Thread.java:748)</span><br><span class="line">2019-01-16_14:53:31 [qtp192486017-1829 - /static/timeline-view.js] WARN servlet.ServletHandler:592: Error for /static/timeline-view.js</span><br><span class="line">java.lang.NoClassDefFoundError: org/spark-project/jetty/server/handler/ErrorHandler$ErrorPageMapper</span><br><span class="line">at org.spark-project.jetty.server.handler.ErrorHandler.handle (ErrorHandler.java:71)</span><br><span class="line">at org.spark-project.jetty.server.Response.sendError (Response.java:349)</span><br><span class="line">at javax.servlet.http.HttpServletResponseWrapper.sendError (HttpServletResponseWrapper.java:118)</span><br><span class="line">at org.spark-project.jetty.http.gzip.CompressedResponseWrapper.sendError (CompressedResponseWrapper.java:291)</span><br><span class="line">at org.spark-project.jetty.servlet.DefaultServlet.doGet (DefaultServlet.java:589)</span><br><span class="line">at javax.servlet.http.HttpServlet.service (HttpServlet.java:707)</span><br><span class="line">at javax.servlet.http.HttpServlet.service (HttpServlet.java:820)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHolder.handle (ServletHolder.java:684)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler$CachedChain.doFilter (ServletHandler.java:1507)</span><br><span class="line">at org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter.doFilter (AmIpFilter.java:164)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler$CachedChain.doFilter (ServletHandler.java:1478)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doHandle (ServletHandler.java:499)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doHandle (ContextHandler.java:1086)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doScope (ServletHandler.java:427)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doScope (ContextHandler.java:1020)</span><br><span class="line">at org.spark-project.jetty.server.handler.ScopedHandler.handle (ScopedHandler.java:135)</span><br><span class="line">at org.spark-project.jetty.server.handler.GzipHandler.handle (GzipHandler.java:264)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandlerCollection.handle (ContextHandlerCollection.java:255)</span><br><span class="line">at org.spark-project.jetty.server.handler.HandlerWrapper.handle (HandlerWrapper.java:116)</span><br><span class="line">at org.spark-project.jetty.server.Server.handle (Server.java:366)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.handleRequest (AbstractHttpConnection.java:494)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.headerComplete (AbstractHttpConnection.java:973)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete (AbstractHttpConnection.java:1035)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseNext (HttpParser.java:641)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseAvailable (HttpParser.java:231)</span><br><span class="line">at org.spark-project.jetty.server.AsyncHttpConnection.handle (AsyncHttpConnection.java:82)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint.handle (SelectChannelEndPoint.java:696)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint$1.run (SelectChannelEndPoint.java:53)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool.runJob (QueuedThreadPool.java:608)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool$3.run (QueuedThreadPool.java:543)</span><br><span class="line">at java.lang.Thread.run (Thread.java:748)</span><br><span class="line">2019-01-16_14:53:31 [qtp192486017-1829 - /static/timeline-view.js] WARN server.AbstractHttpConnection:552: /static/timeline-view.js</span><br><span class="line">java.lang.NoSuchMethodError: javax.servlet.http.HttpServletRequest.isAsyncStarted () Z</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doHandle (ServletHandler.java:608)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doHandle (ContextHandler.java:1086)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doScope (ServletHandler.java:427)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doScope (ContextHandler.java:1020)</span><br><span class="line">at org.spark-project.jetty.server.handler.ScopedHandler.handle (ScopedHandler.java:135)</span><br><span class="line">at org.spark-project.jetty.server.handler.GzipHandler.handle (GzipHandler.java:264)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandlerCollection.handle (ContextHandlerCollection.java:255)</span><br><span class="line">at org.spark-project.jetty.server.handler.HandlerWrapper.handle (HandlerWrapper.java:116)</span><br><span class="line">at org.spark-project.jetty.server.Server.handle (Server.java:366)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.handleRequest (AbstractHttpConnection.java:494)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.headerComplete (AbstractHttpConnection.java:973)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete (AbstractHttpConnection.java:1035)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseNext (HttpParser.java:641)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseAvailable (HttpParser.java:231)</span><br><span class="line">at org.spark-project.jetty.server.AsyncHttpConnection.handle (AsyncHttpConnection.java:82)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint.handle (SelectChannelEndPoint.java:696)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint$1.run (SelectChannelEndPoint.java:53)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool.runJob (QueuedThreadPool.java:608)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool$3.run (QueuedThreadPool.java:543)</span><br><span class="line">at java.lang.Thread.run (Thread.java:748)</span><br></pre></td></tr></table></figure><p>这个日志在反复打印，也就是在任务的运行过程中，一直都有这个错误。它引发了什么问题呢，我检查了一下，对 Spark 任务的实际功能并没有影响，任务跑完后功能正常实现。但是，我发现在任务的运行过程中，Spark UI 页面打开后不正常显示【异常信息的开头就是关于某个 js 文件问题】：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g12h3dbte0j20tr0ge3yv.jpg" alt="SparkUI 不正常显示" title="SparkUI 不正常显示"></p><p>点击进去，直接显示 Error 500：<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g12h42u9iuj20t50fa74n.jpg" alt="点击进去" title="点击进去"><br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g12h48uvu5j20mj08imwz.jpg" alt="Error500" title="Error500"></p><p>服务器的 Driver 端日志截图：<br>日志截图 1<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g12h4vfjokj20wu0mgwgs.jpg" alt="日志截图 1" title="日志截图 1"></p><p>日志截图 2<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g12h4zran1j20ya0mgwgy.jpg" alt="日志截图 2" title="日志截图 2"></p><p>日志截图 3<br><img src="https://ws1.sinaimg.cn/large/b7f2e3a3gy1g12h53va2qj20xs0mgacl.jpg" alt="日志截图 3" title="日志截图 3"></p><p>等了几天，又遇到同样的问题，除了这 2 次，其它时间点就没遇到过了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">2019-01-24_22:51:49 [qtp697001207-1591 - /static/spark-dag-viz.js] WARN servlet.DefaultServlet:587: EXCEPTION </span><br><span class="line">java.lang.IllegalArgumentException: MALFORMED</span><br><span class="line">at java.util.zip.ZipCoder.toString (ZipCoder.java:58)</span><br><span class="line">at java.util.zip.ZipFile.getZipEntry (ZipFile.java:583)</span><br><span class="line">at java.util.zip.ZipFile.access$900 (ZipFile.java:60)</span><br><span class="line">at java.util.zip.ZipFile$ZipEntryIterator.next (ZipFile.java:539)</span><br><span class="line">at java.util.zip.ZipFile$ZipEntryIterator.nextElement (ZipFile.java:514)</span><br><span class="line">at java.util.zip.ZipFile$ZipEntryIterator.nextElement (ZipFile.java:495)</span><br><span class="line">at java.util.jar.JarFile$JarEntryIterator.next (JarFile.java:257)</span><br><span class="line">at java.util.jar.JarFile$JarEntryIterator.nextElement (JarFile.java:266)</span><br><span class="line">at java.util.jar.JarFile$JarEntryIterator.nextElement (JarFile.java:247)</span><br><span class="line">at org.spark-project.jetty.util.resource.JarFileResource.exists (JarFileResource.java:189)</span><br><span class="line">at org.spark-project.jetty.servlet.DefaultServlet.getResource (DefaultServlet.java:398)</span><br><span class="line">at org.spark-project.jetty.servlet.DefaultServlet.doGet (DefaultServlet.java:476)</span><br><span class="line">at javax.servlet.http.HttpServlet.service (HttpServlet.java:707)</span><br><span class="line">at javax.servlet.http.HttpServlet.service (HttpServlet.java:820)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHolder.handle (ServletHolder.java:684)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler$CachedChain.doFilter (ServletHandler.java:1507)</span><br><span class="line">at org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter.doFilter (AmIpFilter.java:164)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler$CachedChain.doFilter (ServletHandler.java:1478)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doHandle (ServletHandler.java:499)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doHandle (ContextHandler.java:1086)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doScope (ServletHandler.java:427)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doScope (ContextHandler.java:1020)</span><br><span class="line">at org.spark-project.jetty.server.handler.ScopedHandler.handle (ScopedHandler.java:135)</span><br><span class="line">at org.spark-project.jetty.server.handler.GzipHandler.handle (GzipHandler.java:264)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandlerCollection.handle (ContextHandlerCollection.java:255)</span><br><span class="line">at org.spark-project.jetty.server.handler.HandlerWrapper.handle (HandlerWrapper.java:116)</span><br><span class="line">at org.spark-project.jetty.server.Server.handle (Server.java:366)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.handleRequest (AbstractHttpConnection.java:494)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.headerComplete (AbstractHttpConnection.java:973)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete (AbstractHttpConnection.java:1035)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseNext (HttpParser.java:641)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseAvailable (HttpParser.java:231)</span><br><span class="line">at org.spark-project.jetty.server.AsyncHttpConnection.handle (AsyncHttpConnection.java:82)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint.handle (SelectChannelEndPoint.java:696)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint$1.run (SelectChannelEndPoint.java:53)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool.runJob (QueuedThreadPool.java:608)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool$3.run (QueuedThreadPool.java:543)</span><br><span class="line">at java.lang.Thread.run (Thread.java:748)</span><br><span class="line">2019-01-24_22:51:49 [qtp697001207-1591 - /static/spark-dag-viz.js] WARN servlet.ServletHandler:592: Error for /static/spark-dag-viz.js</span><br><span class="line">java.lang.NoClassDefFoundError: org/spark-project/jetty/server/handler/ErrorHandler$ErrorPageMapper</span><br><span class="line">at org.spark-project.jetty.server.handler.ErrorHandler.handle (ErrorHandler.java:71)</span><br><span class="line">at org.spark-project.jetty.server.Response.sendError (Response.java:349)</span><br><span class="line">at javax.servlet.http.HttpServletResponseWrapper.sendError (HttpServletResponseWrapper.java:118)</span><br><span class="line">at org.spark-project.jetty.http.gzip.CompressedResponseWrapper.sendError (CompressedResponseWrapper.java:291)</span><br><span class="line">at org.spark-project.jetty.servlet.DefaultServlet.doGet (DefaultServlet.java:589)</span><br><span class="line">at javax.servlet.http.HttpServlet.service (HttpServlet.java:707)</span><br><span class="line">at javax.servlet.http.HttpServlet.service (HttpServlet.java:820)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHolder.handle (ServletHolder.java:684)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler$CachedChain.doFilter (ServletHandler.java:1507)</span><br><span class="line">at org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter.doFilter (AmIpFilter.java:164)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler$CachedChain.doFilter (ServletHandler.java:1478)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doHandle (ServletHandler.java:499)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doHandle (ContextHandler.java:1086)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doScope (ServletHandler.java:427)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doScope (ContextHandler.java:1020)</span><br><span class="line">at org.spark-project.jetty.server.handler.ScopedHandler.handle (ScopedHandler.java:135)</span><br><span class="line">at org.spark-project.jetty.server.handler.GzipHandler.handle (GzipHandler.java:264)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandlerCollection.handle (ContextHandlerCollection.java:255)</span><br><span class="line">at org.spark-project.jetty.server.handler.HandlerWrapper.handle (HandlerWrapper.java:116)</span><br><span class="line">at org.spark-project.jetty.server.Server.handle (Server.java:366)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.handleRequest (AbstractHttpConnection.java:494)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.headerComplete (AbstractHttpConnection.java:973)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete (AbstractHttpConnection.java:1035)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseNext (HttpParser.java:641)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseAvailable (HttpParser.java:231)</span><br><span class="line">at org.spark-project.jetty.server.AsyncHttpConnection.handle (AsyncHttpConnection.java:82)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint.handle (SelectChannelEndPoint.java:696)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint$1.run (SelectChannelEndPoint.java:53)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool.runJob (QueuedThreadPool.java:608)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool$3.run (QueuedThreadPool.java:543)</span><br><span class="line">at java.lang.Thread.run (Thread.java:748)</span><br><span class="line">2019-01-24_22:51:49 [qtp697001207-1591 - /static/spark-dag-viz.js] WARN server.AbstractHttpConnection:552: /static/spark-dag-viz.js</span><br><span class="line">java.lang.NoSuchMethodError: javax.servlet.http.HttpServletRequest.isAsyncStarted () Z</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doHandle (ServletHandler.java:608)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doHandle (ContextHandler.java:1086)</span><br><span class="line">at org.spark-project.jetty.servlet.ServletHandler.doScope (ServletHandler.java:427)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandler.doScope (ContextHandler.java:1020)</span><br><span class="line">at org.spark-project.jetty.server.handler.ScopedHandler.handle (ScopedHandler.java:135)</span><br><span class="line">at org.spark-project.jetty.server.handler.GzipHandler.handle (GzipHandler.java:264)</span><br><span class="line">at org.spark-project.jetty.server.handler.ContextHandlerCollection.handle (ContextHandlerCollection.java:255)</span><br><span class="line">at org.spark-project.jetty.server.handler.HandlerWrapper.handle (HandlerWrapper.java:116)</span><br><span class="line">at org.spark-project.jetty.server.Server.handle (Server.java:366)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.handleRequest (AbstractHttpConnection.java:494)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection.headerComplete (AbstractHttpConnection.java:973)</span><br><span class="line">at org.spark-project.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete (AbstractHttpConnection.java:1035)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseNext (HttpParser.java:641)</span><br><span class="line">at org.spark-project.jetty.http.HttpParser.parseAvailable (HttpParser.java:231)</span><br><span class="line">at org.spark-project.jetty.server.AsyncHttpConnection.handle (AsyncHttpConnection.java:82)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint.handle (SelectChannelEndPoint.java:696)</span><br><span class="line">at org.spark-project.jetty.io.nio.SelectChannelEndPoint$1.run (SelectChannelEndPoint.java:53)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool.runJob (QueuedThreadPool.java:608)</span><br><span class="line">at org.spark-project.jetty.util.thread.QueuedThreadPool$3.run (QueuedThreadPool.java:543)</span><br><span class="line">at java.lang.Thread.run (Thread.java:748)</span><br></pre></td></tr></table></figure><p>此外，还有一点值得注意，Chrome 浏览器的某些端口是禁止访问的，所以遇到过有一个 Spark 任务使用了 4045 端口【locked】，在 Chrome 浏览器是看不了任务状态的，页面无法打开，被 Chrome 浏览器屏蔽了，此时并不是 Spark 的问题。</p><h1 id="关于 -Git- 的小问题"><a href="# 关于 -Git- 的小问题" class="headerlink" title="关于 Git 的小问题"></a>关于 Git 的小问题 </h1><p>1、本地版本落后，而且又与远程仓库冲突，git pull 报错警告，需要 merge，无法直接更新最新版本。下面的操作直接覆盖本地文件，强制更新到最新版本，本地未提交的更改会丢失。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git fetch --all</span><br><span class="line">git reset --hard origin/master</span><br></pre></td></tr></table></figure><p>2、在 2018 年 9 月的某一天，发现 Git 的代码推送总是需要输入帐号和密码，哪怕保存下来也不行，每次 push 都需要重新输入，感觉很奇怪。后来发现是版本太旧了，当时的版本是 v2.13.0，升级后的版本是 v2.18.0，升级后就恢复正常了。后来无意间在哪里看到过通知，说是 TSL 协议升级了，所以针对旧版本强制输入用户名密码，升级就可以解决。</p><p> 备注一下，HTTPS 是在 TCP 和 HTTP 之间增加了 TLS【Transport Layer Security，传输层安全】，提供了内容加密、身份认证和数据完整性三大功能。TLS 的前身是 SSL【Secure Sockets Layer，安全套接字层】，由网景公司开发，后来被 IETF 标准化并改名。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Thu Apr 25 2019 23:15:06 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;由于技术能力的限制，平时会遇到一些自己觉得非常诡异的问题，感觉到莫名其妙。其实到头来发现，归根结底还是自己的认知问题：可能是技术水平不够，或者考虑不周全，甚至是一些低级别的错误判断。总而言之，遇到这些问题后，有时候请教人、查资料之后仍旧不得解，只能先记录下来，留做备注说明，等待以后解决。当然，随着时间的流逝，有些问题可能就被忘记了，有些问题在之后的某一个时间点被解决了。本文就是要记录这些问题，并在遇到新问题或者解决老问题之后，保持更新。&lt;/p&gt;
    
    </summary>
    
      <category term="基础技术知识" scheme="https://www.playpi.org/categories/basic-technical-knowledge/"/>
    
    
      <category term="Spark" scheme="https://www.playpi.org/tags/Spark/"/>
    
      <category term="Git" scheme="https://www.playpi.org/tags/Git/"/>
    
      <category term="ElasticSearch" scheme="https://www.playpi.org/tags/ElasticSearch/"/>
    
      <category term="es" scheme="https://www.playpi.org/tags/es/"/>
    
      <category term="Python" scheme="https://www.playpi.org/tags/Python/"/>
    
  </entry>
  
</feed>
